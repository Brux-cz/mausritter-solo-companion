<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mausritter Solo Companion</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script>tailwind = { config: {} }</script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>tailwind.config = { corePlugins: { preflight: true } }</script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
    .hide-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>var exports = {}; var module = { exports: exports };</script>
  <script type="text/babel" data-presets="react">
const { useState, useEffect, useCallback, useRef } = React;

// ============================================
// MAUSRITTER SOLO COMPANION APP
// A comprehensive tool for solo Mausritter play
// ============================================

// --- GOOGLE DRIVE SYNC CONFIG ---
const GOOGLE_CLIENT_ID = '948855876248-acfbvk4k4ud5fmciocfk5o8qldfcdi29.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'AIzaSyDorqiiGhrfkdg_fO6dqjjHsnpeioNSL-s';
const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';

// --- DATA CONSTANTS ---

const ORACLE_TABLE = {
  unlikely: { 2: 'No', 3: 'No', 4: 'No, but...', 5: 'No, but...', 6: 'No, but...', 7: 'Yes', 8: 'Yes', 9: 'Yes', 10: 'Yes, and...', 11: 'Yes, and...', 12: 'Yes, and...' },
  even: { 2: 'No', 3: 'No', 4: 'No', 5: 'No, but...', 6: 'Yes', 7: 'Yes', 8: 'Yes', 9: 'Yes, and...', 10: 'Yes, and...', 11: 'Yes, and...', 12: 'Yes, and...' },
  likely: { 2: 'No, but...', 3: 'No, but...', 4: 'Yes', 5: 'Yes', 6: 'Yes', 7: 'Yes', 8: 'Yes', 9: 'Yes, and...', 10: 'Yes, and...', 11: 'Yes, and...', 12: 'Yes, and...' }
};

const SCENE_COMPLICATIONS = [
  'Nep≈ô√°telsk√© s√≠ly se stav√≠ do cesty',
  'P≈ôek√°≈æka blokuje postup',
  '"Nebylo by otravn√©, kdyby..." (vymysli komplikaci)',
  'NPC n√°hle jedn√° (hoƒè na Adventure Seeds)',
  'Objev√≠ se neƒçekan√° p≈ô√≠le≈æitost',
  'Vƒõci jdou podle pl√°nu (≈æ√°dn√° komplikace)'
];

const FAILURE_CONSEQUENCES = [
  'Zp≈Øsob po≈°kozen√≠',
  'Dej nƒõkoho do √∫zk√Ωch',
  'Nab√≠dni tƒõ≈ækou volbu',
  'Pou≈æij nep≈ô√≠tel≈Øv tah',
  'Odhal nep≈ô√≠jemnou pravdu',
  'Oddƒõl skupinu'
];

const ACTION_ORACLE = [
  'Opustit', 'Z√≠skat', 'Postoupit', 'Ovlivnit', 'Pomoci', 'P≈ôij√≠t', '√ötoƒçit', 'Pomst√≠t', 'Zaƒç√≠t', 'Zradit',
  'Blokovat', 'Pos√≠lit', 'Prolomit', 'Zlomit', 'Zajmout', 'Vyzvat', 'Zmƒõnit', 'Za√∫toƒçit', 'St≈ôetnout se', 'Velet',
  'Komunikovat', 'Soutƒõ≈æit', 'Ukr√Ωt', 'Konfrontovat', 'Spojit', 'Ovl√°dnout', 'Zkazit', 'Vytvo≈ôit', 'Oklamat', 'Br√°nit',
  'Odrazit', 'Zdr≈æet', 'Doruƒçit', 'Po≈æadovat', 'Odej√≠t', 'Zniƒçit', 'Objevit', 'Zpochybnit', 'Rozpt√Ωlit', 'Rozdƒõlit',
  'Upustit', 'Eskalovat', 'Uniknout', 'Vyhnout se', 'Prozkoumat', 'Vyƒçerpat', 'Prozkoum√°vat', 'Odhalit', 'Padnout', 'Naj√≠t',
  'Dokonƒçit', 'Soust≈ôedit', 'N√°sledovat', 'Opevnit', 'Shrom√°≈ædit', 'Hl√≠dat', 'V√©st', 'Ubl√≠≈æit', 'L√©ƒçit', 'Schovat se',
  'Dr≈æet', 'Lovit', 'Zap≈Øsobit', 'Infiltrovat', 'Informovat', 'Zah√°jit', 'Kontrolovat', 'Vy≈°et≈ôovat', 'Cestovat', 'Uƒçit se',
  'Opustit', 'Lokalizovat', 'Ztratit', 'Vyrobit', 'Manipulovat', 'Pohybovat', 'Otev≈ô√≠t', 'Postavit se', 'P≈ôemoci', 'Vytrvat',
  'Zachovat', 'Chr√°nit', 'Pron√°sledovat', 'P≈ôepadnout', 'Sn√≠≈æit', 'Odm√≠tnout', 'Zavrhnout', 'Osvobodit', 'Odstranit', 'Odolat',
  'Obnovit', 'Prozradit', 'Riskovat', 'Pl√°novat', 'Hledat', 'Zabezpeƒçit', 'P√°trat', 'Slou≈æit', 'Sd√≠let', 'Zes√≠lit'
];

const THEME_ORACLE = [
  'Schopnost', 'V√Ωhoda', 'Spojenec', 'Rovnov√°ha', 'P≈ôek√°≈æka', 'Bitva', 'Bestie', 'Krev', 'Pouto', 'B≈ôemeno',
  'Obchod', 'Komunita', 'Zk√°za', 'Odvaha', 'Tvorba', 'Nebezpeƒç√≠', 'Smrt', 'Dluh', '√öpadek', 'Podvod',
  'Obrana', 'Osud', 'Objev', 'Nemoc', 'Sen', 'Povinnost', 'Nep≈ô√≠tel', '√ötƒõk', 'Frakce', 'Sl√°va',
  'Rodina', 'Strach', 'P≈ô√°telstv√≠', '≈†tƒõst√≠', 'Svoboda', 'Chamtivost', 'Vina', 'Zdrav√≠', 'Historie', 'Domov',
  'ƒåest', 'Nadƒõje', 'N√°pad', 'Nevinnost', 'Instinkt', 'Cesta', 'Radost', 'Spravedlnost', 'Znalost', 'Pr√°ce',
  'Jazyk', 'Z√°kon', 'V≈Ødcovstv√≠', 'Odkaz', '≈Ωivot', 'L√°ska', 'Vƒõrnost', 'Magie', 'Vzpom√≠nka', 'Posel',
  'Ne≈°tƒõst√≠', 'Z√°hada', 'P≈ô√≠roda', 'P≈ô√≠le≈æitost', '≈ò√°d', 'Stezka', 'M√≠r', 'Riziko', 'Port√°l', 'Majetek',
  'Moc', 'P√Ωcha', 'Cena', 'Slib', 'Ochrana', 'V√Ωprava', 'Zu≈ôivost', 'Realita', '√ötoƒçi≈°tƒõ', 'V√≠ra',
  'Povƒõst', 'Zdroj', 'Pomsta', 'Rival', 'Zvƒõst', 'Bezpeƒç√≠', 'Tajemstv√≠', 'Duch', 'Cizinec', 'Povƒõra',
  'Z√°soby', 'P≈ôe≈æit√≠', 'Technologie', 'ƒåas', 'Smƒõna', 'Smlouva', 'Pravda', 'Vendeta', 'P≈ô√≠saha', 'Varov√°n√≠'
];

const CARD_SUITS = [
  { symbol: '‚ô•', name: 'Srdce', domain: 'Soci√°ln√≠/Emocion√°ln√≠', keywords: 'Vztahy, city, spojen√≠, podvod' },
  { symbol: '‚ô¶', name: 'K√°ry', domain: 'Materi√°ln√≠/Praktick√©', keywords: 'Bohatstv√≠, obchod, technologie, pl√°ny' },
  { symbol: '‚ô£', name: 'K≈ô√≠≈æe', domain: 'Fyzick√©/Akƒçn√≠', keywords: 'S√≠la, boj, pohyb, tƒõlesn√©' },
  { symbol: '‚ô†', name: 'Piky', domain: 'Mystick√©/Ment√°ln√≠', keywords: 'Magie, tajemstv√≠, znalosti, duchovn√≠' }
];

const CARD_VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

const CARD_VALUE_MEANINGS = {
  'A': 'Podstata, ƒçist√° forma',
  '2': 'Mal√©, osobn√≠', '3': 'Mal√©, aktu√°ln√≠',
  '4': 'St≈ôedn√≠', '5': 'St≈ôedn√≠, skupinov√©', '6': 'St≈ôedn√≠',
  '7': 'Velk√©', '8': 'Velk√©, komunitn√≠', '9': 'Velk√©',
  '10': 'Specializovan√©, expertn√≠',
  'J': 'Osoba, agent zmƒõny',
  'Q': 'Autorita, instituce',
  'K': 'Moc, vl√°da, vrchol'
};

const HIT_TABLE = {
  2: { result: 'KRITICK√ù MINUT√ç', effect: 'Ztr√°ta p≈ô√≠≈°t√≠ho tahu', damageType: 'none' },
  3: { result: 'Slab√Ω z√°sah', effect: 'Po≈°kozen√≠ s NEV√ùHODOU', damageType: 'disadvantage' },
  4: { result: 'Slab√Ω z√°sah', effect: 'Po≈°kozen√≠ s NEV√ùHODOU', damageType: 'disadvantage' },
  5: { result: 'Z√°sah', effect: 'Norm√°ln√≠ po≈°kozen√≠', damageType: 'normal' },
  6: { result: 'Z√°sah', effect: 'Norm√°ln√≠ po≈°kozen√≠', damageType: 'normal' },
  7: { result: 'Z√°sah', effect: 'Norm√°ln√≠ po≈°kozen√≠', damageType: 'normal' },
  8: { result: 'Z√°sah', effect: 'Norm√°ln√≠ po≈°kozen√≠', damageType: 'normal' },
  9: { result: 'Siln√Ω z√°sah', effect: 'Po≈°kozen√≠ s V√ùHODOU', damageType: 'advantage' },
  10: { result: 'Siln√Ω z√°sah', effect: 'Po≈°kozen√≠ s V√ùHODOU', damageType: 'advantage' },
  11: { result: 'Siln√Ω z√°sah +1', effect: 'Po≈°kozen√≠ s V√ùHODOU +1', damageType: 'advantage+1' },
  12: { result: 'DRTIV√ù √öDER', effect: 'Maximum po≈°kozen√≠', damageType: 'max' }
};

const WEATHER_TABLE = {
  spring: { 2: 'Bou≈ôe', 3: 'D√©≈°≈•', 4: 'D√©≈°≈•', 5: 'Zata≈æeno', 6: 'Zata≈æeno', 7: 'M√≠rn√©', 8: 'M√≠rn√©', 9: 'M√≠rn√©', 10: 'Sluneƒçno', 11: 'Sluneƒçno', 12: 'N√°dhern√©' },
  summer: { 2: 'Sucho', 3: 'Horko', 4: 'Horko', 5: 'Teplo', 6: 'Teplo', 7: 'P≈ô√≠jemn√©', 8: 'P≈ô√≠jemn√©', 9: 'P≈ô√≠jemn√©', 10: 'Sluneƒçno', 11: 'Sluneƒçno', 12: 'Perfektn√≠' },
  autumn: { 2: 'Vich≈ôice', 3: 'Mlha', 4: 'Mlha', 5: 'Zata≈æeno', 6: 'Zata≈æeno', 7: 'Chladno', 8: 'Chladno', 9: 'Chladno', 10: 'Svƒõ≈æ√≠', 11: 'Svƒõ≈æ√≠', 12: 'Zlat√©' },
  winter: { 2: 'V√°nice', 3: 'Snƒõ≈æen√≠', 4: 'Snƒõ≈æen√≠', 5: 'Zima', 6: 'Zima', 7: 'Mr√°z', 8: 'Mr√°z', 9: 'Mr√°z', 10: 'Jasno', 11: 'Jasno', 12: 'Klidn√©' }
};

// ============================================
// BESTIARY - CREATURE DATA
// ============================================

const CREATURE_CATEGORIES = [
  { id: 'beast-mammal', name: 'Zv√≠≈ôe - Savec', icon: 'üêÄ' },
  { id: 'beast-bird', name: 'Zv√≠≈ôe - Pt√°k', icon: 'ü¶Ö' },
  { id: 'beast-reptile', name: 'Zv√≠≈ôe - Plaz', icon: 'üêç' },
  { id: 'insect', name: 'Hmyz', icon: 'üêõ' },
  { id: 'arachnid', name: 'Pavoukovec', icon: 'üï∑Ô∏è' },
  { id: 'supernatural', name: 'Nadp≈ôirozen√©', icon: '‚ú®' },
  { id: 'mouse-rival', name: 'My≈°√≠ protivn√≠k', icon: 'üê≠' },
  { id: 'amphibian', name: 'Oboj≈æiveln√≠k', icon: 'üê∏' }
];

const BESTIARY = [
  // === OFFICIAL - CORE RULEBOOK ===
  {
    id: 1, name: 'Koƒçka', nameEn: 'Cat', category: 'beast-mammal', scale: 'Warband',
    hp: 15, str: 15, dex: 15, wil: 10, armor: 1,
    attacks: [{ name: 'Tlapnut√≠', damage: 'd6' }, { name: 'Kousnut√≠', damage: 'd8' }],
    abilities: ['Warband scale - pouze warband (20+ my≈°√≠) m≈Ø≈æe efektivnƒõ bojovat'],
    description: 'Obrovsk√Ω pred√°tor z pohledu my≈°√≠. Koƒçky jsou feud√°ln√≠ vl√°dci, kte≈ô√≠ po≈æaduj√≠ vƒõrnost a √∫platky.',
    tactics: 'Sna≈æ√≠ se zastra≈°it a p≈ôinutit ke kapitulaci. V boji je devastuj√≠c√≠.',
    wants: 'B√Ωt obsluhov√°na. Po≈æaduje p≈ô√≠sahy vƒõrnosti.',
    variants: ['Baltazar - miluje pochoutky', 'Melichar - miluje zlato', '≈†alamoun - krut√© hry', 'Chamurapi - p≈ô√≠sn√° logika', 'Nefertiti - umƒõn√≠ a poezie', 'Zenobia - dobyvatel'],
    source: 'Official'
  },
  {
    id: 2, name: 'Stono≈æka', nameEn: 'Centipede', category: 'insect', scale: 'Normal',
    hp: 8, str: 10, dex: 12, wil: 8, armor: 1,
    attacks: [{ name: 'Jedovat√© kousnut√≠', damage: 'd6', special: 'Po≈°kozuje DEX m√≠sto STR' }],
    criticalDamage: 'd12 po≈°kozen√≠ na STR',
    abilities: ['Jedovat√Ω √∫tok c√≠l√≠ na obratnost'],
    description: 'Mnohonoh√Ω pred√°tor s jedovat√Ωmi kusadly.',
    tactics: '√ötoƒç√≠ ze z√°lohy, sna≈æ√≠ se ochromit jedem.',
    wants: 'Toulat se a po≈æ√≠rat.',
    variants: ['Ob≈ô√≠ (HP 12, STR 15)', 'Plovouc√≠', 'Tyg≈ô√≠ (d8)', '≈Ωrav√°', 'Z√°vodn√≠', 'Ope≈ôen√°'],
    source: 'Official'
  },
  {
    id: 3, name: 'Vr√°na', nameEn: 'Crow', category: 'beast-bird', scale: 'Normal',
    hp: 12, str: 12, dex: 15, wil: 15, armor: 1,
    attacks: [{ name: 'Klov√°n√≠', damage: 'd8' }],
    abilities: ['L√©t√° 3√ó rychlost√≠', 'Zn√° dvƒõ p√≠snƒõ'],
    description: 'Inteligentn√≠ pt√°ci s mystick√Ωmi schopnostmi a star√Ωmi p√≠snƒõmi.',
    tactics: 'Pou≈æ√≠v√° p√≠snƒõ k ovlivnƒõn√≠ situace.',
    wants: 'Chr√°nit posv√°tn√° m√≠sta.',
    variants: ['P√≠se≈à √∫svitu - oslep√≠', 'P√≠se≈à smutku - Frightened', 'P√≠se≈à zraku - vƒõ≈°tba', 'P√≠se≈à vƒõtru - sr√°≈æ√≠', 'P√≠se≈à minulosti', 'P√≠se≈à pravdy'],
    source: 'Official'
  },
  {
    id: 4, name: 'V√≠la', nameEn: 'Faerie', category: 'supernatural', scale: 'Normal',
    hp: 6, str: 10, dex: 15, wil: 15, armor: 0,
    attacks: [{ name: 'St≈ô√≠brn√Ω rap√≠r', damage: 'd8' }],
    abilities: ['Zn√° jedno kouzlo', 'M≈Ø≈æe pou≈æ√≠vat glamour (iluze)'],
    description: 'Z√°hadn√© bytosti z V√≠l√≠ ≈ô√≠≈°e pln√≠c√≠ rozkazy kr√°lovny.',
    tactics: 'Preferuj√≠ lest a manipulaci p≈ôed bojem.',
    wants: 'Plnit √∫koly Kr√°lovny V√≠l.',
    variants: ['√önosce miminek', 'D√°rce proklet√Ωch dar≈Ø', 'Hudebn√≠k', 'P≈ôevl√©kaƒç', 'Kaziƒç j√≠dla', 'Podvodn√≠k'],
    source: 'Official'
  },
  {
    id: 5, name: '≈Ω√°ba', nameEn: 'Frog', category: 'amphibian', scale: 'Normal',
    hp: 6, str: 12, dex: 15, wil: 8, armor: 1,
    attacks: [{ name: 'Kop√≠', damage: 'd10' }, { name: 'Jazyk', damage: 'd6', special: 'P≈ôit√°hne c√≠l' }],
    criticalDamage: 'Odskoƒç√≠ z dosahu',
    abilities: ['V≈ædy jedn√° prvn√≠', 'Sk√°ƒçe 2√ó rychlost√≠'],
    description: 'Galantn√≠ ≈æab√≠ ryt√≠≈ôi na v√Ωprav√°ch.',
    tactics: 'Vyu≈æ√≠v√° rychlost, jedn√° ƒçestnƒõ podle kodexu.',
    wants: 'Dokonƒçit svou v√Ωpravu.',
    variants: ['Gwal - siln√Ω, prost√Ω', 'Filip - proklet√Ω ƒçlovƒõk', 'Lurf - ukvapen√Ω', 'Slup - lovec besti√≠', 'Uuu - turnajov√Ω', 'Puc - hled√° Poh√°r'],
    source: 'Official'
  },
  {
    id: 6, name: 'Duch', nameEn: 'Ghost', category: 'supernatural', scale: 'Normal',
    hp: 9, str: 5, dex: 10, wil: 10, armor: 0,
    attacks: [{ name: 'Mraziv√Ω dotyk', damage: 'd8', special: 'Po≈°kozuje WIL m√≠sto STR' }],
    criticalDamage: 'Posedne c√≠l',
    abilities: ['Pouze zraniteln√Ω st≈ô√≠brem/magi√≠', 'M√° ducha≈ôskou schopnost'],
    description: 'Ne≈°≈•astn√© du≈°e uvƒõznƒõn√© mezi svƒõty.',
    tactics: '√ötoƒç√≠ mraziv√Ωm dotykem, niƒç√≠ v≈Øli.',
    wants: 'Svobodu od bolesti.',
    variants: ['Z√°blesk - d3 iluz√≠', 'Poltergeist - h√°z√≠ vƒõci', 'Lapaƒç - vtahuje do ≈ô√≠≈°e', 'Zk√°za - Frightened', 'Hnilobn√≠k - niƒç√≠ z√°soby', 'Nehmotn√Ω'],
    source: 'Official'
  },
  {
    id: 7, name: 'My≈° (Rival)', nameEn: 'Mouse', category: 'mouse-rival', scale: 'Normal',
    hp: 3, str: 9, dex: 9, wil: 9, armor: 0,
    attacks: [{ name: 'Meƒç', damage: 'd6' }, { name: 'Luk', damage: 'd6', special: 'Na d√°lku' }],
    abilities: [],
    description: 'Rivalov√©, zloƒçinci nebo jin√≠ my≈°√≠ dobrodruzi.',
    tactics: 'Pou≈æ√≠vaj√≠ podobn√© taktiky jako hr√°ƒçi.',
    wants: 'C√≠tit se v bezpeƒç√≠.',
    variants: ['Bodl√°k - zhanoben√Ω ryt√≠≈ô', 'Belladona - ƒçarodƒõj', 'Slam√°k - zlodƒõj', 'Mandragora - podvodn√≠k', 'Mƒõs√≠ƒçek - pyroman', 'Leif - vyhnanec'],
    source: 'Official'
  },
  {
    id: 8, name: 'Sova', nameEn: 'Owl', category: 'beast-bird', scale: 'Normal',
    hp: 15, str: 15, dex: 15, wil: 15, armor: 1,
    attacks: [{ name: 'Kousnut√≠', damage: 'd10' }],
    abilities: ['L√©t√° 3√ó rychlost√≠', 'Zn√° dvƒõ kouzla'],
    description: 'Mocn√≠ ptaƒç√≠ ƒçarodƒõjov√© sb√≠raj√≠c√≠ vz√°cn√© znalosti.',
    tactics: 'Kombinuje magii s fyzick√Ωmi √∫toky.',
    wants: 'Sb√≠rat vz√°cn√© znalosti a kouzla.',
    variants: ['Bezalel - stav√≠ mechaniky', 'Morgana - spolek s v√≠lami', 'Prospero - chim√©rick√Ω', 'Krahujec - mƒõniƒç', 'Crowley - v√°≈æe duchy', 'Lechuza - uvƒõznƒõn√° ƒçarodƒõjnice'],
    source: 'Official'
  },
  {
    id: 9, name: 'Krysa', nameEn: 'Rat', category: 'mouse-rival', scale: 'Normal',
    hp: 3, str: 12, dex: 8, wil: 8, armor: 0,
    attacks: [{ name: 'Sek√°ƒçek', damage: 'd6' }],
    abilities: [],
    description: 'Vƒõt≈°√≠ a agresivnƒõj≈°√≠ p≈ô√≠buzn√≠ my≈°√≠, organizovan√≠ v gangech.',
    tactics: '√ötoƒç√≠ ve skupin√°ch, z√°ke≈ôn√© taktiky.',
    wants: 'Snadn√© bohatstv√≠, br√°t od slab√Ωch.',
    variants: ['Dedratz - pas≈•√°ci', 'Vodn√≠ krysy - lodn√≠ci', 'Laboratorn√≠ - magick√©', 'Plechov√≠ ryt√≠≈ôi (Armor 1)', 'D≈æentelkrysy', 'Kr√°lov√© (Rat King)'],
    source: 'Official'
  },
  {
    id: 10, name: 'Had', nameEn: 'Snake', category: 'beast-reptile', scale: 'Normal',
    hp: 12, str: 12, dex: 10, wil: 10, armor: 2,
    attacks: [{ name: 'Kousnut√≠', damage: 'd8' }],
    criticalDamage: 'Spolkne cel√©ho - d4 STR/kolo',
    abilities: ['Vysok√Ω panc√≠≈ô d√≠ky ≈°upin√°m'],
    description: 'Plaziv√Ω pred√°tor polykaj√≠c√≠ ko≈ôist vcelku.',
    tactics: '√ötoƒç√≠ rychle ze z√°lohy, sna≈æ√≠ se spolknout.',
    wants: 'Neru≈°enƒõ sp√°t.',
    variants: ['D≈ôevƒõn√Ω - oƒçarovan√Ω', 'St√≠nov√Ω - v≈ædy mimo dohled', 'Kostƒõn√Ω - nemrtv√Ω', '√öho≈ô - vodn√≠', 'Svitkov√Ω - kouzlo v ≈°upin√°ch', 'Dr√°ƒçek - k≈ô√≠dla, ohe≈à'],
    source: 'Official'
  },
  {
    id: 11, name: 'Pavouk', nameEn: 'Spider', category: 'arachnid', scale: 'Normal',
    hp: 6, str: 8, dex: 15, wil: 10, armor: 1,
    attacks: [{ name: 'Jedovat√© kousnut√≠', damage: 'd6', special: 'Po≈°kozuje DEX m√≠sto STR' }],
    criticalDamage: 'Odnese ko≈ôist v pavuƒçinƒõ',
    abilities: ['Jedovat√Ω √∫tok', 'Tk√° pavuƒçiny'],
    description: 'Osminoz√≠ lovci stavƒõj√≠c√≠ smrt√≠c√≠ pasti.',
    tactics: 'Stav√≠ pavuƒçiny a ƒçek√°, pak paralyzuje jedem.',
    wants: 'Nakrmit sv√° ml√°ƒèata.',
    variants: ['Vdova (d10)', 'Vlƒç√≠ - smeƒçka d6', 'Sek√°ƒç - m√≠rumilovn√Ω', 'Architekt - tunely', 'Blikaj√≠c√≠ - teleport', 'P≈ô√≠zraƒçn√Ω - nehmotn√Ω'],
    source: 'Official'
  },
  // === OFFICIAL - HONEY IN THE RAFTERS ===
  {
    id: 12, name: 'Skunk', nameEn: 'Skunk (Shig)', category: 'beast-mammal', scale: 'Warband',
    hp: 10, str: 12, dex: 10, wil: 8, armor: 1,
    attacks: [{ name: 'Kousnut√≠', damage: 'd8' }, { name: 'Pi≈æmov√Ω sprej', damage: '0', special: 'Frightened d4 tvor≈Øm' }],
    abilities: ['Warband scale', 'Pi≈æmov√Ω sprej'],
    description: 'Velk√Ω smrdut√Ω savec hledaj√≠c√≠ j√≠dlo.',
    tactics: 'Nejprve sprej k zastra≈°en√≠, pak √∫tok.',
    wants: 'V klidu se naj√≠st.',
    source: 'Official - Honey in the Rafters'
  },
  {
    id: 13, name: 'Proklet√° vƒçela', nameEn: 'Cursed Bee', category: 'insect', scale: 'Normal',
    hp: 2, str: 6, dex: 12, wil: 6, armor: 0,
    attacks: [{ name: '≈Ωihadlo', damage: 'd4', special: 'M≈Ø≈æe zp≈Øsobit kletbu' }],
    criticalDamage: 'N√°hodn√° kletba',
    abilities: ['L√©t√°', 'Proklet√Ω pyl'],
    description: 'Vƒçely z proklet√©ho √∫lu slou≈æ√≠c√≠ kr√°lovnƒõ Esurit.',
    tactics: '√ötoƒç√≠ v roj√≠ch (d6 nebo 2d6).',
    wants: 'Slou≈æit kr√°lovnƒõ a ≈°√≠≈ôit proklet√≠.',
    encounterSize: 'd6 nebo 2d6',
    source: 'Official - Honey in the Rafters'
  },
  {
    id: 14, name: 'Lasice', nameEn: 'Weasel', category: 'beast-mammal', scale: 'Normal',
    hp: 6, str: 10, dex: 12, wil: 8, armor: 0,
    attacks: [{ name: 'Kousnut√≠', damage: 'd6' }],
    abilities: ['Rychl√° a hbit√°', 'Lov√≠ my≈°i'],
    description: '≈†t√≠hl√Ω pred√°tor lov√≠c√≠ drobn√© hlodavce.',
    tactics: 'Rychl√© √∫toky, vyu≈æ√≠v√° svou hbitost.',
    wants: 'Lovit a j√≠st.',
    source: 'Official - Honey in the Rafters'
  },
  {
    id: 15, name: 'Kr√°lovna Esurit', nameEn: 'Queen Esurit', category: 'supernatural', scale: 'Normal',
    hp: 8, str: 8, dex: 12, wil: 15, armor: 0,
    attacks: [{ name: 'Proklet√Ω dotyk', damage: 'd6', special: 'WIL save nebo kletba' }],
    abilities: ['Ovl√°d√° proklet√© vƒçely', 'M≈Ø≈æe ses√≠lat kletby'],
    description: 'Proklet√° vƒçel√≠ kr√°lovna, kdysi norm√°ln√≠, nyn√≠ zlomysln√°.',
    tactics: 'Pou≈æ√≠v√° vƒçely k obranƒõ, sama ses√≠l√° kletby.',
    wants: '≈†√≠≈ôit proklet√≠ a ovl√°dat √∫l.',
    source: 'Official - Honey in the Rafters'
  },
  // === OFFICIAL - THE ESTATE ===
  {
    id: 16, name: 'Je≈æek', nameEn: 'Hedgehog', category: 'beast-mammal', scale: 'Normal',
    hp: 8, str: 12, dex: 8, wil: 10, armor: 2,
    attacks: [{ name: 'Bodliny', damage: 'd6', special: 'Po≈°kozen√≠ √∫toƒçn√≠kovi p≈ôi z√°sahu zbl√≠zka' }],
    abilities: ['Bodliny chr√°n√≠', 'M≈Ø≈æe se svinout do klubka'],
    description: 'Bodlinat√Ω savec, obvykle m√≠rumilovn√Ω ale nebezpeƒçn√Ω.',
    tactics: 'Svine se do klubka p≈ôi ohro≈æen√≠.',
    wants: 'Hmyz a klid.',
    source: 'Official - The Estate'
  },
  {
    id: 17, name: 'Rejsek', nameEn: 'Shrew', category: 'beast-mammal', scale: 'Normal',
    hp: 4, str: 8, dex: 14, wil: 6, armor: 0,
    attacks: [{ name: 'Kousnut√≠', damage: 'd4', special: 'Jedovat√Ω - DEX po≈°kozen√≠' }],
    abilities: ['Jedovat√Ω', 'Neust√°le hladov√Ω'],
    description: 'Mal√Ω, ale agresivn√≠ savec s jedovat√Ωm kousnut√≠m.',
    tactics: 'Rychl√© √∫toky, mus√≠ neust√°le j√≠st.',
    wants: 'J√≠dlo, hodnƒõ j√≠dla.',
    source: 'Official - The Estate'
  },
  {
    id: 18, name: 'Krtek', nameEn: 'Mole', category: 'beast-mammal', scale: 'Normal',
    hp: 6, str: 14, dex: 6, wil: 8, armor: 1,
    attacks: [{ name: 'Dr√°py', damage: 'd6' }],
    abilities: ['Hrab√°n√≠ tunel≈Ø', 'T√©mƒõ≈ô slep√Ω ale dobr√Ω sluch'],
    description: 'Podzemn√≠ savec s mohutn√Ωmi dr√°py.',
    tactics: '√ötoƒç√≠ ze zemƒõ, p≈ôekvapuje.',
    wants: 'ƒåervy a larvy.',
    source: 'Official - The Estate'
  },
  // === HOMEBREW - VARIOUS SOURCES ===
  {
    id: 19, name: 'Sv√≠ƒçk√°≈ô', nameEn: 'Candlekin', category: 'supernatural', scale: 'Normal',
    hp: 4, str: 6, dex: 10, wil: 12, armor: 0,
    attacks: [{ name: 'Ho≈ô√≠c√≠ dotyk', damage: 'd4', special: 'Zapaluje ho≈ôlav√©' }],
    abilities: ['O≈æivl√° sv√≠ƒçka', 'Boj√≠ se vody a vƒõtru'],
    description: 'O≈æivl√° sv√≠ƒçka s vlastn√≠ v≈Øl√≠.',
    tactics: 'Zapaluje okol√≠, boj√≠ se uhasnut√≠.',
    wants: 'Ho≈ôet navƒõky.',
    source: 'Homebrew'
  },
  {
    id: 20, name: 'Muchom≈Ørka', nameEn: 'Toadstool', category: 'supernatural', scale: 'Normal',
    hp: 6, str: 8, dex: 6, wil: 14, armor: 1,
    attacks: [{ name: 'Sporov√Ω oblak', damage: 'd6', special: 'WIL save nebo halucinace' }],
    abilities: ['Vypou≈°t√≠ spory', 'Regeneruje ve vlhku'],
    description: 'O≈æivl√° jedovat√° houba.',
    tactics: 'Sporov√Ω oblak mate nep≈ô√°tele.',
    wants: '≈†√≠≈ôit sv√© spory.',
    source: 'Homebrew'
  },
  {
    id: 21, name: 'Mandelinka', nameEn: 'Beetle Knight', category: 'insect', scale: 'Normal',
    hp: 5, str: 12, dex: 8, wil: 10, armor: 2,
    attacks: [{ name: 'Kop√≠', damage: 'd8' }],
    abilities: ['Tƒõ≈æk√Ω krun√Ω≈ô', 'M≈Ø≈æe l√©tat kr√°tce'],
    description: 'Brouk vycviƒçen√Ω k boji jako ryt√≠≈ô.',
    tactics: '√ötoƒç√≠ jako kavalerie.',
    wants: 'ƒåest a sl√°vu.',
    source: 'Homebrew'
  },
  {
    id: 22, name: 'P≈ô√≠zraƒçn√° koƒçka', nameEn: 'Ghost Cat', category: 'supernatural', scale: 'Warband',
    hp: 12, str: 10, dex: 15, wil: 15, armor: 0,
    attacks: [{ name: 'P≈ô√≠zraƒçn√© dr√°pnut√≠', damage: 'd6', special: 'Po≈°kozuje WIL m√≠sto STR' }],
    criticalDamage: 'Frightened',
    abilities: ['Warband scale', 'Pouze zraniteln√° st≈ô√≠brem/magi√≠', 'Proch√°z√≠ zdmi'],
    description: 'Duch mrtv√© koƒçky, kombinuje hrozbu koƒçky s duchy.',
    tactics: 'Pron√°sleduje ko≈ôist proch√°zen√≠m zdmi.',
    wants: 'Pokraƒçovat v lovu i po smrti.',
    source: 'Homebrew'
  },
  {
    id: 23, name: 'Korgi', nameEn: 'Corgi', category: 'beast-mammal', scale: 'Warband',
    hp: 18, str: 16, dex: 10, wil: 8, armor: 1,
    attacks: [{ name: 'Kousnut√≠', damage: 'd10' }, { name: 'Dupnut√≠', damage: 'd8', special: 'Blast' }],
    abilities: ['Warband scale', 'P≈ô√°telsk√Ω ale nebezpeƒçn√Ω'],
    description: 'Mal√Ω pes z pohledu lid√≠, obrovsk√° bestie pro my≈°i.',
    tactics: 'Ne√∫toƒç√≠ se zl√Ωm √∫myslem - jen si hraje.',
    wants: 'Hr√°t si a dostat pamlsky.',
    source: 'Homebrew'
  },
  {
    id: 24, name: 'Nuno', nameEn: 'Nuno', category: 'supernatural', scale: 'Normal',
    hp: 5, str: 8, dex: 10, wil: 15, armor: 0,
    attacks: [{ name: 'Kletba', damage: '0', special: 'WIL save nebo kletba' }],
    abilities: ['Ses√≠l√° kletby', '≈Ωije v mraveni≈°t√≠ch', 'Lze usm√≠≈ôit dary'],
    description: 'Duchov√© s√≠dl√≠c√≠ v mraveni≈°t√≠ch (filip√≠nsk√Ω folkl√≥r).',
    tactics: 'Vyh√Ωb√° se boji, prokl√≠n√° vet≈ôelce.',
    wants: 'B√Ωt ponech√°n v klidu.',
    source: 'Homebrew - Spirited'
  },
  {
    id: 25, name: 'Tsukumogami', nameEn: 'Tsukumogami', category: 'supernatural', scale: 'Normal',
    hp: 4, str: 10, dex: 8, wil: 12, armor: 1,
    attacks: [{ name: 'Podle typu p≈ôedmƒõtu', damage: 'd6' }],
    abilities: ['O≈æivl√Ω p≈ôedmƒõt', 'Loaj√°ln√≠ k majiteli', 'R≈Øzn√© schopnosti'],
    description: 'O≈æivl√© p≈ôedmƒõty star≈°√≠ 100 let (japonsk√Ω folkl√≥r).',
    tactics: 'Jedn√° podle sv√© p≈Øvodn√≠ funkce.',
    wants: 'Slou≈æit nebo se pomst√≠t.',
    source: 'Homebrew - Spirited'
  },
  {
    id: 26, name: 'Nac Mac Feegle', nameEn: 'Nac Mac Feegle', category: 'supernatural', scale: 'Normal',
    hp: 2, str: 12, dex: 14, wil: 6, armor: 0,
    attacks: [{ name: 'Hlaviƒçka', damage: 'd6' }, { name: 'Meƒç', damage: 'd4' }],
    abilities: ['√ötoƒç√≠ v roj√≠ch (3d6)', 'Extr√©mnƒõ odv√°≈æn√≠', 'Miluj√≠ boj a alkohol'],
    description: 'Maliƒçc√≠ mod≈ô√≠ bojovn√≠ci (inspirace Pratchett).',
    tactics: '√ötoƒç√≠ v davech s bojov√Ωm pok≈ôikem.',
    wants: 'Rvaƒçku, whisky a sl√°vu.',
    encounterSize: '3d6',
    source: 'Homebrew - Spirited'
  },
  {
    id: 27, name: 'Lutin', nameEn: 'Lutin', category: 'supernatural', scale: 'Normal',
    hp: 5, str: 8, dex: 15, wil: 12, armor: 0,
    attacks: [{ name: 'Podle zv√≠≈ôec√≠ formy', damage: 'd6' }],
    abilities: ['Mƒõn√≠ podobu na zv√≠≈ôata', '≈†pr√Ωma≈ô a trickster'],
    description: 'Duchov√© z francouzsk√©ho folkl√≥ru mƒõn√≠c√≠ podobu.',
    tactics: 'P≈ôedst√≠r√° obyƒçejn√© zv√≠≈ôe, pak p≈ôekvap√≠.',
    wants: 'Bavit se na √∫ƒçet druh√Ωch.',
    source: 'Homebrew - Spirited'
  },
  {
    id: 28, name: 'Kapybara', nameEn: 'Capybara', category: 'beast-mammal', scale: 'Warband',
    hp: 14, str: 14, dex: 8, wil: 12, armor: 1,
    attacks: [{ name: 'Kousnut√≠', damage: 'd8' }],
    abilities: ['Warband scale', 'V√Ωborn√Ω plavec', 'Obvykle m√≠rumilovn√°'],
    description: 'Ob≈ô√≠ hlodavec z Amazonie, klidn√Ω ale nebezpeƒçn√Ω.',
    tactics: 'Vyh√Ωb√° se konfliktu, uteƒçe do vody.',
    wants: 'Klid a p≈ô√≠stup k vodƒõ.',
    source: 'Homebrew'
  }
];
const LANDMARKS = [
  'Star√Ω pokroucen√Ω dub', 'Opu≈°tƒõn√° ptaƒç√≠ budka', 'Rozbit√Ω hlinƒõn√Ω kvƒõtin√°ƒç', 'Podm√°ƒçen√° louka', 'Hust√Ω malinov√Ω ke≈ô',
  'Star√° kamenn√° zeƒè', 'Potok s mal√Ωm vodop√°dem', 'V√Ωvrat mohutn√©ho stromu', 'Houbov√Ω h√°j', 'Opu≈°tƒõn√© li≈°ƒç√≠ doupƒõ',
  'Star√Ω most z klac√≠k≈Ø', 'Vyschl√° studna', 'Rozpadl√Ω plot', 'Trnit√Ω ≈æiv√Ω plot', 'Bahenn√≠ t≈Ø≈à',
  'Sk√°la s jeskyn√≠', 'Opu≈°tƒõn√Ω vƒçel√≠ √∫l', 'Velk√Ω balvan', 'Louka divok√Ωch kvƒõtin', 'Temn√Ω hvozd'
];

const SETTLEMENT_FEATURES = [
  'Spir√°lov√© schodi≈°tƒõ hluboko do zemƒõ', 'Vƒõtrn√Ω ml√Ωn z o≈ôechov√© sko≈ô√°pky', 'Visut√° l√°vka mezi vƒõtvemi',
  'Podzemn√≠ tr≈æi≈°tƒõ', 'Svatynƒõ prastar√©ho ducha', 'Vƒõ≈æ z n√°prstku', 'Biblioteca v dut√©m kmeni',
  'L√°znƒõ z kapky rosy', 'Kov√°rna v ≈æelezn√©m h≈ôebu', 'Hostinec "U S√Ωrov√©ho Mƒõs√≠ce"',
  'Ar√©na pro turnaje', 'Astronomick√° observato≈ô', 'Alchymistick√° d√≠lna', 'Diplomatick√° hala',
  'Sklen√≠k vz√°cn√Ωch bylin', 'Zbrojnice a cviƒçi≈°tƒõ', 'P≈ô√≠stav na potoku', 'Hudebn√≠ akademie',
  'Vƒõ≈°t√≠rna star√©ho p√°na', 'Vƒõznice a soudn√≠ s√≠≈à'
];

const SETTLEMENT_EVENTS = [
  'Cenn√° relikvie ukradena', 'Z√°hadn√° nemoc se ≈°√≠≈ô√≠', 'Hrdina se nevr√°til z v√Ωpravy', 'Obchodn√≠ karavana zmizela',
  'Divn√° zv√≠≈ôata vidƒõna pobl√≠≈æ', 'Star√° smlouva vypr≈°ela', 'N√°v≈°tƒõva z dalek√Ωch kraj≈Ø', 'Festival se bl√≠≈æ√≠',
  'Starosta je nezvƒõstn√Ω', 'Podzemn√≠ t≈ôesy', 'Nov√Ω vyn√°lez zp≈Øsobil chaos', 'Rivalsk√° osada hroz√≠',
  'Mystick√© znamen√≠ na obloze', 'Vz√°cn√° bylina odkvetla', 'Prastar√Ω duch promluvil', 'Zlodƒõji ≈ô√°d√≠',
  'L√°ska a skand√°l', 'Prorock√© sny', 'Z√°hadn√Ω cizinec p≈ôi≈°el', 'Soutƒõ≈æ o d≈Øle≈æitou pozici'
];

// ===== MAUSRITTER CHARACTER TABLES =====

// Mu≈æsk√° k≈ôestn√≠ jm√©na (40)
const MALE_FIRST_NAMES = [
  'Mech√°ƒçek', 'L√≠stek', 'O≈ô√≠≈°ek', 'Vƒõtv√≠k', 'Kl√°sek', 'Cvrƒçek', '≈†√≠pek', 'Bobek',
  'Brouƒçek', 'St√©blo', 'Pe≈ô√≠ƒçko', 'Kam√≠nek', 'Poupƒõ', 'Pup√≠k', '≈†i≈°ka', 'Ko≈ô√≠nek',
  'St≈ô√≠zl√≠k', 'Vrabƒç√°k', 'S√Ωƒçek', 'Dudek', 'Bodl√°k', 'Jehl√≠ƒçek', '≈Ωaludek', 'Ka≈°t√°nek',
  'Vƒõtrn√≠k', 'Mot√Ωlek', 'ƒåerv√≠ƒçek', 'Brouƒç√≠k', 'Pavouƒçek', 'ƒåmel√°ƒçek', 'Mraveneƒçek',
  'Hlem√Ω≈æƒè√°k', 'Slim√°ƒçek', '≈†neƒç√≠k', 'Je≈æeƒçek', 'Krteƒçek', 'Lum√≠k', 'Hrabo≈°', 'Ply≈°√°ƒçek', 'Chlupatec'
];

// ≈Ωensk√° k≈ôestn√≠ jm√©na (40)
const FEMALE_FIRST_NAMES = [
  'Kop≈ôivka', 'Sedmikr√°ska', 'Kapradinka', 'B≈ôeƒç≈•anka', 'Vrbiƒçka', 'Jahodka',
  'Makovka', 'Fialka', 'Konvalinka', 'Pomnƒõnka', 'Rosiƒçka', 'Jah≈Ødka', 'Traviƒçka',
  'Chudobka', 'Sasanka', 'Chrpiƒçka', 'Slziƒçka', 'Hvƒõzdiƒçka', 'Perla', 'Mu≈°el√≠nka',
  'Kopre≈•ka', '≈†√≠pkov√°', 'R≈Ø≈æenka', 'Lnƒõnka', 'Bledule', 'Snƒõ≈æenka', 'Jit≈ôenka',
  'Veƒçerka', 'Pampel√≠≈°ka', 'Mƒõs√≠ƒçenka', 'Sluneƒçka', 'Hvƒõzdulka', 'Vƒçelka', 'Mu≈°ka',
  'Beru≈°ka', 'V√°≈æka', 'Kobylka', 'Mu≈°inka', 'Je≈æurka', 'My≈°ka'
];

// P≈ô√≠jmen√≠ s mu≈æskou/≈æenskou variantou (40)
const FAMILY_NAMES = [
  { male: 'B√≠l√Ω', female: 'B√≠l√°' },
  { male: 'ƒåern√Ω', female: 'ƒåern√°' },
  { male: 'ƒåiha≈ô', female: 'ƒåiha≈ôov√°' },
  { male: 'Darƒçek', female: 'Darƒçkov√°' },
  { male: 'Durman', female: 'Durmanov√°' },
  { male: 'Hrabal', female: 'Hrabalov√°' },
  { male: 'Chalva', female: 'Chalvov√°' },
  { male: 'Ja≈ôinka', female: 'Ja≈ôinkov√°' },
  { male: 'Jele≈à√°k', female: 'Jele≈à√°kov√°' },
  { male: 'Jese≈à', female: 'Jese≈àov√°' },
  { male: 'Katzenreiser', female: 'Katzenreiserov√°' },
  { male: 'M√°seln√≠k', female: 'M√°seln√≠kov√°' },
  { male: 'P√≠p', female: 'P√≠pov√°' },
  { male: '≈òe≈°etl√°k', female: '≈òe≈°etl√°kov√°' },
  { male: 'Sem√≠nko', female: 'Sem√≠nkov√°' },
  { male: 'Sn√≠h', female: 'Snƒõhov√°' },
  { male: 'Str√°≈æn√Ω', female: 'Str√°≈æn√°' },
  { male: 'Trnka', female: 'Trnkov√°' },
  { male: 'Urobil', female: 'Urobilov√°' },
  { male: '≈Ωvanil', female: '≈Ωvanilov√°' },
  { male: 'B≈ôezina', female: 'B≈ôezinov√°' },
  { male: 'Kop≈ôiva', female: 'Kop≈ôivov√°' },
  { male: '≈Ωitn√Ω', female: '≈Ωitn√°' },
  { male: 'Medn√≠k', female: 'Medn√≠kov√°' },
  { male: '≈†√≠pek', female: '≈†√≠pkov√°' },
  { male: 'Bodl√°k', female: 'Bodl√°kov√°' },
  { male: 'Mech', female: 'Mechov√°' },
  { male: 'Ko≈ôen', female: 'Ko≈ôenov√°' },
  { male: 'Pƒõnkava', female: 'Pƒõnkavov√°' },
  { male: 'Vrabec', female: 'Vrabcov√°' },
  { male: 'K≈ôeƒçek', female: 'K≈ôeƒçkov√°' },
  { male: 'S√Ωkorka', female: 'S√Ωkorkov√°' },
  { male: 'Lesn√≠k', female: 'Lesn√≠kov√°' },
  { male: 'Pol√°k', female: 'Pol√°kov√°' },
  { male: 'Stodola', female: 'Stodolov√°' },
  { male: 'Mlyn√°≈ô', female: 'Mlyn√°≈ôov√°' },
  { male: 'Podzimek', female: 'Podzimkov√°' },
  { male: 'Zim√°k', female: 'Zim√°kov√°' },
  { male: 'Jarn√≠k', female: 'Jarn√≠kov√°' },
  { male: 'Letn√≠k', female: 'Letn√≠kov√°' }
];

// Rodn√° znamen√≠ (k6)
const BIRTHSIGNS = [
  { sign: 'Hvƒõzda', trait: 'Stateƒçn√°/zbrkl√°' },
  { sign: 'Kolo', trait: 'Pracovit√°/nen√°padit√°' },
  { sign: '≈Ωalud', trait: 'Zvƒõdav√°/paliƒçat√°' },
  { sign: 'Bou≈ôka', trait: '≈†tƒõdr√°/popudliv√°' },
  { sign: 'Mƒõs√≠c', trait: 'Moudr√°/z√°hadn√°' },
  { sign: 'Matka', trait: 'Peƒçuj√≠c√≠/ustaran√°' }
];

// Barva srsti (k6)
const FUR_COLORS = ['ƒåokol√°dov√°', 'ƒåern√°', 'B√≠l√°', 'Svƒõtle hnƒõd√°', '≈†ed√°', 'Namodral√°'];

// Vzor srsti (k6)
const FUR_PATTERNS = ['Jednolit√°', 'Mourovat√°', 'Strakat√°', 'Pruhovan√°', 'Teƒçkovan√°', 'Skvrnit√°'];

// V√Ωrazn√© rysy (k66)
const DISTINCTIVE_FEATURES = {
  '1-1': 'Tƒõlo pln√© jizev', '1-2': 'Korpulentn√≠ tƒõlo', '1-3': 'Vychrtl√© tƒõlo',
  '1-4': 'Klackovit√© tƒõlo', '1-5': 'Drobn√© tƒõl√≠ƒçko', '1-6': 'Rozlo≈æit√© tƒõlo',
  '2-1': 'V√°leƒçn√© malov√°n√≠', '2-2': 'Cizokrajn√© obleƒçen√≠', '2-3': 'Elegantn√≠ obleƒçen√≠',
  '2-4': 'Z√°platovan√© obleƒçen√≠', '2-5': 'M√≥dn√≠ obleƒçen√≠', '2-6': 'Nepran√© obleƒçen√≠',
  '3-1': 'Useknut√© ucho', '3-2': 'Neforemn√Ω obliƒçej', '3-3': 'Kr√°sn√Ω obliƒçej',
  '3-4': 'Baculat√Ω obliƒçej', '3-5': 'Jemn√© rysy v obliƒçeji', '3-6': 'Prot√°hl√Ω obliƒçej',
  '4-1': 'Naƒçesan√° srst', '4-2': 'Dredy', '4-3': 'Nabarven√° srst',
  '4-4': 'Oholen√° srst', '4-5': 'Kudrnat√° srst', '4-6': 'Sametov√° srst',
  '5-1': 'Oƒçi temn√© jako noc', '5-2': 'P√°ska p≈ôes oko', '5-3': 'Krvavƒõ rud√© oƒçi',
  '5-4': 'Moudr√Ω pohled', '5-5': 'Pronikav√Ω pohled', '5-6': 'Bly≈°tiv√© oƒçi',
  '6-1': 'Zast≈ôi≈æen√Ω oc√°sek', '6-2': 'Oc√°sek jako biƒç', '6-3': 'Chocholat√Ω oc√°sek',
  '6-4': 'Pah√Ωl oc√°sku', '6-5': 'Ch√°pav√Ω oc√°sek', '6-6': 'Zakroucen√Ω oc√°sek'
};

// Tabulka p≈Øvod≈Ø - 36 kombinac√≠ (BO 1-6 √ó ƒéobky 1-6)
const ORIGINS = {
  '1-1': { name: 'Pokusn√° my≈°', itemA: 'Kouzlo: Kouzeln√° st≈ôela', itemB: 'Olovƒõn√Ω pl√°≈°≈• (tƒõ≈æk√° zbroj)' },
  '1-2': { name: 'Kuchy≈àsk√Ω sl√≠dil', itemA: '≈†t√≠t a kab√°tec (lehk√° zbroj)', itemB: 'Hrnce' },
  '1-3': { name: 'Uprchl√≠k z klece', itemA: 'Kouzlo: Srozumitelnost', itemB: 'L√°hev ml√©ka' },
  '1-4': { name: 'ƒåarodƒõjnice', itemA: 'Kouzlo: Zahojen√≠', itemB: 'Vonn√° tyƒçka' },
  '1-5': { name: 'Ko≈æe≈°n√≠k', itemA: '≈†t√≠t a kab√°tec (lehk√° zbroj)', itemB: 'Siln√© n≈Ø≈æky' },
  '1-6': { name: 'Pouliƒçn√≠ rv√°ƒç', itemA: 'D√Ωka (lehk√°, k6)', itemB: 'L√°hev k√°vy' },
  '2-1': { name: '≈Ωebrav√Ω knƒõz', itemA: 'Kouzlo: Zotaven√≠', itemB: 'Svat√Ω symbol' },
  '2-2': { name: 'Hon√°k brouk≈Ø', itemA: 'Pomocn√≠k: vƒõrn√Ω brouk', itemB: 'Tyƒç, 15 cm' },
  '2-3': { name: 'Sl√°dek', itemA: 'Pomocn√≠k: opil√Ω svƒõtlono≈°', itemB: 'Soudek piva' },
  '2-4': { name: 'Ryb√°≈ô', itemA: 'S√≠≈•', itemB: 'Jehla (lehk√°, k6)' },
  '2-5': { name: 'Kov√°≈ô', itemA: 'Kladivo (st≈ôedn√≠, k6/k8)', itemB: 'Piln√≠k na ≈æelezo' },
  '2-6': { name: 'Dr√°ten√≠k', itemA: 'Dr√°t, klubko', itemB: 'Elektrick√° lampa' },
  '3-1': { name: 'D≈ôevorubec', itemA: 'Sekera (st≈ôedn√≠, k6/k8)', itemB: 'Motouz, klubko' },
  '3-2': { name: 'ƒålen netop√Ω≈ô√≠ho kultu', itemA: 'Kouzlo: Tma', itemB: 'Pytl√≠k netop√Ω≈ô√≠ch zub≈Ø' },
  '3-3': { name: 'Horn√≠k v c√≠nov√©m dole', itemA: 'Krump√°ƒç (st≈ôedn√≠, k6/k8)', itemB: 'Lucerna' },
  '3-4': { name: 'Sbƒõraƒç odpadk≈Ø', itemA: 'H√°k na odpadky (tƒõ≈æk√°, k10)', itemB: 'Zrc√°tko' },
  '3-5': { name: 'Stƒõnolezec', itemA: 'Ryb√°≈ôsk√Ω h√°ƒçek', itemB: 'Nit, c√≠vka' },
  '3-6': { name: 'Kupec', itemA: 'Pomocn√≠k: ta≈æn√° krysa', itemB: 'Smƒõnka od ≈°lechtice na 20 ƒè' },
  '4-1': { name: 'Vora≈ô', itemA: 'Kladivo (st≈ôedn√≠, k6/k8)', itemB: 'D≈ôevƒõn√© kl√≠ny' },
  '4-2': { name: 'Hon√°k ≈æ√≠≈æal', itemA: 'Tyƒç, 15 cm', itemB: 'M√Ωdlo' },
  '4-3': { name: 'Vla≈°tovk√°≈ô', itemA: 'Ryb√°≈ôsk√Ω h√°ƒçek', itemB: 'Ochrann√© br√Ωle' },
  '4-4': { name: 'Kan√°ln√≠k', itemA: 'Piln√≠k na ≈æelezo', itemB: 'Nit, c√≠vka' },
  '4-5': { name: '≈Ωal√°≈ôn√≠k', itemA: '≈òetƒõz, 15 cm', itemB: 'Kop√≠ (tƒõ≈æk√°, k10)' },
  '4-6': { name: 'Pƒõstitel hub', itemA: 'Su≈°en√© houby (z√°soby)', itemB: 'Maska proti sp√≥r√°m' },
  '5-1': { name: 'Stavitel hr√°z√≠', itemA: 'Lopata', itemB: 'D≈ôevƒõn√© kl√≠ny' },
  '5-2': { name: 'Kartograf', itemA: 'Brk a inkoust', itemB: 'Kompas' },
  '5-3': { name: 'Vykradaƒç pastiƒçek', itemA: 'Kus s√Ωra', itemB: 'Lepidlo' },
  '5-4': { name: 'Tul√°k', itemA: 'Stan', itemB: 'Mapa k pokladu, pochybn√°' },
  '5-5': { name: 'Pƒõstitel obil√≠', itemA: 'Kop√≠ (tƒõ≈æk√°, k10)', itemB: 'P√≠≈°≈•alka' },
  '5-6': { name: 'Posl√≠ƒçek', itemA: 'Deka', itemB: 'Dokumenty, zapeƒçetƒõn√©' },
  '6-1': { name: 'Trubad√∫r', itemA: 'Hudebn√≠ n√°stroj', itemB: 'Maskovac√≠ sada' },
  '6-2': { name: 'Hazardn√≠ hr√°ƒç', itemA: 'Zat√≠≈æen√© kostky', itemB: 'Zrc√°tko' },
  '6-3': { name: 'Sbƒõraƒç m√≠zy', itemA: 'Vƒõdro', itemB: 'D≈ôevƒõn√© kl√≠ny' },
  '6-4': { name: 'Vƒçela≈ô', itemA: 'Sklenice medu', itemB: 'S√≠≈•' },
  '6-5': { name: 'Knihovn√≠k', itemA: '√ötr≈æek ze starod√°vn√© knihy', itemB: 'Brk a inkoust' },
  '6-6': { name: 'Zchudl√Ω ≈°lechtic', itemA: 'Plstƒõn√Ω klobouk', itemB: 'Parf√©m' }
};

// Poƒç√°teƒçn√≠ zbranƒõ k v√Ωbƒõru
const STARTING_WEAPONS = [
  { name: 'Jehla', damage: 'k6', weight: 'light', slots: 1 },
  { name: 'D√Ωka', damage: 'k6', weight: 'light', slots: 1 },
  { name: 'H≈Øl', damage: 'k6', weight: 'light', slots: 1 },
  { name: 'Meƒç', damage: 'k6/k8', weight: 'medium', slots: 1 },
  { name: 'Sekera', damage: 'k6/k8', weight: 'medium', slots: 1 },
  { name: 'Kladivo', damage: 'k6/k8', weight: 'medium', slots: 1 },
  { name: 'Kop√≠', damage: 'k10', weight: 'heavy', slots: 2 },
  { name: 'H√°k', damage: 'k10', weight: 'heavy', slots: 2 }
];

// Backward compatibility aliases
const FIRST_NAMES = [...MALE_FIRST_NAMES, ...FEMALE_FIRST_NAMES];
const LAST_NAMES = FAMILY_NAMES.map(f => f.male);
const PHYSICAL_DETAILS = Object.values(DISTINCTIVE_FEATURES);

const NPC_QUIRKS = [
  'Mluv√≠ ve t≈ôet√≠ osobƒõ', 'Sb√≠r√° leskl√© vƒõci', 'Neust√°le si opakuje pl√°ny', 'M√° tajn√©ho mazl√≠ƒçka',
  'Vƒõ≈ô√≠ v prastar√© proroctv√≠', 'Nikdy nemluv√≠ o minulosti', 'Je posedl√Ω s√Ωrem', 'Cituje b√°snƒõ',
  'M√° strach z koƒçek', 'Je p≈ôehnanƒõ optimistick√Ω', 'Ned≈Øvƒõ≈ôuje cizinc≈Øm', 'Je z√°visl√Ω na hazardu',
  'Shroma≈æƒèuje recepty', 'Je tajnƒõ zamilovan√Ω', 'Hled√° ztracen√©ho p≈ô√≠buzn√©ho', 'M√° tajnou identitu',
  'Je b√Ωval√Ω pir√°t', 'Sly≈°√≠ hlasy', 'Je mistr p≈ôevlek≈Ø', 'Neum√≠ lh√°t'
];

const NPC_GOALS = [
  'Naj√≠t vz√°cnou bylinu', 'Pomst√≠t starou k≈ôivdu', 'Otev≈ô√≠t vlastn√≠ obchod', 'Osvobodit vƒõznƒõn√©ho p≈ô√≠tele',
  'Objevit ztracen√© mƒõsto', 'Zniƒçit nebezpeƒçn√Ω artefakt', 'Naj√≠t l√©ƒçbu nemoci', 'Doruƒçit d≈Øle≈æitou zpr√°vu',
  'Uniknout pron√°sledovatel≈Øm', 'Z√≠skat uzn√°n√≠', 'Splatit dluh', 'Ochr√°nit rodinu',
  'Odhalit pravdu o minulosti', 'Naj√≠t smysl ≈æivota', 'Vytvo≈ôit mistrovsk√© d√≠lo', 'Z√≠skat moc',
  'Naj√≠t domov', 'P≈ôekonat strach', 'Vyl√©ƒçit proklet√≠', 'Zalo≈æit dynastii'
];

const DUNGEON_THEMES = [
  'Opu≈°tƒõn√Ω d≈Øl', 'Prastar√Ω chr√°m', 'Kanalizaƒçn√≠ syst√©m', 'S√≠≈• ko≈ôen≈Ø', 'Dut√Ω strom',
  'Zdi lidsk√©ho domu', 'Podzemn√≠ ≈ô√≠ƒçn√≠ jeskynƒõ', 'Hmyz√≠ √∫l', 'Opu≈°tƒõn√© ptaƒç√≠ hn√≠zdo', 'Houbov√Ω les',
  'Zamrzl√° dutina', 'Zatopen√Ω sklep', 'Star√© hodinov√© √∫stroj√≠', 'Tunely v kompostu', 'Praskliny v kamenn√© zdi',
  'Kostnice', 'Zapomenut√° sp√≠≈æ', 'Zahradn√≠ k≈Ølna', 'V√≠l√≠ mohyla', 'Prostor mezi svƒõty'
];

const DUNGEON_DENIZENS = [
  'Havƒõ≈• (brouci, stono≈æky)', 'Nep≈ô√°telsk√© krysy', 'Pavouci', 'Duchov√©', 'Nep≈ô√°telsk√© v√≠ly',
  'Kultist√©', 'Bandit√©', 'Divok√° zv√≠≈ôata', 'O≈æivl√© p≈ôedmƒõty', 'Unik√°tn√≠ stvo≈ôen√≠'
];

const CONDITIONS = [
  { id: 'exhausted', name: 'Vyƒçerpan√Ω', effect: 'Nev√Ωhoda na fyzick√© hody' },
  { id: 'frightened', name: 'Vystra≈°en√Ω', effect: 'Mus√≠ prchat od zdroje' },
  { id: 'poisoned', name: 'Otr√°ven√Ω', effect: '1 po≈°kozen√≠ za kolo, nelze l√©ƒçit' },
  { id: 'drained', name: 'Vys√°t√Ω', effect: 'Nem≈Ø≈æe ses√≠lat kouzla' },
  { id: 'stunned', name: 'Omr√°ƒçen√Ω', effect: 'P≈ôeskoƒç√≠ dal≈°√≠ akci' },
  { id: 'prone', name: 'Na zemi', effect: 'Nev√Ωhoda na √∫toky, snadnƒõj≈°√≠ c√≠l' }
];

const SPELLS = [
  { id: 'invisibility', name: 'Neviditelnost', effect: 'Sta≈à se neviditeln√Ωm na 1 kolo', range: 'Dotyk' },
  { id: 'heal', name: 'L√©ƒçen√≠', effect: 'Obnov 1d6 STR', range: 'Dotyk' },
  { id: 'light', name: 'Svƒõtlo', effect: 'Vytvo≈ô svƒõtlo jako sv√≠ƒçka na 1 hodinu', range: 'Dotyk' },
  { id: 'darkness', name: 'Tma', effect: 'Vytvo≈ô magickou tmu v oblasti', range: '10 stop' },
  { id: 'charm', name: 'Okouzlen√≠', effect: 'C√≠l tƒõ pova≈æuje za p≈ô√≠tele', range: '30 stop' },
  { id: 'sleep', name: 'Sp√°nek', effect: 'Uspi 1d6 HD stvo≈ôen√≠', range: '30 stop' },
  { id: 'fireball', name: 'Ohniv√° koule', effect: '2d6 ohniv√© po≈°kozen√≠ v oblasti', range: '60 stop' },
  { id: 'shield', name: '≈†t√≠t', effect: '+2 armor do konce boje', range: 'Sebe' },
  { id: 'fear', name: 'Strach', effect: 'C√≠l mus√≠ ut√©ct na 1d4 kol', range: '30 stop' },
  { id: 'illusion', name: 'Iluze', effect: 'Vytvo≈ô p≈ôesvƒõdƒçiv√Ω obraz', range: '60 stop' }
];

// --- UTILITY FUNCTIONS ---

// ============================================
// SAVE VERSION & MIGRATION SYSTEM
// ============================================
// Increment this when save format changes!
const SAVE_VERSION = 3;

// Migration functions - each upgrades from version N to N+1
const migrations = {
  // v1 -> v2: Single character to parties system
  1: (data) => {
    if (data.character && !data.parties) {
      const newId = Math.random().toString(36).substr(2, 9);
      const party = {
        id: newId,
        name: 'Dru≈æina',
        members: [{ ...data.character, id: data.character.id || Math.random().toString(36).substr(2, 9) }],
        gameTime: data.gameTime || { watch: 0, day: 1, week: 1, season: 'spring', totalWatches: 0 },
        createdAt: new Date().toISOString()
      };
      return {
        ...data,
        version: 2,
        parties: [party],
        activePartyId: party.id,
        activeCharacterId: party.members[0].id
      };
    }
    return { ...data, version: 2 };
  },
  
  // v2 -> v3: Added settlements and worldNPCs
  2: (data) => {
    return {
      ...data,
      version: 3,
      settlements: data.settlements || [],
      worldNPCs: data.worldNPCs || []
    };
  }
  
  // Future migrations go here:
  // 3: (data) => { ... return { ...data, version: 4, newField: [] }; }
};

// Main migration function - applies all needed migrations
const migrateSaveData = (data) => {
  let currentData = { ...data };
  let version = data.version || 1; // Old saves without version are v1
  
  // Apply migrations one by one until we reach current version
  while (version < SAVE_VERSION) {
    if (migrations[version]) {
      console.log(`Migrating save from v${version} to v${version + 1}`);
      currentData = migrations[version](currentData);
      version = currentData.version;
    } else {
      console.warn(`No migration found for v${version}, skipping to v${SAVE_VERSION}`);
      currentData.version = SAVE_VERSION;
      break;
    }
  }
  
  // Ensure all expected fields exist with defaults
  return {
    version: SAVE_VERSION,
    parties: currentData.parties || [],
    activePartyId: currentData.activePartyId || null,
    activeCharacterId: currentData.activeCharacterId || null,
    journal: currentData.journal || [],
    factions: currentData.factions || [],
    settlements: currentData.settlements || [],
    worldNPCs: currentData.worldNPCs || [],
    // Preserve any extra data for forward compatibility
    _extra: Object.keys(currentData)
      .filter(k => !['version', 'parties', 'activePartyId', 'activeCharacterId', 'journal', 'factions', 'settlements', 'worldNPCs', 'exportDate', 'character', 'gameTime'].includes(k))
      .reduce((acc, k) => ({ ...acc, [k]: currentData[k] }), {})
  };
};

// ============================================
// UTILITY FUNCTIONS
// ============================================

const rollDice = (count, sides) => {
  const results = [];
  for (let i = 0; i < count; i++) {
    results.push(Math.floor(Math.random() * sides) + 1);
  }
  return results;
};

const rollD6 = () => rollDice(1, 6)[0];
const rollD20 = () => rollDice(1, 20)[0];
const roll2D6 = () => { const r = rollDice(2, 6); return { dice: r, total: r[0] + r[1] }; };

const randomFrom = (arr) => arr[Math.floor(Math.random() * arr.length)];

const generateId = () => Math.random().toString(36).substr(2, 9);

const formatTimestamp = () => new Date().toLocaleString('cs-CZ');

// --- COMPONENTS ---

// Dice Display Component
const DiceDisplay = ({ dice, size = 'normal' }) => {
  const sizeClass = size === 'large' ? 'text-3xl w-14 h-14' : 'text-xl w-10 h-10';
  return (
    <div className="flex gap-2 justify-center">
      {dice.map((d, i) => (
        <div key={i} className={`${sizeClass} bg-amber-100 border-2 border-amber-900 rounded-lg flex items-center justify-center font-bold text-amber-900 shadow-md transform rotate-${Math.floor(Math.random() * 6) - 3}`}>
          {d}
        </div>
      ))}
    </div>
  );
};

// Result Badge Component  
const ResultBadge = ({ result, variant = 'default' }) => {
  const variants = {
    yes: 'bg-green-700 text-green-100',
    no: 'bg-red-800 text-red-100',
    mixed: 'bg-amber-600 text-amber-100',
    default: 'bg-stone-700 text-stone-100'
  };
  
  let v = variant;
  if (result?.toLowerCase().includes('yes')) v = 'yes';
  else if (result?.toLowerCase().includes('no')) v = 'no';
  else if (result?.includes('...') || result?.includes('but')) v = 'mixed';
  
  return (
    <span className={`px-4 py-2 rounded-full font-bold text-lg ${variants[v]} shadow-lg`}>
      {result}
    </span>
  );
};

// Section Header Component
const SectionHeader = ({ icon, title, subtitle }) => (
  <div className="mb-6 border-b-2 border-amber-900/30 pb-4">
    <h2 className="text-2xl font-bold text-amber-900 flex items-center gap-3">
      <span className="text-3xl">{icon}</span>
      {title}
    </h2>
    {subtitle && <p className="text-stone-600 mt-1 ml-11">{subtitle}</p>}
  </div>
);

// Card Component for results
const ResultCard = ({ title, children, className = '' }) => (
  <div className={`bg-amber-50/80 border-2 border-amber-900/20 rounded-xl p-5 shadow-lg ${className}`}>
    {title && <h3 className="font-bold text-amber-900 mb-3 text-lg border-b border-amber-900/20 pb-2">{title}</h3>}
    {children}
  </div>
);

// Button Component
const Button = ({ onClick, children, variant = 'primary', size = 'normal', disabled = false, className = '' }) => {
  const variants = {
    primary: 'bg-amber-800 hover:bg-amber-900 text-amber-50 border-amber-950',
    secondary: 'bg-stone-600 hover:bg-stone-700 text-stone-50 border-stone-800',
    danger: 'bg-red-800 hover:bg-red-900 text-red-50 border-red-950',
    success: 'bg-green-700 hover:bg-green-800 text-green-50 border-green-900',
    ghost: 'bg-transparent hover:bg-amber-100 text-amber-900 border-amber-300'
  };
  
  const sizes = {
    small: 'px-3 py-1.5 text-sm',
    normal: 'px-5 py-2.5',
    large: 'px-7 py-3 text-lg'
  };
  
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`${variants[variant]} ${sizes[size]} font-bold rounded-lg border-2 shadow-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 ${className}`}
    >
      {children}
    </button>
  );
};


// Tooltip Component - shows help on hover/click
const Tooltip = ({ children }) => {
  const [show, setShow] = useState(false);
  const timeoutRef = useRef(null);
  
  const handleEnter = () => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current);
    setShow(true);
  };
  
  const handleLeave = () => {
    timeoutRef.current = setTimeout(() => setShow(false), 150);
  };
  
  return (
    <div 
      className="relative inline-block"
      onMouseEnter={handleEnter}
      onMouseLeave={handleLeave}
    >
      <button
        onClick={() => setShow(!show)}
        className="w-5 h-5 rounded-full bg-amber-200 hover:bg-amber-300 text-amber-800 text-xs font-bold flex items-center justify-center transition-colors cursor-help"
      >
        ?
      </button>
      {show && (
        <div className="fixed inset-0 z-40 bg-transparent" onClick={() => setShow(false)} />
      )}
      {show && (
        <div 
          className="absolute left-0 top-full mt-2 z-50 w-72 bg-stone-800 text-stone-100 text-sm rounded-lg shadow-xl border border-stone-600"
          style={{ maxHeight: '24rem', overflow: 'hidden' }}
          onMouseEnter={handleEnter}
          onMouseLeave={handleLeave}
        >
          {/* Scrollable content - scrollbar pushed outside visible area */}
          <div 
            className="p-3 overflow-y-scroll"
            style={{ 
              maxHeight: '24rem',
              marginRight: '-20px',
              paddingRight: '20px'
            }}
          >
            {children}
          </div>
        </div>
      )}
    </div>
  );
};

// Help Section Header with tooltip
const HelpHeader = ({ title, tooltip, icon }) => (
  <div className="flex items-center gap-2 mb-2">
    {icon && <span>{icon}</span>}
    <span className="font-bold text-amber-900">{title}</span>
    {tooltip && <Tooltip>{tooltip}</Tooltip>}
  </div>
);

// ============================================
// HOW TO PLAY PANEL
// ============================================

const HowToPlayPanel = () => {
  const [activeSection, setActiveSection] = useState('basics');

  const sections = [
    { id: 'basics', label: 'Z√°klady', icon: 'üìñ' },
    { id: 'workflow', label: 'Workflow', icon: 'üîÑ' },
    { id: 'example', label: 'P≈ô√≠klad hry', icon: 'üéÆ' },
    { id: 'tools', label: 'N√°stroje', icon: 'üß∞' }
  ];

  return (
    <div className="space-y-6">
      <SectionHeader 
        icon="üìö" 
        title="Jak hr√°t solo Mausritter" 
        subtitle="Pr≈Øvodce pro zaƒç√°teƒçn√≠ky i pokroƒçil√©"
      />

      <TabNav tabs={sections} activeTab={activeSection} onTabChange={setActiveSection} />

      {activeSection === 'basics' && (
        <div className="space-y-4">
          <ResultCard title="üê≠ Co je Mausritter?">
            <p className="text-stone-700 mb-3">
              Mausritter je stoln√≠ RPG, kde hraje≈° za malou my≈°ku v nebezpeƒçn√©m svƒõtƒõ. 
              Prozkoum√°v√°≈° opu≈°tƒõn√© lidsk√© domy, bojuje≈° s hmyzem a krysy, hled√°≈° poklady a buduje≈° my≈°√≠ civilizaci.
            </p>
            <p className="text-stone-700">
              <strong>Solo hran√≠</strong> znamen√°, ≈æe hraje≈° s√°m bez Game Mastera. 
              M√≠sto GM pou≈æ√≠v√°≈° <strong>Oracle</strong> (vƒõ≈°t√≠rnu) - syst√©m n√°hodn√Ωch tabulek, 
              kter√© ti pomohou odpov√≠dat na ot√°zky a generovat p≈ô√≠bƒõh.
            </p>
          </ResultCard>

          <ResultCard title="üéØ Z√°kladn√≠ princip solo hran√≠">
            <div className="space-y-3">
              <div className="flex gap-3 items-start">
                <span className="text-2xl">1Ô∏è‚É£</span>
                <div>
                  <p className="font-bold text-amber-900">Polo≈æ ot√°zku</p>
                  <p className="text-stone-600 text-sm">"Jsou v t√©to m√≠stnosti nep≈ô√°tel√©?"</p>
                </div>
              </div>
              <div className="flex gap-3 items-start">
                <span className="text-2xl">2Ô∏è‚É£</span>
                <div>
                  <p className="font-bold text-amber-900">Hoƒè na Oracle</p>
                  <p className="text-stone-600 text-sm">Vyber pravdƒõpodobnost a hoƒè 2d6</p>
                </div>
              </div>
              <div className="flex gap-3 items-start">
                <span className="text-2xl">3Ô∏è‚É£</span>
                <div>
                  <p className="font-bold text-amber-900">Interpretuj v√Ωsledek</p>
                  <p className="text-stone-600 text-sm">"Yes, and..." ‚Üí Ano, a nav√≠c je jich v√≠c ne≈æ ƒçekal!</p>
                </div>
              </div>
              <div className="flex gap-3 items-start">
                <span className="text-2xl">4Ô∏è‚É£</span>
                <div>
                  <p className="font-bold text-amber-900">Vypr√°vƒõj a hraj</p>
                  <p className="text-stone-600 text-sm">Popi≈°, co se dƒõje, a reaguj jako tv√° postava</p>
                </div>
              </div>
            </div>
          </ResultCard>

          <ResultCard title="üí° Kl√≠ƒçov√© tipy">
            <ul className="space-y-2 text-stone-700">
              <li className="flex gap-2">
                <span>‚úì</span>
                <span><strong>Buƒè up≈ô√≠mn√Ω</strong> - pokud je nƒõco pravdƒõpodobn√©, nastav "Likely"</span>
              </li>
              <li className="flex gap-2">
                <span>‚úì</span>
                <span><strong>P≈ôijmi p≈ôekvapen√≠</strong> - neƒçekan√© v√Ωsledky dƒõlaj√≠ p≈ô√≠bƒõh zaj√≠mav√Ωm</span>
              </li>
              <li className="flex gap-2">
                <span>‚úì</span>
                <span><strong>Pi≈° si den√≠k</strong> - pom√°h√° udr≈æet konzistenci p≈ô√≠bƒõhu</span>
              </li>
              <li className="flex gap-2">
                <span>‚úì</span>
                <span><strong>Pou≈æ√≠vej gener√°tory</strong> - kdy≈æ nev√≠≈° co d√°l, hoƒè na tabulky</span>
              </li>
            </ul>
          </ResultCard>
        </div>
      )}

      {activeSection === 'workflow' && (
        <div className="space-y-4">
          <ResultCard title="üîÑ Typick√Ω hern√≠ cyklus">
            <div className="space-y-4">
              <div className="p-4 bg-amber-100 rounded-lg border-l-4 border-amber-600">
                <h4 className="font-bold text-amber-900 mb-2">üìç Zaƒç√°tek session</h4>
                <ol className="list-decimal list-inside text-stone-700 space-y-1 text-sm">
                  <li>Zkontroluj stav postavy (HP, invent√°≈ô, stavy)</li>
                  <li>P≈ôipome≈à si, kde jsi skonƒçil (p≈ôeƒçti posledn√≠ z√°pis)</li>
                  <li>Hoƒè na poƒças√≠ (pokud je nov√Ω den)</li>
                  <li>Hoƒè na Altered Scene (sc√©na se m≈Ø≈æe zmƒõnit)</li>
                </ol>
              </div>

              <div className="p-4 bg-green-100 rounded-lg border-l-4 border-green-600">
                <h4 className="font-bold text-green-900 mb-2">üé≠ Bƒõhem hran√≠</h4>
                <ol className="list-decimal list-inside text-stone-700 space-y-1 text-sm">
                  <li>Popi≈°, co tv√° postava dƒõl√°</li>
                  <li>Kdy≈æ pot≈ôebuje≈° odpovƒõƒè ‚Üí Oracle (Ano/Ne)</li>
                  <li>Kdy≈æ pot≈ôebuje≈° inspiraci ‚Üí Akce+T√©ma nebo karty</li>
                  <li>Kdy≈æ je boj ‚Üí Bojov√Ω tracker</li>
                  <li>Sleduj ƒças (smƒõny na povrchu, turny v dungeonu)</li>
                </ol>
              </div>

              <div className="p-4 bg-blue-100 rounded-lg border-l-4 border-blue-600">
                <h4 className="font-bold text-blue-900 mb-2">üèÅ Konec session</h4>
                <ol className="list-decimal list-inside text-stone-700 space-y-1 text-sm">
                  <li>Zapi≈° shrnut√≠ do den√≠ku</li>
                  <li>Aktualizuj XP a pips</li>
                  <li>Hoƒè na faction progress (pokud uplynul t√Ωden)</li>
                  <li>Poznaƒç si "cliffhanger" - kde p≈ô√≠bƒõh skonƒçil</li>
                </ol>
              </div>
            </div>
          </ResultCard>

          <ResultCard title="‚ùì Kdy pou≈æ√≠vat kter√Ω n√°stroj?">
            <div className="grid gap-3 text-sm">
              <div className="p-3 bg-amber-50 rounded-lg">
                <p className="font-bold text-amber-900">üîÆ Oracle Ano/Ne</p>
                <p className="text-stone-600">"Jsou tu str√°≈æe?" "Vƒõ≈ô√≠ mi?" "Je dve≈ôe zamƒçen√©?"</p>
              </div>
              <div className="p-3 bg-amber-50 rounded-lg">
                <p className="font-bold text-amber-900">üí° Akce + T√©ma</p>
                <p className="text-stone-600">"Co NPC chce?" "Co najdu v truhle?" "Proƒç je tu ticho?"</p>
              </div>
              <div className="p-3 bg-amber-50 rounded-lg">
                <p className="font-bold text-amber-900">üÉè Karty</p>
                <p className="text-stone-600">"Jak√° je n√°lada sc√©ny?" "Co motivuje tohoto nep≈ô√≠tele?"</p>
              </div>
              <div className="p-3 bg-amber-50 rounded-lg">
                <p className="font-bold text-amber-900">‚ö° Komplikace</p>
                <p className="text-stone-600">Kdy≈æ hod√≠≈° "No, but..." nebo pot≈ôebuje≈° twist</p>
              </div>
            </div>
          </ResultCard>
        </div>
      )}

      {activeSection === 'example' && (
        <div className="space-y-4">
          <ResultCard title="üéÆ Uk√°zka solo hran√≠">
            <div className="space-y-4 text-sm">
              <div className="p-3 bg-stone-100 rounded-lg">
                <p className="text-stone-500 text-xs mb-1">SITUACE</p>
                <p className="italic text-stone-700">
                  Anise Butterball stoj√≠ p≈ôed vchodem do star√©ho lidsk√©ho domu. 
                  Sly≈°ela, ≈æe uvnit≈ô je ztracen√Ω artefakt my≈°√≠ osady.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg border-l-4 border-amber-500">
                <p className="text-amber-800 font-medium mb-1">üé≤ Hr√°ƒç se pt√° Oracle:</p>
                <p className="italic">"Je vchod hl√≠dan√Ω?" (Even odds)</p>
                <p className="font-bold mt-1">Hod: [4, 3] = 7 ‚Üí "Yes"</p>
              </div>

              <div className="p-3 bg-stone-100 rounded-lg">
                <p className="text-stone-500 text-xs mb-1">INTERPRETACE</p>
                <p className="italic text-stone-700">
                  Ano, u vchodu sed√≠ velk√Ω brouk. Vypad√° ospal√Ω, ale blokuje cestu.
                </p>
              </div>

              <div className="p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                <p className="text-green-800 font-medium mb-1">üí° Hr√°ƒç pot≈ôebuje detail - Akce+T√©ma:</p>
                <p className="font-bold">"Protect + Food"</p>
                <p className="text-sm mt-1">Brouk hl√≠d√° z√°soby j√≠dla! To d√°v√° smysl.</p>
              </div>

              <div className="p-3 bg-stone-100 rounded-lg">
                <p className="text-stone-500 text-xs mb-1">ROZHODNUT√ç</p>
                <p className="italic text-stone-700">
                  Anise se rozhodne brouka obej√≠t. Zkus√≠ se propl√≠≈æit kolem...
                </p>
              </div>

              <div className="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                <p className="text-blue-800 font-medium mb-1">üéØ DEX save k propl√≠≈æen√≠:</p>
                <p>Hod d20 vs DEX defense (14)</p>
                <p className="font-bold mt-1">Hod: 11 ‚Üí √öspƒõch! Anise se propl√≠≈æ√≠.</p>
              </div>

              <div className="p-3 bg-purple-50 rounded-lg">
                <p className="text-purple-800 font-medium mb-1">‚è±Ô∏è ƒåas plyne:</p>
                <p className="text-sm">Vstup do dungeonu ‚Üí Zapni Dungeon Mode, +1 turn</p>
              </div>
            </div>
          </ResultCard>

          <ResultCard title="üìù Jak by vypadal z√°pis v den√≠ku">
            <div className="p-4 bg-amber-50 rounded-lg font-serif italic text-stone-700">
              <p className="mb-2">
                <strong>Session 1 - Star√Ω lidsk√Ω d≈Øm</strong>
              </p>
              <p className="mb-2">
                Dorazila jsem k domu za soumraku. U vchodu hl√≠dkoval velk√Ω brouk - 
                z≈ôejmƒõ st≈ôe≈æil z√°soby uvnit≈ô. Poda≈ôilo se mi ho obej√≠t nepozorovanƒõ.
              </p>
              <p>
                Uvnit≈ô je tma a zatuchl√Ω vzduch. Zap√°lila jsem pochode≈à. 
                Co mƒõ ƒçek√° v hlubin√°ch?
              </p>
            </div>
          </ResultCard>
        </div>
      )}

      {activeSection === 'tools' && (
        <div className="space-y-4">
          <ResultCard title="üß∞ P≈ôehled n√°stroj≈Ø">
            <div className="space-y-3">
              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">üîÆ</span>
                  <span className="font-bold text-amber-900">Vƒõ≈°t√≠rna (Oracle)</span>
                </div>
                <p className="text-stone-600 text-sm">
                  Hlavn√≠ n√°stroj pro odpovƒõdi na ot√°zky. Ano/Ne oracle, 
                  gener√°tor komplikac√≠, Akce+T√©ma pro inspiraci.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">‚öîÔ∏è</span>
                  <span className="font-bold text-amber-900">Boj</span>
                </div>
                <p className="text-stone-600 text-sm">
                  Tracker pro boje. P≈ôidej nep≈ô√°tele, sleduj HP, h√°zej na √∫tok 
                  pomoc√≠ Bernpyle 2d6 syst√©mu.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">üê≠</span>
                  <span className="font-bold text-amber-900">Postava</span>
                </div>
                <p className="text-stone-600 text-sm">
                  Character sheet - atributy, HP, invent√°≈ô, kouzla, stavy. 
                  M≈Ø≈æe≈° vygenerovat n√°hodnou postavu.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">‚è∞</span>
                  <span className="font-bold text-amber-900">ƒåas</span>
                </div>
                <p className="text-stone-600 text-sm">
                  Sledov√°n√≠ smƒõn (na povrchu) a turn≈Ø (v dungeonu). 
                  Automatick√© p≈ôipom√≠nky na pochodnƒõ, j√≠dlo, wandering monsters.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">üåç</span>
                  <span className="font-bold text-amber-900">Svƒõt</span>
                </div>
                <p className="text-stone-600 text-sm">
                  Gener√°tory pro osady, NPC, dungeony a poƒças√≠. 
                  Kdy≈æ pot≈ôebuje≈° rychle vytvo≈ôit obsah.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">üè∞</span>
                  <span className="font-bold text-amber-900">Frakce</span>
                </div>
                <p className="text-stone-600 text-sm">
                  Sledov√°n√≠ skupin ve svƒõtƒõ - jejich c√≠le, zdroje, pokrok. 
                  Svƒõt ≈æije, i kdy≈æ postava sp√≠.
                </p>
              </div>

              <div className="p-3 bg-amber-50 rounded-lg">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-xl">üìñ</span>
                  <span className="font-bold text-amber-900">Den√≠k</span>
                </div>
                <p className="text-stone-600 text-sm">
                  V≈°echny hody a ud√°losti se automaticky loguj√≠. 
                  P≈ôid√°vej vlastn√≠ narativn√≠ z√°pisy.
                </p>
              </div>
            </div>
          </ResultCard>

          <ResultCard title="‚å®Ô∏è Rychl√© tipy">
            <ul className="space-y-2 text-sm text-stone-700">
              <li>‚Ä¢ V≈°echna data se <strong>automaticky ukl√°daj√≠</strong> v prohl√≠≈æeƒçi</li>
              <li>‚Ä¢ <strong>Export</strong> do JSON najde≈° v Den√≠ku</li>
              <li>‚Ä¢ U ka≈æd√©ho n√°stroje je <strong>? ikonka</strong> s n√°povƒõdou</li>
              <li>‚Ä¢ V dungeonu p≈ôepni na <strong>Dungeon Mode</strong> pro poƒç√≠t√°n√≠ turn≈Ø</li>
            </ul>
          </ResultCard>
        </div>
      )}
    </div>
  );
};

// Input Component
const Input = ({ value, onChange, placeholder, type = 'text', className = '' }) => (
  <input
    type={type}
    value={value}
    onChange={(e) => onChange(e.target.value)}
    placeholder={placeholder}
    className={`w-full px-4 py-2.5 bg-amber-50 border-2 border-amber-900/30 rounded-lg focus:outline-none focus:border-amber-700 text-stone-800 placeholder-stone-400 ${className}`}
  />
);

// Select Component
const Select = ({ value, onChange, options, className = '' }) => (
  <select
    value={value}
    onChange={(e) => onChange(e.target.value)}
    className={`px-4 py-2.5 bg-amber-50 border-2 border-amber-900/30 rounded-lg focus:outline-none focus:border-amber-700 text-stone-800 ${className}`}
  >
    {options.map(opt => (
      <option key={opt.value} value={opt.value}>{opt.label}</option>
    ))}
  </select>
);

// Tab Navigation
const TabNav = ({ tabs, activeTab, onTabChange }) => (
  <div className="flex flex-wrap gap-2 mb-6">
    {tabs.map(tab => (
      <button
        key={tab.id}
        onClick={() => onTabChange(tab.id)}
        className={`px-4 py-2 rounded-lg font-bold transition-all duration-200 flex items-center gap-2 ${
          activeTab === tab.id 
            ? 'bg-amber-800 text-amber-50 shadow-lg' 
            : 'bg-amber-100 text-amber-900 hover:bg-amber-200'
        }`}
      >
        <span>{tab.icon}</span>
        <span className="hidden sm:inline">{tab.label}</span>
      </button>
    ))}
  </div>
);

// ============================================
// ORACLE PANEL
// ============================================

const OraclePanel = ({ onLogEntry }) => {
  const [question, setQuestion] = useState('');
  const [probability, setProbability] = useState('even');
  const [lastResult, setLastResult] = useState(null);
  const [activeOracle, setActiveOracle] = useState('yesno');
  const [customDice, setCustomDice] = useState({ count: 1, sides: 6 });
  const [customDiceResult, setCustomDiceResult] = useState(null);
  const [diceReason, setDiceReason] = useState('');

  // Custom dice roller
  const rollCustomDice = () => {
    const results = rollDice(customDice.count, customDice.sides);
    const total = results.reduce((a, b) => a + b, 0);
    const entry = {
      type: 'oracle',
      subtype: 'custom_dice',
      timestamp: formatTimestamp(),
      dice: results,
      sides: customDice.sides,
      count: customDice.count,
      total,
      reason: diceReason || null
    };
    setCustomDiceResult(entry);
    setLastResult(entry);
    onLogEntry(entry);
    setDiceReason(''); // Clear after roll
  };

  const rollYesNo = () => {
    const { dice, total } = roll2D6();
    const result = ORACLE_TABLE[probability][total];
    const entry = {
      type: 'oracle',
      subtype: 'yes_no',
      timestamp: formatTimestamp(),
      question: question || '(Bez ot√°zky)',
      probability,
      dice,
      total,
      result
    };
    setLastResult(entry);
    onLogEntry(entry);
    setQuestion('');
  };

  const rollComplication = () => {
    const die = rollD6();
    const result = SCENE_COMPLICATIONS[die - 1];
    const entry = {
      type: 'oracle',
      subtype: 'complication',
      timestamp: formatTimestamp(),
      dice: [die],
      result
    };
    setLastResult(entry);
    onLogEntry(entry);
  };

  const rollConsequence = () => {
    const die = rollD6();
    const result = FAILURE_CONSEQUENCES[die - 1];
    const entry = {
      type: 'oracle',
      subtype: 'consequence',
      timestamp: formatTimestamp(),
      dice: [die],
      result
    };
    setLastResult(entry);
    onLogEntry(entry);
  };

  const rollAlteredScene = () => {
    const die = rollD6();
    const altered = die >= 5;
    const entry = {
      type: 'oracle',
      subtype: 'altered_scene',
      timestamp: formatTimestamp(),
      dice: [die],
      result: altered ? 'Sc√©na je POZMƒöNƒöNA!' : 'Sc√©na prob√≠h√° podle oƒçek√°v√°n√≠'
    };
    setLastResult(entry);
    onLogEntry(entry);
  };

  const rollActionTheme = () => {
    const action = randomFrom(ACTION_ORACLE);
    const theme = randomFrom(THEME_ORACLE);
    const entry = {
      type: 'oracle',
      subtype: 'action_theme',
      timestamp: formatTimestamp(),
      result: `${action} + ${theme}`,
      action,
      theme
    };
    setLastResult(entry);
    onLogEntry(entry);
  };

  const drawCard = () => {
    const suit = randomFrom(CARD_SUITS);
    const value = randomFrom(CARD_VALUES);
    const entry = {
      type: 'oracle',
      subtype: 'card',
      timestamp: formatTimestamp(),
      suit,
      value,
      meaning: CARD_VALUE_MEANINGS[value],
      result: `${value}${suit.symbol} - ${suit.domain}`
    };
    setLastResult(entry);
    onLogEntry(entry);
  };

  const oracleTabs = [
    { id: 'yesno', label: 'Ano/Ne', icon: 'üé≤' },
    { id: 'dice', label: 'Kostky', icon: 'üéØ' },
    { id: 'scene', label: 'Sc√©na', icon: 'üé≠' },
    { id: 'prompt', label: 'Prompt', icon: 'üí°' },
    { id: 'cards', label: 'Karty', icon: 'üÉè' }
  ];

  return (
    <div className="space-y-6">
      <SectionHeader 
        icon="üîÆ" 
        title="Vƒõ≈°t√≠rna Oracle" 
        subtitle="Nech kostky vypr√°vƒõt p≈ô√≠bƒõh"
      />
      
      <TabNav tabs={oracleTabs} activeTab={activeOracle} onTabChange={setActiveOracle} />

      {activeOracle === 'yesno' && (
        <ResultCard>
          <HelpHeader 
            title="Yes/No Oracle" 
            icon="üé≤"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Kdy≈æ si nejsi jist√Ω, co se stane, zeptej se Oracle! Funguje jako neutr√°ln√≠ rozhodƒç√≠, kter√Ω ti pom≈Ø≈æe vypr√°vƒõt p≈ô√≠bƒõh.</p>
                
                <p className="font-bold mb-1">üìù Jak na to:</p>
                <ol className="list-decimal list-inside space-y-1 text-xs mb-2">
                  <li><b>Polo≈æ ot√°zku</b> - mus√≠ j√≠t odpovƒõdƒõt ano/ne (nap≈ô. "Je str√°≈æ vzh≈Øru?")</li>
                  <li><b>Vyber pravdƒõpodobnost</b> - podle toho co d√°v√° smysl v p≈ô√≠bƒõhu</li>
                  <li><b>Hoƒè</b> - a interpretuj v√Ωsledek</li>
                </ol>
                
                <p className="font-bold mb-1">üé≤ V√Ωsledky:</p>
                <ul className="text-xs space-y-1">
                  <li><b>Ne</b> = prostƒõ ne</li>
                  <li><b>Ne, ale...</b> = ne, ale nƒõco pozitivn√≠ho (nap≈ô. str√°≈æ sp√≠, ale chrupe)</li>
                  <li><b>Ano</b> = prostƒõ ano</li>
                  <li><b>Ano, a...</b> = ano a nƒõco extra (nap≈ô. str√°≈æ sp√≠ A m√° u sebe kl√≠ƒç)</li>
                </ul>
                
                <p className="text-xs text-stone-300 mt-2 italic">
                  üí° Tip: Kdy≈æ dostane≈° "ale/a", hoƒè na Komplikace nebo Prompt pro inspiraci!
                </p>
              </div>
            }
          />
          <div className="space-y-4">
            <Input 
              value={question}
              onChange={setQuestion}
              placeholder="Zadej ot√°zku pro oracle..."
            />
            
            <div className="flex flex-wrap gap-2">
              {['unlikely', 'even', 'likely'].map(prob => (
                <button
                  key={prob}
                  onClick={() => setProbability(prob)}
                  className={`px-4 py-2 rounded-lg font-bold transition-all ${
                    probability === prob
                      ? 'bg-amber-700 text-amber-50'
                      : 'bg-amber-100 text-amber-900 hover:bg-amber-200'
                  }`}
                >
                  {prob === 'unlikely' ? '‚¨áÔ∏è Nepravdƒõpodobn√©' : prob === 'likely' ? '‚¨ÜÔ∏è Pravdƒõpodobn√©' : '‚û°Ô∏è Rovn√© ≈°ance'}
                </button>
              ))}
            </div>
            
            <Button onClick={rollYesNo} size="large" className="w-full">
              üé≤ Hodit 2d6
            </Button>
          </div>
        </ResultCard>
      )}

      {activeOracle === 'dice' && (
        <ResultCard>
          <HelpHeader 
            title="Hod kostkou" 
            icon="üéØ"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Univerz√°ln√≠ kostky pro cokoliv! Pou≈æ√≠vej kdy≈æ hraje≈° p≈ôipraven√© dobrodru≈æstv√≠ s vlastn√≠mi tabulkami.</p>
                
                <p className="font-bold mb-1">üìù P≈ô√≠klady pou≈æit√≠:</p>
                <ul className="text-xs space-y-1 mb-2">
                  <li>‚Ä¢ <b>Random encounter</b> - dobrodru≈æstv√≠ ≈ô√≠k√° "hoƒè d8 na tabulku setk√°n√≠"</li>
                  <li>‚Ä¢ <b>Loot/poklad</b> - "hoƒè d6 co najde≈° v truhle"</li>
                  <li>‚Ä¢ <b>NPC reakce</b> - 2d6 na reakƒçn√≠ tabulku</li>
                  <li>‚Ä¢ <b>Dungeon room</b> - d20 na obsah m√≠stnosti</li>
                </ul>
                
                <p className="font-bold mb-1">‚ö° Rychl√© tlaƒç√≠tka:</p>
                <p className="text-xs text-stone-300">Klikni na d4/d6/d8/d10/d12/d20 pro okam≈æit√Ω hod jednou kostkou.</p>
                
                <p className="font-bold mb-1 mt-2">üé≤ Vlastn√≠ hod:</p>
                <p className="text-xs text-stone-300">Vyber poƒçet kostek a typ (nap≈ô. 3d6, 2d10, 1d100) pro slo≈æitƒõj≈°√≠ hody.</p>
              </div>
            }
          />
          
          {/* Quick dice buttons */}
          <div className="mb-4">
            <div className="text-sm text-stone-600 mb-2">Rychl√Ω hod:</div>
            <div className="flex flex-wrap gap-2">
              {[4, 6, 8, 10, 12, 20].map(sides => (
                <button
                  key={sides}
                  onClick={() => {
                    const result = rollDice(1, sides)[0];
                    const entry = {
                      type: 'oracle', subtype: 'custom_dice', timestamp: formatTimestamp(),
                      dice: [result], sides, count: 1, total: result
                    };
                    setCustomDiceResult(entry);
                    setLastResult(entry);
                    onLogEntry(entry);
                  }}
                  className="px-4 py-3 bg-amber-100 hover:bg-amber-200 rounded-lg font-bold text-amber-900 transition-colors min-w-[60px]"
                >
                  d{sides}
                </button>
              ))}
            </div>
          </div>

          {/* Custom dice config */}
          <div className="p-3 bg-stone-100 rounded-lg mb-4">
            <div className="text-sm text-stone-600 mb-2">Vlastn√≠ hod:</div>
            <div className="flex items-center gap-2 flex-wrap mb-3">
              <select
                value={customDice.count}
                onChange={(e) => setCustomDice({ ...customDice, count: parseInt(e.target.value) })}
                className="px-3 py-2 rounded border border-stone-300 bg-white font-bold"
              >
                {[1, 2, 3, 4, 5, 6].map(n => (
                  <option key={n} value={n}>{n}</option>
                ))}
              </select>
              <span className="font-bold text-stone-600">d</span>
              <input
                type="number"
                min="2"
                max="1000"
                value={customDice.sides}
                onChange={(e) => setCustomDice({ ...customDice, sides: parseInt(e.target.value) || 6 })}
                className="px-3 py-2 rounded border border-stone-300 bg-white font-bold w-20"
              />
            </div>
            <div className="flex items-center gap-2">
              <input
                type="text"
                value={diceReason}
                onChange={(e) => setDiceReason(e.target.value)}
                placeholder="Na co h√°z√≠≈°? (nap≈ô. test S√çL, √∫tok...)"
                className="flex-1 px-3 py-2 rounded border border-stone-300 bg-white"
                onKeyDown={(e) => e.key === 'Enter' && rollCustomDice()}
              />
              <Button onClick={rollCustomDice}>
                üé≤ Hodit
              </Button>
            </div>
          </div>

          {/* Result */}
          {customDiceResult && (
            <div className="p-4 bg-amber-50 rounded-lg border-2 border-amber-300">
              <div className="flex items-center justify-between mb-2">
                <span className="text-stone-600">{customDiceResult.count}d{customDiceResult.sides}</span>
                <span className="text-xs text-stone-400">{customDiceResult.timestamp}</span>
              </div>
              {customDiceResult.reason && (
                <p className="text-stone-700 font-medium mb-2">{customDiceResult.reason}</p>
              )}
              <div className="flex items-center gap-3">
                <DiceDisplay dice={customDiceResult.dice} size="large" />
                {customDiceResult.count > 1 && (
                  <div className="text-3xl font-bold text-amber-700">= {customDiceResult.total}</div>
                )}
              </div>
            </div>
          )}
        </ResultCard>
      )}

      {activeOracle === 'scene' && (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <ResultCard>
            <HelpHeader 
              title="Altered Scene" 
              icon="üìú"
              tooltip={
                <div>
                  <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                  <p className="text-xs mb-2">Zabra≈àuje p≈ôedv√≠datelnosti! Ne≈æ zaƒçne≈° novou sc√©nu, hoƒè a zjisti, jestli se vƒõci vyvinuly jinak, ne≈æ jsi ƒçekal.</p>
                  
                  <p className="font-bold mb-1">üìù Kdy h√°zet:</p>
                  <ul className="text-xs space-y-1 mb-2">
                    <li>‚Ä¢ Na zaƒç√°tku ka≈æd√© nov√© sc√©ny</li>
                    <li>‚Ä¢ Kdy≈æ se p≈ôesune≈° na nov√© m√≠sto</li>
                    <li>‚Ä¢ Kdy≈æ uplyne ƒças a vrac√≠≈° se nƒõkam</li>
                  </ul>
                  
                  <p className="font-bold mb-1">üé≤ V√Ωsledky:</p>
                  <ul className="text-xs space-y-1">
                    <li><b>1-4:</b> Sc√©na prob√≠h√° jak jsi oƒçek√°val</li>
                    <li><b>5-6:</b> Nƒõco je jinak! Hoƒè na Komplikace pro inspiraci</li>
                  </ul>
                  
                  <p className="text-xs text-stone-300 mt-2 italic">
                    üí° P≈ô√≠klad: Jde≈° do hostince pro info ‚Üí hod√≠≈° 6 ‚Üí hostinec ho≈ô√≠! Co se stalo?
                  </p>
                </div>
              }
            />
            <p className="text-sm text-stone-600 mb-3">Hoƒè na zaƒç√°tku sc√©ny (5-6 = zmƒõna)</p>
            <Button onClick={rollAlteredScene} className="w-full">Hodit d6</Button>
          </ResultCard>
          
          <ResultCard>
            <HelpHeader 
              title="Komplikace" 
              icon="‚ö°"
              tooltip={
                <div>
                  <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                  <p className="text-xs mb-2">Generuje neƒçekan√© zvraty a p≈ôek√°≈æky. Dƒõl√° p≈ô√≠bƒõh zaj√≠mavƒõj≈°√≠!</p>
                  
                  <p className="font-bold mb-1">üìù Kdy h√°zet:</p>
                  <ul className="text-xs space-y-1 mb-2">
                    <li>‚Ä¢ Po "Ne, ale..." nebo "Ano, ale..." z Oracle</li>
                    <li>‚Ä¢ Kdy≈æ Altered Scene uk√°≈æe zmƒõnu (5-6)</li>
                    <li>‚Ä¢ Kdykoliv chce≈° p≈ôidat drama</li>
                    <li>‚Ä¢ Kdy≈æ nev√≠≈°, co by se mƒõlo pokazit</li>
                  </ul>
                  
                  <p className="font-bold mb-1">üé≤ Mo≈æn√© v√Ωsledky:</p>
                  <ul className="text-xs space-y-1">
                    <li>‚Ä¢ Nep≈ô√°tel√© se objev√≠</li>
                    <li>‚Ä¢ P≈ôek√°≈æka v cestƒõ</li>
                    <li>‚Ä¢ NPC udƒõl√° nƒõco neƒçekan√©ho</li>
                    <li>‚Ä¢ Nov√° p≈ô√≠le≈æitost</li>
                  </ul>
                  
                  <p className="text-xs text-stone-300 mt-2 italic">
                    üí° Interpretuj v√Ωsledek kreativnƒõ podle situace!
                  </p>
                </div>
              }
            />
            <p className="text-sm text-stone-600 mb-3">Co se pokazilo?</p>
            <Button onClick={rollComplication} className="w-full">Hodit d6</Button>
          </ResultCard>
          
          <ResultCard>
            <HelpHeader 
              title="D≈Øsledek selh√°n√≠" 
              icon="üíÄ"
              tooltip={
                <div>
                  <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                  <p className="text-xs mb-2">Pom√°h√° vytvo≈ôit zaj√≠mav√© n√°sledky selh√°n√≠ m√≠sto nudn√©ho "nepovedlo se, zkus znovu".</p>
                  
                  <p className="font-bold mb-1">üìù Kdy h√°zet:</p>
                  <ul className="text-xs space-y-1 mb-2">
                    <li>‚Ä¢ Kdy≈æ postava neuspƒõje v d≈Øle≈æit√©m hodu</li>
                    <li>‚Ä¢ Kdy≈æ sel≈æe save</li>
                    <li>‚Ä¢ Kdy≈æ nev√≠≈°, jak√Ω trest d√°t za ne√∫spƒõch</li>
                  </ul>
                  
                  <p className="font-bold mb-1">üé≤ Mo≈æn√© d≈Øsledky:</p>
                  <ul className="text-xs space-y-1">
                    <li>‚Ä¢ <b>Po≈°kozen√≠</b> - fyzick√© nebo ment√°ln√≠ zranƒõn√≠</li>
                    <li>‚Ä¢ <b>Nƒõkdo v √∫zk√Ωch</b> - spojenec v nebezpeƒç√≠</li>
                    <li>‚Ä¢ <b>Tƒõ≈æk√° volba</b> - mus√≠≈° nƒõco obƒõtovat</li>
                    <li>‚Ä¢ <b>Nep≈ô√≠tel reaguje</b> - dostane v√Ωhodu</li>
                    <li>‚Ä¢ <b>Odhalen√≠ pravdy</b> - zjist√≠≈° nƒõco nep≈ô√≠jemn√©ho</li>
                    <li>‚Ä¢ <b>Rozdƒõlen√≠</b> - skupina se rozpt√Ωl√≠</li>
                  </ul>
                </div>
              }
            />
            <p className="text-sm text-stone-600 mb-3">Co se stane p≈ôi ne√∫spƒõchu?</p>
            <Button onClick={rollConsequence} className="w-full">Hodit d6</Button>
          </ResultCard>
        </div>
      )}

      {activeOracle === 'prompt' && (
        <ResultCard>
          <HelpHeader 
            title="Akce + T√©ma gener√°tor" 
            icon="üí°"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">N√°hodnƒõ vygeneruje dvojici slov (sloveso + t√©ma), kter√° ti d√° inspiraci kdy≈æ nev√≠≈° co d√°l.</p>
                
                <p className="font-bold mb-1">üìù Kdy pou≈æ√≠t:</p>
                <ul className="text-xs space-y-1 mb-2">
                  <li>‚Ä¢ <b>Co chce NPC?</b> ‚Üí "Protect + Family" = chr√°n√≠ svou rodinu</li>
                  <li>‚Ä¢ <b>Co je v m√≠stnosti?</b> ‚Üí "Hide + Treasure" = ukryt√Ω poklad</li>
                  <li>‚Ä¢ <b>Proƒç se to dƒõje?</b> ‚Üí "Seek + Revenge" = nƒõkdo chce pomstu</li>
                  <li>‚Ä¢ <b>Co se stalo?</b> ‚Üí "Destroy + Bond" = zniƒçen√© p≈ô√°telstv√≠</li>
                  <li>‚Ä¢ <b>Co d√°l?</b> ‚Üí "Discover + Secret" = je t≈ôeba naj√≠t tajemstv√≠</li>
                </ul>
                
                <p className="font-bold mb-1">üí° Jak interpretovat:</p>
                <p className="text-xs text-stone-300">
                  Spoj obƒõ slova do vƒõty nebo my≈°lenky. Buƒè kreativn√≠! V√Ωsledek nemus√≠ d√°vat smysl doslova - hledej asociace a n√°pady.
                </p>
                
                <p className="text-xs text-stone-300 mt-2 italic">
                  Tip: Pokud prvn√≠ hod ned√°v√° smysl, hoƒè znovu nebo kombinuj s p≈ôedchoz√≠m.
                </p>
              </div>
            }
          />
          <div className="space-y-4">
            <p className="text-stone-600">Generuj n√°hodnou inspiraci kombinac√≠ Akce + T√©matu z Ironsworn oracle tabulek.</p>
            <Button onClick={rollActionTheme} size="large" className="w-full">
              üí° Generovat Prompt
            </Button>
          </div>
        </ResultCard>
      )}

      {activeOracle === 'cards' && (
        <ResultCard>
          <HelpHeader 
            title="Karetn√≠ Oracle" 
            icon="üÉè"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Alternativa k Oracle - m√≠sto ano/ne dostane≈° symbolickou odpovƒõƒè, kterou interpretuje≈°.</p>
                
                <p className="font-bold mb-1">üé¥ Barvy (oblast ≈æivota):</p>
                <ul className="text-xs space-y-1 mb-2">
                  <li>‚ô•Ô∏è <b>Srdce</b> = vztahy, emoce, l√°ska, podvod</li>
                  <li>‚ô¶Ô∏è <b>K√°ry</b> = pen√≠ze, obchod, praktick√© vƒõci</li>
                  <li>‚ô£Ô∏è <b>K≈ô√≠≈æe</b> = akce, boj, fyzick√©, pohyb</li>
                  <li>‚ô†Ô∏è <b>Piky</b> = magie, tajemstv√≠, smrt, duchovn√≠</li>
                </ul>
                
                <p className="font-bold mb-1">üî¢ Hodnoty (rozsah):</p>
                <ul className="text-xs space-y-1">
                  <li><b>2-4:</b> Mal√©, osobn√≠</li>
                  <li><b>5-7:</b> St≈ôedn√≠, skupinov√©</li>
                  <li><b>8-10:</b> Velk√©, d≈Øle≈æit√©</li>
                  <li><b>J:</b> Osoba, agent zmƒõny</li>
                  <li><b>Q:</b> Autorita, instituce</li>
                  <li><b>K:</b> Moc, vrchol, vl√°da</li>
                  <li><b>A:</b> ƒåist√° esence, podstata</li>
                </ul>
                
                <p className="text-xs text-stone-300 mt-2 italic">
                  üí° P≈ô√≠klad: 7‚ô† = "Velk√© tajemstv√≠" nebo "V√Ωznamn√° magie"
                </p>
              </div>
            }
          />
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4 text-sm">
              {CARD_SUITS.map(suit => (
                <div key={suit.symbol} className="p-3 bg-amber-100/50 rounded-lg">
                  <span className="text-2xl">{suit.symbol}</span>
                  <span className="font-bold ml-2">{suit.name}</span>
                  <p className="text-stone-600 mt-1">{suit.domain}</p>
                </div>
              ))}
            </div>
            <Button onClick={drawCard} size="large" className="w-full">
              üÉè Vyt√°hnout kartu
            </Button>
          </div>
        </ResultCard>
      )}

      {/* Last Result Display */}
      {lastResult && (
        <ResultCard title="üìã Posledn√≠ v√Ωsledek" className="border-amber-500 border-2">
          {lastResult.dice && <DiceDisplay dice={lastResult.dice} size="large" />}
          
          <div className="mt-4 text-center space-y-2">
            {lastResult.question && (
              <p className="text-stone-600 italic">"{lastResult.question}"</p>
            )}
            
            {lastResult.suit && (
              <div className="text-5xl my-4">
                {lastResult.value}{lastResult.suit.symbol}
              </div>
            )}
            
            <ResultBadge result={lastResult.result} />
            
            {lastResult.meaning && (
              <p className="text-stone-600 mt-2">{lastResult.meaning}</p>
            )}
            {lastResult.suit && (
              <p className="text-amber-700 font-medium">{lastResult.suit.keywords}</p>
            )}
          </div>
        </ResultCard>
      )}
    </div>
  );
};

// ============================================
// COMBAT PANEL
// ============================================

const CombatPanel = ({ party, updateCharacterInParty, onLogEntry }) => {
  const [combatants, setCombatants] = useState([]);
  const [currentRound, setCurrentRound] = useState(0);
  const [combatLog, setCombatLog] = useState([]);
  const [attackResult, setAttackResult] = useState(null);
  const [newCombatantName, setNewCombatantName] = useState('');
  const [newCombatantHP, setNewCombatantHP] = useState(4);

  // Add single combatant
  const addCombatant = (isEnemy = true) => {
    if (!newCombatantName) return;
    const newCombatant = {
      id: generateId(),
      name: newCombatantName,
      hp: newCombatantHP,
      maxHp: newCombatantHP,
      str: 6,
      maxStr: 6,
      isEnemy,
      isPartyMember: false,
      conditions: [],
      actedThisRound: false
    };
    setCombatants([...combatants, newCombatant]);
    setNewCombatantName('');
    setNewCombatantHP(4);
  };

  // Add all party members to combat
  const addPartyToCombat = () => {
    if (!party?.members) return;
    
    const partyMembers = party.members.map(member => ({
      id: member.id,
      name: member.name,
      hp: member.hp?.current || 3,
      maxHp: member.hp?.max || 6,
      str: member.STR?.current || member.str || 6,
      maxStr: member.STR?.max || member.maxStr || 6,
      isEnemy: false,
      isPartyMember: true,
      memberId: member.id, // Link back to party member
      conditions: member.conditions || [],
      actedThisRound: false
    }));
    
    // Filter out members already in combat
    const newMembers = partyMembers.filter(pm => 
      !combatants.some(c => c.memberId === pm.memberId)
    );
    
    setCombatants([...combatants, ...newMembers]);
  };

  const removeCombatant = (id) => {
    setCombatants(combatants.filter(c => c.id !== id));
  };

  const startCombat = () => {
    setCurrentRound(1);
    setCombatLog([{ round: 1, message: '‚öîÔ∏è Boj zaƒç√≠n√°!' }]);
    // Roll initiative
    const withInitiative = combatants.map(c => ({
      ...c,
      initiative: rollD20(),
      actedThisRound: false
    })).sort((a, b) => b.initiative - a.initiative);
    setCombatants(withInitiative);
  };

  const nextRound = () => {
    const newRound = currentRound + 1;
    setCurrentRound(newRound);
    setCombatants(combatants.map(c => ({ ...c, actedThisRound: false })));
    setCombatLog([...combatLog, { round: newRound, message: `üîÑ Kolo ${newRound}` }]);
  };

  const endCombat = () => {
    setCurrentRound(0);
    
    // Sync HP back to party members
    combatants.forEach(c => {
      if (c.isPartyMember && c.memberId) {
        updateCharacterInParty(c.memberId, {
          hp: { current: c.hp, max: c.maxHp }
        });
      }
    });
    
    // Roll usage for items
    const usageLog = [];
    if (party?.members) {
      party.members.forEach(member => {
        if (member.inventory) {
          member.inventory.forEach(item => {
            if (item.usageDots !== undefined && (item.name.toLowerCase().includes('zbra≈à') || item.name.toLowerCase().includes('sword') || item.name.toLowerCase().includes('armor') || item.name.toLowerCase().includes('zbroj') || item.name.toLowerCase().includes('≈°t√≠t'))) {
              const roll = rollD6();
              if (roll >= 4) {
                usageLog.push(`${member.name} - ${item.name}: Hod ${roll} - Oznaƒç pou≈æit√≠!`);
              }
            }
          });
        }
      });
    }
    
    if (usageLog.length > 0) {
      setCombatLog([...combatLog, { round: currentRound, message: 'üì¶ Usage rolls:', details: usageLog }]);
    }
    
    onLogEntry({
      type: 'combat_end',
      timestamp: formatTimestamp(),
      rounds: currentRound,
      log: combatLog
    });
    
    // Clear combatants
    setCombatants([]);
  };

  const rollAttack = (attackerId, targetId, weaponDice = 6) => {
    const { dice, total } = roll2D6();
    const hitResult = HIT_TABLE[total];
    
    let damage = 0;
    let damageRolls = [];
    
    switch (hitResult.damageType) {
      case 'none':
        damage = 0;
        break;
      case 'disadvantage':
        damageRolls = rollDice(2, weaponDice);
        damage = Math.min(...damageRolls);
        break;
      case 'normal':
        damageRolls = rollDice(1, weaponDice);
        damage = damageRolls[0];
        break;
      case 'advantage':
        damageRolls = rollDice(2, weaponDice);
        damage = Math.max(...damageRolls);
        break;
      case 'advantage+1':
        damageRolls = rollDice(2, weaponDice);
        damage = Math.max(...damageRolls) + 1;
        break;
      case 'max':
        damage = weaponDice;
        break;
    }

    const attacker = combatants.find(c => c.id === attackerId) || { name: 'Hr√°ƒç' };
    const target = combatants.find(c => c.id === targetId);
    
    const result = {
      attacker: attacker.name,
      target: target?.name || 'C√≠l',
      hitDice: dice,
      hitTotal: total,
      hitResult: hitResult.result,
      effect: hitResult.effect,
      damageRolls,
      damage
    };
    
    setAttackResult(result);
    
    // Apply damage to target
    if (target && damage > 0) {
      const newCombatants = combatants.map(c => {
        if (c.id === targetId) {
          let newHp = c.hp - damage;
          let newStr = c.str;
          let overflow = 0;
          
          if (newHp < 0) {
            overflow = Math.abs(newHp);
            newHp = 0;
            newStr = Math.max(0, c.str - overflow);
          }
          
          return { ...c, hp: newHp, str: newStr };
        }
        return c;
      });
      setCombatants(newCombatants);
    }
    
    setCombatLog([...combatLog, {
      round: currentRound,
      message: `${result.attacker} √∫toƒç√≠ na ${result.target}: ${result.hitResult} (${total}) ‚Üí ${damage} po≈°kozen√≠`
    }]);
    
    onLogEntry({
      type: 'combat_action',
      subtype: 'attack',
      timestamp: formatTimestamp(),
      ...result
    });
  };

  const rollMorale = (combatantId) => {
    const target = combatants.find(c => c.id === combatantId);
    if (!target) return;
    
    const roll = rollD20();
    const success = roll <= (target.wil || 7);
    
    setCombatLog([...combatLog, {
      round: currentRound,
      message: `üèÉ Mor√°lka ${target.name}: d20=${roll} vs WIL=${target.wil || 7} ‚Üí ${success ? 'Dr≈æ√≠ pozici' : 'PRCH√Å!'}`
    }]);
  };

  const updateCombatantHP = (id, delta) => {
    setCombatants(combatants.map(c => 
      c.id === id ? { ...c, hp: Math.max(0, Math.min(c.maxHp, c.hp + delta)) } : c
    ));
  };

  return (
    <div className="space-y-6">
      <SectionHeader 
        icon="‚öîÔ∏è" 
        title="Bojov√Ω tracker" 
        subtitle={currentRound > 0 ? `Kolo ${currentRound}` : 'P≈ôiprav bojovn√≠ky'}
      />

      {/* Add Combatant */}
      <ResultCard>
        <HelpHeader 
          title="P≈ôidat bojovn√≠ka" 
          icon="‚ûï"
          tooltip={
            <div>
              <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
              <p className="text-xs mb-2">P≈ôidej v≈°echny √∫ƒçastn√≠ky boje - my≈°i, nep≈ô√°tele i spojence - p≈ôedt√≠m ne≈æ zaƒçne≈° bojovat.</p>
              
              <p className="font-bold mb-1">üìù Jak na to:</p>
              <ol className="list-decimal list-inside text-xs space-y-1 mb-2">
                <li>Napi≈° jm√©no (nap≈ô. "Krysa #1" nebo "O≈ô√≠≈°ek")</li>
                <li>Nastav HP a p≈ô√≠padnƒõ Armor</li>
                <li>Vyber typ:</li>
              </ol>
              
              <ul className="text-xs space-y-1 mb-2 ml-4">
                <li>üê≠ <b>Hr√°ƒç</b> = tv√° postava (zelen√Ω pruh)</li>
                <li>üêÄ <b>Nep≈ô√≠tel</b> = proti tobƒõ (ƒçerven√Ω pruh)</li>
                <li>üêøÔ∏è <b>Spojenec</b> = NPC na tv√© stranƒõ (modr√Ω pruh)</li>
              </ul>
              
              <p className="text-xs text-stone-300 italic">
                üí° Tip: Pro v√≠ce nep≈ô√°tel stejn√©ho typu je p≈ôidej jednotlivƒõ s ƒç√≠sly (Mravenec #1, #2...)
              </p>
            </div>
          }
        />
        <div className="flex flex-wrap gap-3 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="text-sm text-stone-600 block mb-1">Jm√©no</label>
            <Input 
              value={newCombatantName}
              onChange={setNewCombatantName}
              placeholder="Jm√©no nep≈ô√≠tele..."
            />
          </div>
          <div className="w-24">
            <label className="text-sm text-stone-600 block mb-1">HP</label>
            <Input 
              type="number"
              value={newCombatantHP}
              onChange={(v) => setNewCombatantHP(parseInt(v) || 1)}
            />
          </div>
          <Button onClick={() => addCombatant(true)}>üêÄ Nep≈ô√≠tel</Button>
          <Button onClick={() => addCombatant(false)} variant="secondary">üê≠ Spojenec</Button>
          {party?.members?.length > 0 && (
            <Button onClick={addPartyToCombat} variant="success">
              üèïÔ∏è Cel√° dru≈æina ({party.members.length})
            </Button>
          )}
        </div>
      </ResultCard>

      {/* Combatants List */}
      <ResultCard title="üë• Bojovn√≠ci">
        {combatants.length === 0 ? (
          <p className="text-stone-500 text-center py-4">≈Ω√°dn√≠ bojovn√≠ci. P≈ôidej nƒõkoho v√Ω≈°e.</p>
        ) : (
          <div className="space-y-3">
            {combatants.map(c => (
              <div key={c.id} className={`p-4 rounded-lg border-2 ${c.isEnemy ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300'}`}>
                <div className="flex flex-wrap justify-between items-center gap-3">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">{c.isEnemy ? 'üêÄ' : 'üê≠'}</span>
                    <div>
                      <h4 className="font-bold text-stone-800">{c.name}</h4>
                      <div className="flex gap-3 text-sm">
                        <span className={c.hp === 0 ? 'text-red-600 font-bold' : 'text-stone-600'}>
                          HP: {c.hp}/{c.maxHp}
                        </span>
                        <span className={c.str < c.maxStr ? 'text-orange-600 font-bold' : 'text-stone-600'}>
                          STR: {c.str}/{c.maxStr}
                        </span>
                        {c.initiative && <span className="text-blue-600">Init: {c.initiative}</span>}
                      </div>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <Button size="small" variant="success" onClick={() => updateCombatantHP(c.id, 1)}>+HP</Button>
                    <Button size="small" variant="danger" onClick={() => updateCombatantHP(c.id, -1)}>-HP</Button>
                    {currentRound > 0 && c.isEnemy && (
                      <Button size="small" variant="ghost" onClick={() => rollMorale(c.id)}>üèÉ Mor√°lka</Button>
                    )}
                    <Button size="small" variant="ghost" onClick={() => removeCombatant(c.id)}>‚úï</Button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </ResultCard>

      {/* Combat Controls */}
      <ResultCard title="üéÆ Ovl√°d√°n√≠">
        <div className="flex flex-wrap gap-3">
          {currentRound === 0 ? (
            <Button onClick={startCombat} size="large" disabled={combatants.length === 0}>
              ‚öîÔ∏è Zah√°jit boj
            </Button>
          ) : (
            <>
              <Button onClick={nextRound}>üîÑ Dal≈°√≠ kolo</Button>
              <Button onClick={endCombat} variant="danger">üèÅ Ukonƒçit boj</Button>
            </>
          )}
        </div>
      </ResultCard>

      {/* Attack Roll */}
      {currentRound > 0 && (
        <ResultCard>
          <HelpHeader 
            title="√ötok (Bernpyle 2d6)" 
            icon="üó°Ô∏è"
            tooltip={
              <div>
                <p className="font-bold mb-1">Jak √∫toƒçit:</p>
                <ol className="list-decimal list-inside text-xs space-y-1">
                  <li>Vyber c√≠l √∫toku</li>
                  <li>Hoƒè 2d6 na z√°sah</li>
                  <li>V√Ωsledek urƒç√≠ s√≠lu z√°sahu</li>
                  <li>Hoƒè damage podle zbranƒõ</li>
                </ol>
                <p className="mt-2 text-xs text-stone-300">
                  Po≈°kozen√≠ jde nejd≈ô√≠v do HP, pak do STR. P≈ôi STR damage hoƒè STR save!
                </p>
              </div>
            }
          />
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select 
                value=""
                onChange={(id) => {
                  if (id && combatants.filter(c => c.isEnemy).length > 0) {
                    const target = combatants.filter(c => c.isEnemy)[0];
                    rollAttack('player', target.id);
                  }
                }}
                options={[
                  { value: '', label: 'Vybrat c√≠l...' },
                  ...combatants.filter(c => c.isEnemy && c.hp > 0).map(c => ({
                    value: c.id,
                    label: `${c.name} (HP: ${c.hp})`
                  }))
                ]}
              />
            </div>
            
            <Button onClick={() => {
              const enemies = combatants.filter(c => c.isEnemy && c.hp > 0);
              if (enemies.length > 0) rollAttack('player', enemies[0].id);
            }} className="w-full">
              üé≤ Hodit √∫tok
            </Button>
            
            {attackResult && (
              <div className="mt-4 p-4 bg-amber-100 rounded-lg">
                <DiceDisplay dice={attackResult.hitDice} size="large" />
                <div className="mt-3 text-center space-y-2">
                  <p className="text-xl font-bold text-amber-900">{attackResult.hitResult}</p>
                  <p className="text-stone-600">{attackResult.effect}</p>
                  {attackResult.damage > 0 && (
                    <p className="text-2xl font-bold text-red-700">üí• {attackResult.damage} po≈°kozen√≠</p>
                  )}
                  {attackResult.damageRolls.length > 0 && (
                    <p className="text-sm text-stone-500">Damage roll: [{attackResult.damageRolls.join(', ')}]</p>
                  )}
                </div>
              </div>
            )}
          </div>
        </ResultCard>
      )}

      {/* Combat Log */}
      {combatLog.length > 0 && (
        <ResultCard title="üìú Bojov√Ω log">
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {combatLog.map((log, i) => (
              <div key={i} className="text-sm p-2 bg-stone-100 rounded">
                <span className="text-amber-700 font-bold">[K{log.round}]</span> {log.message}
                {log.details && (
                  <ul className="ml-4 mt-1 text-stone-600">
                    {log.details.map((d, j) => <li key={j}>‚Ä¢ {d}</li>)}
                  </ul>
                )}
              </div>
            ))}
          </div>
        </ResultCard>
      )}

      {/* Hit Table Reference */}
      <ResultCard title="üìä Tabulka z√°sah≈Ø (2d6)">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
          <div className="p-2 bg-red-100 rounded text-center">
            <span className="font-bold">2</span><br/>Kritick√Ω minut√≠
          </div>
          <div className="p-2 bg-orange-100 rounded text-center">
            <span className="font-bold">3-4</span><br/>Slab√Ω z√°sah
          </div>
          <div className="p-2 bg-yellow-100 rounded text-center">
            <span className="font-bold">5-8</span><br/>Z√°sah
          </div>
          <div className="p-2 bg-green-100 rounded text-center">
            <span className="font-bold">9-10</span><br/>Siln√Ω z√°sah
          </div>
          <div className="p-2 bg-green-200 rounded text-center">
            <span className="font-bold">11</span><br/>Siln√Ω +1
          </div>
          <div className="p-2 bg-green-300 rounded text-center col-span-2">
            <span className="font-bold">12</span><br/>DRTIV√ù √öDER (max dmg)
          </div>
        </div>
      </ResultCard>
    </div>
  );
};

// ============================================
// CHARACTER PANEL
// ============================================

const CharacterPanel = ({ 
  character, 
  updateCharacter, 
  party, 
  parties,
  activePartyId,
  setActivePartyId,
  activeCharacterId, 
  setActiveCharacterId, 
  createParty,
  createPC, 
  createHireling,
  updateParty,
  updateCharacterInParty,
  removeCharacter,
  removeParty,
  onLogEntry 
}) => {
  const [editMode, setEditMode] = useState(false);
  const [editingName, setEditingName] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  const [openSection, setOpenSection] = useState('inventory');
  const [selectedSlot, setSelectedSlot] = useState(null); // For tap-to-move inventory
  const [popupItem, setPopupItem] = useState(null); // For item detail popup
  const inventoryRef = useRef(null);
  const slotSize = useSlotSize(inventoryRef); // Responsive slot size

  // Generate random PC
  // State for character generator modal
  const [showGenerator, setShowGenerator] = useState(false);
  const [pendingChar, setPendingChar] = useState(null);
  const [bonusOrigin, setBonusOrigin] = useState(null);
  const [selectedBonusItems, setSelectedBonusItems] = useState([]);

  // Roll new character for generator
  const rollNewCharacter = (preferredGender = null) => {
    // Reset bonus origin and selected items
    setBonusOrigin(null);
    setSelectedBonusItems([]);
    
    // Roll attributes (3k6, take two highest for each)
    const roll3k6TwoHighest = () => {
      const rolls = [rollD6(), rollD6(), rollD6()];
      rolls.sort((a, b) => b - a);
      return rolls[0] + rolls[1];
    };
    
    // Roll k66 for distinctive feature
    const rollK66 = () => `${rollD6()}-${rollD6()}`;
    
    const str = roll3k6TwoHighest();
    const dex = roll3k6TwoHighest();
    const wil = roll3k6TwoHighest();
    const hp = rollD6();
    const pips = rollD6();
    
    // Get origin from HP √ó Pips table
    const originKey = `${hp}-${pips}`;
    const origin = ORIGINS[originKey] || ORIGINS['1-1'];
    
    // Gender and name
    const gender = preferredGender || (Math.random() < 0.5 ? 'male' : 'female');
    const firstNames = gender === 'male' ? MALE_FIRST_NAMES : FEMALE_FIRST_NAMES;
    const familyName = randomFrom(FAMILY_NAMES);
    const firstName = randomFrom(firstNames);
    const lastName = gender === 'male' ? familyName.male : familyName.female;
    
    // Fur
    const furColor = randomFrom(FUR_COLORS);
    const furPattern = randomFrom(FUR_PATTERNS);
    
    // Distinctive feature (k66)
    const distinctiveFeature = DISTINCTIVE_FEATURES[rollK66()] || 'Bƒõ≈æn√Ω vzhled';
    
    // Birthsign
    const birthsign = randomFrom(BIRTHSIGNS);
    
    // Bonus items check (max attr ‚â§9 = +1 item, ‚â§7 = +2 items)
    const maxAttr = Math.max(str, dex, wil);
    const bonusItemCount = maxAttr <= 7 ? 2 : maxAttr <= 9 ? 1 : 0;
    
    // Build inventory from origin
    const inventory = [
      { id: generateId(), name: 'Z√°soby', slots: 1, usageDots: 0, maxUsage: 3 },
      { id: generateId(), name: 'Pochodnƒõ', slots: 1, usageDots: 0, maxUsage: 3 },
      { id: generateId(), name: origin.itemA, slots: 1, usageDots: 0, maxUsage: 3 },
      { id: generateId(), name: origin.itemB, slots: 1, usageDots: 0, maxUsage: 3 }
    ];
    
    setPendingChar({
      id: generateId(),
      type: 'pc',
      name: `${firstName} ${lastName}`,
      gender,
      level: 1,
      STR: { current: str, max: str },
      DEX: { current: dex, max: dex },
      WIL: { current: wil, max: wil },
      hp: { current: hp, max: hp },
      pips,
      xp: 0,
      origin,
      birthsign,
      fur: { color: furColor, pattern: furPattern },
      distinctiveFeature,
      bonusItemCount,
      selectedWeaponIndex: 0,
      conditions: [],
      inventory,
      spells: []
    });
  };

  // Swap two attributes
  const swapAttributes = (attr1, attr2) => {
    if (!pendingChar) return;
    setPendingChar({
      ...pendingChar,
      [attr1]: pendingChar[attr2],
      [attr2]: pendingChar[attr1]
    });
  };

  // Change weapon selection
  const selectWeapon = (index) => {
    if (!pendingChar) return;
    setPendingChar({ ...pendingChar, selectedWeaponIndex: index });
  };

  // Confirm and create character
  const confirmCharacter = () => {
    if (!pendingChar || !activePartyId) return;
    
    // Add selected weapon to inventory slots
    const weapon = STARTING_WEAPONS[pendingChar.selectedWeaponIndex || 0];
    
    // Build inventorySlots from origin items + weapon
    const inventorySlots = {
      mainPaw: { id: generateId(), name: `${weapon.name} (${weapon.damage})`, slots: weapon.slots, usageDots: 0, maxUsage: 3, isWeapon: true },
      offPaw: null,
      body1: null,
      body2: null,
      pack1: { id: generateId(), name: 'Z√°soby', slots: 1, usageDots: 0, maxUsage: 3 },
      pack2: { id: generateId(), name: 'Pochodnƒõ', slots: 1, usageDots: 0, maxUsage: 3 },
      pack3: pendingChar.origin?.itemA ? { id: generateId(), name: pendingChar.origin.itemA, slots: 1, usageDots: 0, maxUsage: 3 } : null,
      pack4: pendingChar.origin?.itemB ? { id: generateId(), name: pendingChar.origin.itemB, slots: 1, usageDots: 0, maxUsage: 3 } : null,
      pack5: null,
      pack6: null
    };
    
    // Add bonus items if selected
    if (bonusOrigin && selectedBonusItems.length > 0) {
      const bonusSlots = ['pack5', 'pack6', 'body1', 'body2']; // Try these slots in order
      let slotIndex = 0;
      
      selectedBonusItems.forEach(itemKey => {
        const itemName = itemKey === 'A' ? bonusOrigin.origin.itemA : bonusOrigin.origin.itemB;
        // Find next empty slot
        while (slotIndex < bonusSlots.length && inventorySlots[bonusSlots[slotIndex]] !== null) {
          slotIndex++;
        }
        if (slotIndex < bonusSlots.length) {
          inventorySlots[bonusSlots[slotIndex]] = { 
            id: generateId(), 
            name: itemName, 
            slots: 1, 
            usageDots: 0, 
            maxUsage: 3 
          };
          slotIndex++;
        }
      });
    }
    
    const finalChar = {
      ...pendingChar,
      inventorySlots,
      inventory: [], // Keep empty for backwards compatibility
      conditions: []
    };
    delete finalChar.selectedWeaponIndex;
    delete finalChar.bonusItemCount;
    
    createPC(activePartyId, finalChar);
    setActiveCharacterId(finalChar.id);
    onLogEntry({ type: 'character_created', timestamp: formatTimestamp(), character: finalChar.name });
    setPendingChar(null);
    setBonusOrigin(null);
    setSelectedBonusItems([]);
    setShowGenerator(false);
  };

  // Open generator
  const openGenerator = () => {
    setShowGenerator(true);
    rollNewCharacter();
  };

  const addHireling = () => {
    if (!activePartyId) return;
    const hireling = createHireling(activePartyId);
    setActiveCharacterId(hireling.id);
  };

  const handleDelete = () => {
    if (!deleteConfirm) return;
    if (deleteConfirm.type === 'party') {
      removeParty(deleteConfirm.id);
    } else {
      removeCharacter(activePartyId, deleteConfirm.id);
    }
    setDeleteConfirm(null);
  };

  // Helper functions
  const updateHP = (delta) => {
    if (!character) return;
    const newHP = Math.max(0, Math.min(character.hp?.max || 6, (character.hp?.current || 0) + delta));
    updateCharacter({ hp: { ...character.hp, current: newHP } });
  };

  const updatePips = (delta) => {
    if (!character) return;
    updateCharacter({ pips: Math.max(0, (character.pips || 0) + delta) });
  };

  const updateAttribute = (attr, field, value) => {
    if (!character) return;
    const parsed = parseInt(value) || 0;
    updateCharacter({
      [attr]: { ...character[attr], [field]: Math.max(1, Math.min(18, parsed)) }
    });
  };

  const toggleCondition = (condId) => {
    if (!character) return;
    const has = character.conditions?.includes(condId);
    updateCharacter({
      conditions: has ? character.conditions.filter(c => c !== condId) : [...(character.conditions || []), condId]
    });
  };

  const addInventoryItem = () => {
    if (!character) return;
    updateCharacter({
      inventory: [...(character.inventory || []), { id: generateId(), name: 'Nov√Ω p≈ôedmƒõt', usageDots: 0, maxUsage: 3 }]
    });
  };

  const updateInventoryItem = (id, field, value) => {
    if (!character) return;
    updateCharacter({
      inventory: character.inventory.map(item => item.id === id ? { ...item, [field]: value } : item)
    });
  };

  const removeInventoryItem = (id) => {
    if (!character) return;
    updateCharacter({ inventory: character.inventory.filter(item => item.id !== id) });
  };

  // Slot-based inventory functions
  const SLOT_IDS = ['mainPaw', 'offPaw', 'body1', 'body2', 'pack1', 'pack2', 'pack3', 'pack4', 'pack5', 'pack6'];
  
  const moveInventoryItem = (fromSlot, toSlot) => {
    if (!character || fromSlot === toSlot) return;
    const slots = { ...(character.inventorySlots || {}) };
    const item = slots[fromSlot];
    if (!item) return;
    
    // Pairs for 2-height validation
    const belowMap = { mainPaw: 'offPaw', body1: 'body2', pack1: 'pack4', pack2: 'pack5', pack3: 'pack6' };
    const aboveMap = { offPaw: 'mainPaw', body2: 'body1', pack4: 'pack1', pack5: 'pack2', pack6: 'pack3' };
    
    // Check if target is blocked by 2H item above
    const aboveSlot = aboveMap[toSlot];
    if (aboveSlot && slots[aboveSlot]?.height === 2) {
      return; // Can't drop here, blocked
    }
    
    // Check if dropping 2H item - need empty slot below
    if (item.height === 2) {
      const belowSlot = belowMap[toSlot];
      if (!belowSlot) return; // No slot below, can't place 2H
      if (slots[belowSlot] && belowSlot !== fromSlot) {
        alert('Pot≈ôebuje≈° 2 voln√© sloty pod sebou!');
        return;
      }
    }
    
    // Swap if target has item
    const targetItem = slots[toSlot];
    slots[toSlot] = item;
    slots[fromSlot] = targetItem || null;
    
    updateCharacter({ inventorySlots: slots });
  };

  const updateSlotItem = (slotId, field, value) => {
    if (!character) return;
    const slots = { ...(character.inventorySlots || {}) };
    if (slots[slotId]) {
      slots[slotId] = { ...slots[slotId], [field]: value };
      updateCharacter({ inventorySlots: slots });
    }
  };

  const removeSlotItem = (slotId) => {
    if (!character) return;
    const slots = { ...(character.inventorySlots || {}) };
    
    // If it's a condition, also remove from conditions array
    if (slots[slotId]?.isCondition && slots[slotId]?.conditionId) {
      updateCharacter({ 
        inventorySlots: { ...slots, [slotId]: null },
        conditions: (character.conditions || []).filter(c => c !== slots[slotId].conditionId)
      });
    } else {
      slots[slotId] = null;
      updateCharacter({ inventorySlots: slots });
    }
  };

  const addConditionToSlot = (slotId, condId, condName) => {
    if (!character) return;
    // Don't add if already has this condition
    if (character.conditions?.includes(condId)) return;
    
    const slots = { ...(character.inventorySlots || {}) };
    // Only add to empty slot
    if (slots[slotId]) return;
    
    slots[slotId] = {
      id: generateId(),
      name: condName,
      isCondition: true,
      conditionId: condId,
      usageDots: 0,
      maxUsage: 0
    };
    
    updateCharacter({ 
      inventorySlots: slots,
      conditions: [...(character.conditions || []), condId]
    });
  };

  const addNewItemToFirstEmpty = () => {
    if (!character) return;
    const slots = { ...(character.inventorySlots || {}) };
    
    // Find first empty pack slot
    const emptySlot = ['pack1', 'pack2', 'pack3', 'pack4', 'pack5', 'pack6'].find(s => !slots[s]);
    if (!emptySlot) {
      alert('Batoh je pln√Ω!');
      return;
    }
    
    slots[emptySlot] = {
      id: generateId(),
      name: 'Nov√Ω p≈ôedmƒõt',
      usageDots: 0,
      maxUsage: 3,
      slots: 1
    };
    
    updateCharacter({ inventorySlots: slots });
  };

  // Migrate old inventory format to new slots format
  React.useEffect(() => {
    if (character && character.inventory && !character.inventorySlots) {
      const slots = {};
      character.inventory.forEach((item, idx) => {
        const slotId = SLOT_IDS[idx + 4] || `pack${idx + 1}`; // Start at pack slots
        if (idx < 6) slots[slotId] = { ...item };
      });
      updateCharacter({ inventorySlots: slots });
    }
  }, [character?.id]);

  // ========== NO PARTIES ==========
  if (!parties || parties.length === 0) {
    return (
      <div className="space-y-6">
        <SectionHeader icon="üê≠" title="Postavy" subtitle="Zaƒçni vytvo≈ôen√≠m dru≈æiny" />
        <ResultCard>
          <div className="text-center py-8">
            <p className="text-6xl mb-4">üèïÔ∏è</p>
            <h3 className="text-xl font-bold text-amber-900 mb-2">V√≠tej v Mausritteru!</h3>
            <p className="text-stone-600 mb-6">Vytvo≈ô prvn√≠ dru≈æinu a p≈ôidej postavy.</p>
            <Button onClick={() => createParty('Moje dru≈æina')} size="large">
              üèïÔ∏è Vytvo≈ôit dru≈æinu
            </Button>
          </div>
        </ResultCard>
      </div>
    );
  }

  // ========== MAIN RENDER ==========
  return (
    <div className="space-y-4">
      {/* Delete modal */}
      {deleteConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 className="text-lg font-bold text-amber-900 mb-2">‚ö†Ô∏è Smazat?</h3>
            <p className="text-stone-600 mb-4">{deleteConfirm.name}</p>
            <div className="flex gap-3">
              <Button variant="ghost" onClick={() => setDeleteConfirm(null)} className="flex-1">Zru≈°it</Button>
              <Button variant="danger" onClick={handleDelete} className="flex-1">Smazat</Button>
            </div>
          </div>
        </div>
      )}

      {/* Rename modal */}
      {editingName === 'party' && party && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
            <h3 className="text-lg font-bold text-amber-900 mb-4">P≈ôejmenovat dru≈æinu</h3>
            <input
              value={party.name}
              onChange={(e) => updateParty(party.id, { name: e.target.value })}
              className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg mb-4"
              autoFocus
            />
            <Button onClick={() => setEditingName(null)} className="w-full">Hotovo</Button>
          </div>
        </div>
      )}

      {/* Character Generator Modal */}
      {showGenerator && pendingChar && (
        <div className="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
          <div className="min-h-full flex items-center justify-center p-4">
            <div className="bg-white rounded-xl p-4 md:p-6 max-w-lg w-full shadow-2xl my-8">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-bold text-amber-900">üê≠ Nov√° my≈°</h3>
              <button onClick={() => { setShowGenerator(false); setBonusOrigin(null); setSelectedBonusItems([]); }} className="text-stone-400 hover:text-stone-600 text-2xl">‚úï</button>
            </div>

            {/* Name with gender buttons */}
            <div className="mb-4">
              <label className="text-sm font-bold text-stone-500 block mb-1">Jm√©no</label>
              <div className="flex gap-2">
                <input
                  value={pendingChar.name}
                  onChange={(e) => setPendingChar({ ...pendingChar, name: e.target.value })}
                  className="flex-1 px-3 py-2 border-2 border-amber-300 rounded-lg font-bold"
                />
                <button
                  onClick={() => rollNewCharacter('male')}
                  className={`w-10 h-10 rounded-lg font-bold ${pendingChar.gender === 'male' ? 'bg-blue-500 text-white' : 'bg-stone-100 hover:bg-stone-200'}`}
                  title="Mu≈æsk√© jm√©no"
                >‚ôÇ</button>
                <button
                  onClick={() => rollNewCharacter('female')}
                  className={`w-10 h-10 rounded-lg font-bold ${pendingChar.gender === 'female' ? 'bg-pink-500 text-white' : 'bg-stone-100 hover:bg-stone-200'}`}
                  title="≈Ωensk√© jm√©no"
                >‚ôÄ</button>
              </div>
            </div>

            {/* Origin (from HP √ó Pips) */}
            <div className="bg-amber-50 rounded-lg p-3 mb-4">
              <div className="text-xs font-bold text-amber-700 mb-1">üìú P≈Øvod</div>
              <div className="font-bold text-lg text-amber-900">{pendingChar.origin?.name}</div>
            </div>

            {/* Attributes with swap */}
            <div className="mb-4">
              <div className="flex items-center justify-between mb-2">
                <label className="text-sm font-bold text-stone-500">Atributy</label>
                <span className="text-xs text-stone-400">Klikni pro prohozen√≠</span>
              </div>
              <div className="grid grid-cols-3 gap-2">
                {['STR', 'DEX', 'WIL'].map((attr, idx) => (
                  <div key={attr} className="text-center">
                    <div className="bg-amber-100 rounded-lg p-3">
                      <div className="text-xs font-bold text-amber-700 mb-1">{attr === 'STR' ? 'S√çL' : attr === 'DEX' ? 'MR≈†' : 'V≈ÆL'}</div>
                      <div className="text-3xl font-bold text-amber-900">{pendingChar[attr]?.current}</div>
                    </div>
                    {idx < 2 && (
                      <button
                        onClick={() => swapAttributes(
                          ['STR', 'DEX', 'WIL'][idx], 
                          ['STR', 'DEX', 'WIL'][idx + 1]
                        )}
                        className="mt-1 px-2 py-1 text-xs bg-stone-200 hover:bg-stone-300 rounded"
                      >
                        ‚ÜîÔ∏è {['S√çL', 'MR≈†', 'V≈ÆL'][idx + 1]}
                      </button>
                    )}
                  </div>
                ))}
              </div>
            </div>

            {/* HP & Pips */}
            <div className="grid grid-cols-2 gap-4 mb-4">
              <div className="bg-red-50 rounded-lg p-3 text-center">
                <div className="text-xs font-bold text-red-700">‚ù§Ô∏è BO (Body odolnosti)</div>
                <div className="text-2xl font-bold text-red-900">{pendingChar.hp?.current}</div>
              </div>
              <div className="bg-amber-50 rounded-lg p-3 text-center">
                <div className="text-xs font-bold text-amber-700">üí∞ ƒéobky</div>
                <div className="text-2xl font-bold text-amber-900">{pendingChar.pips}</div>
              </div>
            </div>

            {/* Bonus items warning */}
            {pendingChar.bonusItemCount > 0 && (
              <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-4">
                <div className="font-bold text-green-800 mb-2">
                  üéÅ Bonus za slab√© atributy!
                </div>
                <div className="text-sm text-green-700 space-y-2">
                  <p>
                    Tv≈Øj nejvy≈°≈°√≠ atribut je pouze <strong>{Math.max(pendingChar.STR?.current, pendingChar.DEX?.current, pendingChar.WIL?.current)}</strong>, 
                    co≈æ ti d√°v√° n√°rok na bonus.
                  </p>
                  <p className="font-medium">
                    Hoƒè znovu na tabulku P≈Øvod a vezmi si <strong>{pendingChar.bonusItemCount === 2 ? 'oba p≈ôedmƒõty' : 'jeden p≈ôedmƒõt'}</strong>:
                  </p>
                  
                  {/* Bonus origin roller */}
                  <div className="bg-white rounded-lg p-3 mt-2">
                    <button
                      onClick={() => {
                        const hp = Math.floor(Math.random() * 6) + 1;
                        const pips = Math.floor(Math.random() * 6) + 1;
                        const key = `${hp}-${pips}`;
                        setBonusOrigin({ key, origin: ORIGINS[key], hp, pips });
                        setSelectedBonusItems([]);
                      }}
                      className="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold mb-2"
                    >
                      üé≤ Hodit na bonus p≈Øvod
                    </button>
                    {bonusOrigin && (
                      <div className="text-center">
                        <div className="text-xs text-stone-500">HP {bonusOrigin.hp} √ó Pips {bonusOrigin.pips}</div>
                        <div className="font-bold text-green-800 text-lg mb-2">{bonusOrigin.origin.name}</div>
                        <div className="space-y-2">
                          {/* Item A */}
                          <button
                            onClick={() => {
                              if (selectedBonusItems.includes('A')) {
                                setSelectedBonusItems(selectedBonusItems.filter(i => i !== 'A'));
                              } else if (selectedBonusItems.length < pendingChar.bonusItemCount) {
                                setSelectedBonusItems([...selectedBonusItems, 'A']);
                              }
                            }}
                            className={`w-full p-2 rounded-lg text-left text-sm transition-all border-2 ${
                              selectedBonusItems.includes('A') 
                                ? 'bg-green-200 border-green-500 text-green-800' 
                                : 'bg-white border-stone-200 hover:border-green-300'
                            }`}
                          >
                            {selectedBonusItems.includes('A') ? '‚úì' : '‚óã'} {bonusOrigin.origin.itemA}
                          </button>
                          {/* Item B */}
                          <button
                            onClick={() => {
                              if (selectedBonusItems.includes('B')) {
                                setSelectedBonusItems(selectedBonusItems.filter(i => i !== 'B'));
                              } else if (selectedBonusItems.length < pendingChar.bonusItemCount) {
                                setSelectedBonusItems([...selectedBonusItems, 'B']);
                              }
                            }}
                            className={`w-full p-2 rounded-lg text-left text-sm transition-all border-2 ${
                              selectedBonusItems.includes('B') 
                                ? 'bg-green-200 border-green-500 text-green-800' 
                                : 'bg-white border-stone-200 hover:border-green-300'
                            }`}
                          >
                            {selectedBonusItems.includes('B') ? '‚úì' : '‚óã'} {bonusOrigin.origin.itemB}
                          </button>
                        </div>
                        <div className="text-xs text-green-600 mt-2">
                          {selectedBonusItems.length === 0 
                            ? `Klikni pro v√Ωbƒõr ${pendingChar.bonusItemCount === 2 ? 'p≈ôedmƒõt≈Ø' : 'p≈ôedmƒõtu'}`
                            : `Vybr√°no: ${selectedBonusItems.length}/${pendingChar.bonusItemCount}`
                          }
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Birthsign & Fur */}
            <div className="grid grid-cols-2 gap-4 mb-4">
              <div className="bg-stone-50 rounded-lg p-3">
                <div className="text-xs font-bold text-stone-500 mb-1">‚≠ê Rodn√© znamen√≠</div>
                <div className="font-medium text-stone-800">{pendingChar.birthsign?.sign}</div>
                <div className="text-xs text-stone-500">{pendingChar.birthsign?.trait}</div>
              </div>
              <div className="bg-stone-50 rounded-lg p-3">
                <div className="text-xs font-bold text-stone-500 mb-1">üêæ Srst</div>
                <div className="font-medium text-stone-800">{pendingChar.fur?.color}</div>
                <div className="text-xs text-stone-500">{pendingChar.fur?.pattern}</div>
              </div>
            </div>

            {/* Distinctive feature */}
            <div className="bg-stone-50 rounded-lg p-3 mb-4">
              <div className="text-xs font-bold text-stone-500 mb-1">üëÅÔ∏è V√Ωrazn√Ω rys</div>
              <div className="font-medium text-stone-800">{pendingChar.distinctiveFeature}</div>
            </div>

            {/* Weapon selector */}
            <div className="mb-4">
              <label className="text-sm font-bold text-stone-500 block mb-2">‚öîÔ∏è Poƒç√°teƒçn√≠ zbra≈à</label>
              <select
                value={pendingChar.selectedWeaponIndex || 0}
                onChange={(e) => selectWeapon(parseInt(e.target.value))}
                className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
              >
                {STARTING_WEAPONS.map((weapon, i) => (
                  <option key={i} value={i}>
                    {weapon.name} ({weapon.damage}, {weapon.weight === 'light' ? 'lehk√°' : weapon.weight === 'medium' ? 'st≈ôedn√≠' : 'tƒõ≈æk√°'})
                  </option>
                ))}
              </select>
            </div>

            {/* Starting Inventory from Origin */}
            <div className="bg-amber-50 rounded-lg p-3 mb-4">
              <div className="text-xs font-bold text-amber-700 mb-2">üéí Poƒç√°teƒçn√≠ v√Ωbava</div>
              <div className="space-y-1 text-sm">
                <div className="flex items-center gap-2">
                  <span className="text-amber-600">‚Ä¢</span>
                  <span className="font-medium">{STARTING_WEAPONS[pendingChar.selectedWeaponIndex || 0]?.name} ({STARTING_WEAPONS[pendingChar.selectedWeaponIndex || 0]?.damage})</span>
                  <span className="text-xs text-stone-400">‚öîÔ∏è</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-600">‚Ä¢</span>
                  <span className="font-medium">Z√°soby</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-600">‚Ä¢</span>
                  <span className="font-medium">Pochodnƒõ</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-600">‚Ä¢</span>
                  <span className="font-medium">{pendingChar.origin?.itemA}</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-amber-600">‚Ä¢</span>
                  <span className="font-medium">{pendingChar.origin?.itemB}</span>
                </div>
              </div>
            </div>

            {/* Actions */}
            <div className="flex gap-3">
              <Button variant="ghost" onClick={() => rollNewCharacter()} className="flex-1">
                üé≤ P≈ôehodit
              </Button>
              <Button onClick={confirmCharacter} className="flex-1">
                ‚úì Vytvo≈ôit
              </Button>
            </div>
          </div>
          </div>
        </div>
      )}

      {/* ===== PARTY & MEMBER SELECTOR ===== */}
      <ResultCard>
        {/* Party row */}
        <div className="flex items-center gap-2 mb-4 pb-4 border-b border-stone-200">
          <span className="text-sm font-bold text-stone-500">üèïÔ∏è</span>
          <select
            value={activePartyId || ''}
            onChange={(e) => {
              setActivePartyId(e.target.value);
              const p = parties.find(p => p.id === e.target.value);
              if (p?.members?.length > 0) setActiveCharacterId(p.members[0].id);
              else setActiveCharacterId(null);
            }}
            className="flex-1 px-3 py-2 bg-amber-50 border border-amber-200 rounded-lg font-medium"
          >
            {parties.map(p => (
              <option key={p.id} value={p.id}>{p.name} ({p.members?.length || 0})</option>
            ))}
          </select>
          <Button size="small" variant="ghost" onClick={() => createParty()}>+</Button>
          <Button size="small" variant="ghost" onClick={() => setEditingName('party')}>‚úèÔ∏è</Button>
          <Button size="small" variant="ghost" onClick={() => party && setDeleteConfirm({ type: 'party', id: party.id, name: party.name })}>üóëÔ∏è</Button>
        </div>

        {/* Members row */}
        {party && (
          <div>
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-bold text-stone-500">üë• ƒålenov√©</span>
              <div className="flex gap-1">
                <Button size="small" onClick={openGenerator}>üé≤ My≈°</Button>
                <Button size="small" variant="ghost" onClick={addHireling}>üêøÔ∏è</Button>
              </div>
            </div>
            
            {party.members?.length === 0 ? (
              <p className="text-stone-400 text-center py-4">Pr√°zdn√° dru≈æina - p≈ôidej postavu!</p>
            ) : (
              <div className="flex flex-wrap gap-2">
                {party.members.map(member => (
                  <button
                    key={member.id}
                    onClick={() => setActiveCharacterId(member.id)}
                    className={`px-4 py-3 rounded-xl transition-all flex items-center gap-2 ${
                      activeCharacterId === member.id
                        ? 'bg-amber-500 text-white shadow-lg'
                        : 'bg-stone-100 text-stone-700 hover:bg-stone-200'
                    }`}
                  >
                    <span className="text-xl">{member.type === 'pc' ? 'üê≠' : 'üêøÔ∏è'}</span>
                    <div className="text-left">
                      <div className="font-bold text-sm">{member.name.split(' ')[0]}</div>
                      <div className={`text-xs ${activeCharacterId === member.id ? 'text-amber-200' : 'text-stone-400'}`}>
                        HP {member.hp?.current}/{member.hp?.max}
                      </div>
                    </div>
                  </button>
                ))}
              </div>
            )}
          </div>
        )}
      </ResultCard>

      {/* ===== CHARACTER SHEET ===== */}
      {!character ? (
        <ResultCard>
          <div className="text-center py-8 text-stone-400">
            <p className="text-4xl mb-3">üëÜ</p>
            <p>Vyber nebo vytvo≈ô postavu</p>
          </div>
        </ResultCard>
      ) : (
        <>
          {/* Character Header */}
          <ResultCard className="bg-gradient-to-r from-amber-100 to-amber-50">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <span className="text-4xl">{character.type === 'pc' ? 'üê≠' : 'üêøÔ∏è'}</span>
                <div>
                  <h2 
                    className="text-xl font-bold text-amber-900 cursor-pointer hover:text-amber-700"
                    onClick={() => setEditingName(character.id)}
                  >
                    {character.name}
                  </h2>
                  <p className="text-sm text-stone-500">
                    {character.type === 'pc' 
                      ? `${character.origin?.name || character.background || 'Level ' + (character.level || 1)}` 
                      : `Hireling ‚Ä¢ Loyalty ${character.loyalty || 7}`}
                  </p>
                </div>
              </div>
              <button
                onClick={() => setDeleteConfirm({ type: 'character', id: character.id, name: character.name })}
                className="p-2 text-stone-400 hover:text-red-500 rounded"
              >
                üóëÔ∏è
              </button>
            </div>

            {/* HP & Pips */}
            <div className="flex gap-4">
              <div className="flex-1 bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-xs text-stone-500 mb-1">‚ù§Ô∏è HP</div>
                <div className="flex items-center justify-center gap-2">
                  <button onClick={() => updateHP(-1)} className="w-10 h-10 bg-red-100 text-red-700 rounded-lg font-bold text-xl">-</button>
                  <span className="text-2xl font-bold text-red-700 min-w-[60px]">
                    {character.hp?.current || 0}/{character.hp?.max || 6}
                  </span>
                  <button onClick={() => updateHP(1)} className="w-10 h-10 bg-green-100 text-green-700 rounded-lg font-bold text-xl">+</button>
                </div>
              </div>
              {character.type === 'pc' ? (
                <div className="flex-1 bg-white rounded-lg p-3 text-center shadow-sm">
                  <div className="text-xs text-stone-500 mb-1">üí∞ Pips</div>
                  <div className="flex items-center justify-center gap-2">
                    <button onClick={() => updatePips(-1)} className="w-10 h-10 bg-stone-100 text-stone-700 rounded-lg font-bold text-xl">-</button>
                    <span className="text-2xl font-bold text-amber-600 min-w-[60px]">{character.pips || 0}</span>
                    <button onClick={() => updatePips(1)} className="w-10 h-10 bg-stone-100 text-stone-700 rounded-lg font-bold text-xl">+</button>
                  </div>
                </div>
              ) : (
                <div className="flex-1 bg-white rounded-lg p-3 text-center shadow-sm">
                  <div className="text-xs text-stone-500 mb-1">ü§ù Loyalty</div>
                  <div className="text-2xl font-bold text-blue-700">{character.loyalty || 7}</div>
                  <Button 
                    size="small" 
                    className="mt-2"
                    onClick={() => {
                      const { dice, total } = roll2D6();
                      const success = total <= (character.loyalty || 7);
                      alert(`[${dice.join(',')}] = ${total}\n${success ? '‚úì OK!' : '‚úó SELH√ÅN√ç!'}`);
                    }}
                  >
                    üé≤ Test
                  </Button>
                </div>
              )}
            </div>
          </ResultCard>

          {/* PC-only sections */}
          {character.type === 'pc' && (
            <>
              {/* Attributes */}
              <ResultCard title="üí™ Atributy">
                <div className="grid grid-cols-3 gap-3">
                  {['STR', 'DEX', 'WIL'].map(attr => (
                    <div key={attr} className="text-center p-3 bg-amber-50 rounded-lg">
                      <div className="text-xs font-bold text-amber-700 mb-1">{attr}</div>
                      <div className="flex items-center justify-center gap-1">
                        <input
                          type="number"
                          value={character[attr]?.current || 10}
                          onChange={(e) => updateAttribute(attr, 'current', e.target.value)}
                          className="w-12 text-center text-xl font-bold text-amber-900 bg-white border border-amber-300 rounded"
                          min="1"
                          max="18"
                        />
                        <span className="text-stone-400">/</span>
                        <input
                          type="number"
                          value={character[attr]?.max || 10}
                          onChange={(e) => updateAttribute(attr, 'max', e.target.value)}
                          className="w-12 text-center text-sm font-medium text-stone-500 bg-white border border-stone-200 rounded"
                          min="1"
                          max="18"
                        />
                      </div>
                    </div>
                  ))}
                </div>
              </ResultCard>

              {/* Inventory Grid - Mausritter Original Layout */}
              <ResultCard title="üéí Invent√°≈ô">
                {/* Item detail popup */}
                {popupItem && (
                  <ItemPopup 
                    item={popupItem.item} 
                    slotId={popupItem.slotId}
                    onUpdate={updateSlotItem}
                    onRemove={removeSlotItem}
                    onMove={(slotId) => setSelectedSlot(slotId)}
                    onClose={() => setPopupItem(null)}
                  />
                )}
                {selectedSlot && (
                  <div className="mb-2 p-1 bg-amber-100 rounded text-xs text-amber-800 flex justify-between items-center">
                    <span>Vyber c√≠lov√Ω slot</span>
                    <button onClick={() => setSelectedSlot(null)} className="text-amber-600 hover:text-amber-800">‚úï Zru≈°it</button>
                  </div>
                )}
                <div className="space-y-3">
                  {/* Main Grid FIRST - Paws | Body | Pack */}
                  <div ref={inventoryRef} className="flex gap-2 md:gap-3 items-start justify-center">
                    {/* Paws */}
                    <div className="text-center">
                      <div style={{ fontSize: Math.max(12, slotSize * 0.2) }} className="text-amber-600 font-bold mb-1">üêæ</div>
                      <div className="flex flex-col gap-1" style={{ position: 'relative' }}>
                        <InvSlot id="mainPaw" slots={character.inventorySlots} color="amber" 
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem} 
                          updateChar={updateCharacter} belowId="offPaw" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="offPaw" slots={character.inventorySlots} color="amber"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} aboveId="mainPaw" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                      </div>
                    </div>
                    
                    {/* Body */}
                    <div className="text-center">
                      <div style={{ fontSize: Math.max(12, slotSize * 0.2) }} className="text-blue-600 font-bold mb-1">üëï</div>
                      <div className="flex flex-col gap-1" style={{ position: 'relative' }}>
                        <InvSlot id="body1" slots={character.inventorySlots} color="blue"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} belowId="body2" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="body2" slots={character.inventorySlots} color="blue"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} aboveId="body1" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                      </div>
                    </div>
                    
                    {/* Pack 3x2 */}
                    <div className="text-center flex-1">
                      <div style={{ fontSize: Math.max(12, slotSize * 0.2) }} className="text-stone-500 font-bold mb-1">üéí</div>
                      <div style={{ display: 'grid', gridTemplateColumns: `repeat(3, ${slotSize}px)`, gridTemplateRows: `repeat(2, ${slotSize}px)`, gap: 4, position: 'relative' }}>
                        <InvSlot id="pack1" slots={character.inventorySlots} color="stone"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} belowId="pack4" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="pack2" slots={character.inventorySlots} color="stone"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} belowId="pack5" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="pack3" slots={character.inventorySlots} color="stone"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} belowId="pack6" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="pack4" slots={character.inventorySlots} color="stone"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} aboveId="pack1" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="pack5" slots={character.inventorySlots} color="stone"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} aboveId="pack2" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                        <InvSlot id="pack6" slots={character.inventorySlots} color="stone"
                          onMove={moveInventoryItem} onUpdate={updateSlotItem} onRemove={removeSlotItem}
                          updateChar={updateCharacter} aboveId="pack3" slotSize={slotSize}
                          selectedSlot={selectedSlot} setSelectedSlot={setSelectedSlot} setPopupItem={setPopupItem} />
                      </div>
                    </div>
                  </div>
                  
                  {/* Quick add items - below grid */}
                  <details className="border-t border-stone-200 pt-2">
                    <summary className="text-xs font-bold text-stone-500 cursor-pointer hover:text-stone-700">‚ñº P≈ôidat p≈ôedmƒõt</summary>
                    <div className="mt-2 flex flex-wrap gap-1">
                    {[
                      { name: 'Z√°soby', type: 'item', maxUsage: 3, width: 1, height: 1 },
                      { name: 'Pochode≈à', type: 'item', maxUsage: 3, width: 1, height: 1 },
                      { name: 'Jehla', type: 'weapon', damageDef: 'k6', weaponClass: 'Light', maxUsage: 3, width: 1, height: 1 },
                      { name: 'Meƒç', type: 'weapon', damageDef: 'k6/k8', weaponClass: 'Medium', maxUsage: 3, width: 1, height: 1 },
                      { name: 'Kop√≠‚Üï', type: 'weapon', damageDef: 'k10', weaponClass: 'Heavy', maxUsage: 3, width: 1, height: 2 },
                      { name: 'Zbroj‚Üï', type: 'armor', damageDef: '1', weaponClass: 'Heavy', maxUsage: 3, width: 1, height: 2 },
                    ].map((item, i) => (
                      <button key={i} onClick={() => {
                        const slots = character.inventorySlots || {};
                        const pairs = [['mainPaw', 'offPaw'],['body1', 'body2'],['pack1', 'pack4'],['pack2', 'pack5'],['pack3', 'pack6']];
                        let targetSlot = null;
                        if (item.height === 2) {
                          for (const [top, bottom] of pairs) {
                            if (!slots[top] && !slots[bottom]) { targetSlot = top; break; }
                          }
                          if (!targetSlot) { alert('Pot≈ôebuje≈° 2 voln√© sloty pod sebou!'); return; }
                        } else {
                          const allSlots = ['mainPaw','offPaw','body1','body2','pack1','pack2','pack3','pack4','pack5','pack6'];
                          const blockedByAbove = { offPaw: 'mainPaw', body2: 'body1', pack4: 'pack1', pack5: 'pack2', pack6: 'pack3' };
                          targetSlot = allSlots.find(s => !slots[s] && !(blockedByAbove[s] && slots[blockedByAbove[s]]?.height === 2));
                        }
                        if (targetSlot) updateCharacter({ inventorySlots: { ...slots, [targetSlot]: { id: Math.random().toString(36).substr(2,9), ...item, usageDots: 0 }}});
                      }}
                        className={`px-2 py-1 rounded text-xs border ${
                          item.type === 'weapon' ? 'bg-slate-50 border-slate-200 hover:bg-slate-100' : 
                          item.type === 'armor' ? 'bg-indigo-50 border-indigo-200 hover:bg-indigo-100' : 
                          'bg-amber-50 border-amber-200 hover:bg-amber-100'
                        }`}
                      >{item.name}</button>
                    ))}
                    {CONDITIONS.slice(0, 3).map(c => (
                      <button key={c.id} onClick={() => {
                        const slots = character.inventorySlots || {};
                        const allSlots = ['mainPaw','offPaw','body1','body2','pack1','pack2','pack3','pack4','pack5','pack6'];
                        const blockedByAbove = { offPaw: 'mainPaw', body2: 'body1', pack4: 'pack1', pack5: 'pack2', pack6: 'pack3' };
                        const empty = allSlots.find(s => !slots[s] && !(blockedByAbove[s] && slots[blockedByAbove[s]]?.height === 2));
                        if (empty) updateCharacter({ inventorySlots: { ...slots, [empty]: { 
                          id: Math.random().toString(36).substr(2,9), name: c.name, type: 'condition', isCondition: true,
                          conditionId: c.id, mechanic: c.effect, clear: c.clear, bgColor: '#fecaca', width: 1, height: 1, maxUsage: 0, usageDots: 0
                        }}});
                      }}
                        className="px-2 py-1 rounded text-xs bg-red-50 border border-red-200 text-red-700 hover:bg-red-100"
                      >{c.name}</button>
                    ))}
                    </div>
                  </details>
                </div>
              </ResultCard>

              {/* Info */}
              <ResultCard title="üìã Info">
                <div className="space-y-2 text-sm">
                  <p><strong>P≈Øvod:</strong> {character.origin?.name || character.background || '‚Äî'}</p>
                  <p><strong>Znamen√≠:</strong> {character.birthsign?.sign || character.birthsign?.name} <span className="text-stone-500">({character.birthsign?.trait || character.birthsign?.traits})</span></p>
                  {character.fur && (
                    <p><strong>Srst:</strong> {character.fur.color}, {character.fur.pattern?.toLowerCase()}</p>
                  )}
                  <p><strong>V√Ωrazn√Ω rys:</strong> {character.distinctiveFeature || character.physicalDetail || '‚Äî'}</p>
                  <p><strong>XP:</strong> {character.xp || 0}</p>
                </div>
              </ResultCard>
            </>
          )}

          {/* Hireling-only sections */}
          {character.type === 'hireling' && (
            <ResultCard title="üéØ Schopnosti">
              <div className="flex flex-wrap gap-2">
                {['Boj', 'Pr≈Øzkum', 'L√©ƒçen√≠', 'Pl√≠≈æen√≠', 'Va≈ôen√≠', 'Opravy', 'Navigace'].map(skill => (
                  <button
                    key={skill}
                    onClick={() => updateCharacter({
                      skills: character.skills?.includes(skill)
                        ? character.skills.filter(s => s !== skill)
                        : [...(character.skills || []), skill]
                    })}
                    className={`px-4 py-2 rounded-lg text-sm font-medium ${
                      character.skills?.includes(skill) ? 'bg-blue-500 text-white' : 'bg-stone-100 text-stone-600'
                    }`}
                  >
                    {skill}
                  </button>
                ))}
              </div>
            </ResultCard>
          )}
        </>
      )}
    </div>
  );
};

// ========== HIRELING SHEET COMPONENT ==========
const HirelingSheet = ({ character, updateCharacter, editMode, setEditMode, onLogEntry }) => {
  const HIRELING_SKILLS = ['Boj', 'Pr≈Øzkum', 'L√©ƒçen√≠', 'Pl√≠≈æen√≠', 'Va≈ôen√≠', 'Opravy', 'Navigace', 'Obchod'];

  return (
    <>
      <ResultCard title="üêøÔ∏è Hireling Sheet">
        <div className="flex justify-end mb-3">
          <Button size="small" variant="ghost" onClick={() => setEditMode(!editMode)}>
            {editMode ? '‚úì Hotovo' : '‚úèÔ∏è Upravit'}
          </Button>
        </div>
        
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label className="text-sm text-stone-500 block">HP</label>
            <div className="text-2xl font-bold text-red-700">
              {character.hp?.current || 0}/{character.hp?.max || 3}
            </div>
            <div className="flex gap-1 mt-1">
              <Button size="small" variant="danger" onClick={() => updateCharacter({ hp: { ...character.hp, current: Math.max(0, (character.hp?.current || 0) - 1) } })}>-</Button>
              <Button size="small" variant="success" onClick={() => updateCharacter({ hp: { ...character.hp, current: Math.min(character.hp?.max || 3, (character.hp?.current || 0) + 1) } })}>+</Button>
            </div>
          </div>
          <div>
            <label className="text-sm text-stone-500 block">Loajalita</label>
            <div className="text-2xl font-bold text-blue-700">{character.loyalty || 7}</div>
            {editMode && (
              <div className="flex gap-1 mt-1">
                <Button size="small" variant="ghost" onClick={() => updateCharacter({ loyalty: Math.max(2, (character.loyalty || 7) - 1) })}>-</Button>
                <Button size="small" variant="ghost" onClick={() => updateCharacter({ loyalty: Math.min(12, (character.loyalty || 7) + 1) })}>+</Button>
              </div>
            )}
          </div>
          <div>
            <label className="text-sm text-stone-500 block">Cena</label>
            {editMode ? (
              <Input value={character.cost || '1 pip/den'} onChange={(v) => updateCharacter({ cost: v })} />
            ) : (
              <p className="font-bold">{character.cost || '1 pip/den'}</p>
            )}
          </div>
          <div>
            <label className="text-sm text-stone-500 block">Fyzick√Ω detail</label>
            <p className="text-stone-700">{character.physicalDetail || '‚Äî'}</p>
          </div>
        </div>
      </ResultCard>

      <ResultCard title="üéØ Schopnosti">
        <div className="flex flex-wrap gap-2">
          {HIRELING_SKILLS.map(skill => (
            <button
              key={skill}
              onClick={() => updateCharacter({
                skills: character.skills?.includes(skill) 
                  ? character.skills.filter(s => s !== skill)
                  : [...(character.skills || []), skill]
              })}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                character.skills?.includes(skill)
                  ? 'bg-blue-600 text-white'
                  : 'bg-stone-200 text-stone-700 hover:bg-stone-300'
              }`}
            >
              {skill}
            </button>
          ))}
        </div>
      </ResultCard>

      <ResultCard title="üé≤ Loyalty Check">
        <p className="text-stone-600 mb-3 text-sm">
          Hoƒè 2d6 kdy≈æ hireling ƒçel√≠ nebezpeƒç√≠ nebo je mu rozk√°z√°no nƒõco riskantn√≠ho. 
          V√Ωsledek mus√≠ b√Ωt ‚â§ {character.loyalty || 7}.
        </p>
        <Button onClick={() => {
          const { dice, total } = roll2D6();
          const success = total <= (character.loyalty || 7);
          onLogEntry({
            type: 'loyalty_check',
            timestamp: formatTimestamp(),
            hireling: character.name,
            dice, total,
            threshold: character.loyalty || 7,
            success
          });
          alert(`Loyalty: [${dice.join(', ')}] = ${total} vs ${character.loyalty || 7}\n${success ? '‚úì Loaj√°ln√≠!' : '‚úó PROBL√âM!'}`);
        }}>
          üé≤ Hodit (2d6 ‚â§ {character.loyalty || 7})
        </Button>
      </ResultCard>
    </>
  );
};

// ========== PC SHEET COMPONENT ==========
const PCSheet = ({ character, updateCharacter, editMode, setEditMode, onLogEntry }) => {
  
  const updateAttribute = (attr, field, value) => {
    const parsed = parseInt(value) || 0;
    updateCharacter({
      [attr]: {
        ...character[attr],
        [field]: Math.max(0, Math.min(18, parsed))
      }
    });
  };

  const updateHP = (delta) => {
    const newHP = Math.max(0, Math.min(character.hp.max, character.hp.current + delta));
    updateCharacter({ hp: { ...character.hp, current: newHP } });
    onLogEntry({
      type: 'state_change',
      subtype: 'hp',
      timestamp: formatTimestamp(),
      change: delta,
      newValue: newHP
    });
  };

  const updatePips = (delta) => {
    updateCharacter({ pips: Math.max(0, (character.pips || 0) + delta) });
  };

  const toggleCondition = (condId) => {
    const hasCondition = character.conditions?.includes(condId);
    updateCharacter({
      conditions: hasCondition
        ? character.conditions.filter(c => c !== condId)
        : [...(character.conditions || []), condId]
    });
  };

  const addInventoryItem = () => {
    updateCharacter({
      inventory: [...(character.inventory || []), {
        id: generateId(),
        name: 'Nov√Ω p≈ôedmƒõt',
        slot: 1,
        usageDots: 0,
        maxUsage: 3
      }]
    });
  };

  const updateInventoryItem = (id, field, value) => {
    updateCharacter({
      inventory: character.inventory.map(item =>
        item.id === id ? { ...item, [field]: value } : item
      )
    });
  };

  const removeInventoryItem = (id) => {
    updateCharacter({
      inventory: character.inventory.filter(item => item.id !== id)
    });
  };

  return (
    <>
      {/* Quick Actions */}
      <div className="flex flex-wrap gap-3">
        <Button onClick={() => setEditMode(!editMode)} variant="ghost">
          {editMode ? '‚úì Hotovo' : '‚úèÔ∏è Upravit'}
        </Button>
      </div>

      {/* Basic Info */}
      <ResultCard title="üìã Z√°kladn√≠ √∫daje">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label className="text-sm text-stone-500 block">Level</label>
            <p className="font-bold text-lg text-amber-900">{character.level || 1}</p>
          </div>
          <div>
            <label className="text-sm text-stone-500 block">Znamen√≠</label>
            <p className="font-bold text-amber-900">
              {character.birthsign?.name || '‚Äî'}
              {character.birthsign?.traits && (
                <span className="font-normal text-sm text-stone-600 block">{character.birthsign.traits}</span>
              )}
            </p>
          </div>
          <div>
            <label className="text-sm text-stone-500 block">Fyzick√Ω detail</label>
            <p className="text-stone-700">{character.physicalDetail || '‚Äî'}</p>
          </div>
          <div>
            <label className="text-sm text-stone-500 block">Z√°jmena</label>
            {editMode ? (
              <Input value={character.pronouns || ''} onChange={(v) => updateCharacter({ pronouns: v })} />
            ) : (
              <p className="text-stone-700">{character.pronouns || '‚Äî'}</p>
            )}
          </div>
        </div>
      </ResultCard>

      {/* Attributes */}
      <ResultCard>
        <HelpHeader 
          title="Atributy" 
          icon="üí™"
          tooltip={
            <div>
              <p className="font-bold mb-2">üéØ Atributy postavy</p>
              
              <p className="font-bold mb-1">üìä Co znamenaj√≠:</p>
              <ul className="text-xs space-y-1 mb-2">
                <li><b>STR (S√≠la)</b> = fyzick√° s√≠la, zdrav√≠, odolnost</li>
                <li><b>DEX (Mr≈°tnost)</b> = rychlost, obratnost, reflexy</li>
                <li><b>WIL (V≈Øle)</b> = odvaha, v≈Øle, magie</li>
              </ul>
              
              <p className="font-bold mb-1">üé≤ Jak h√°zet Save:</p>
              <ol className="list-decimal list-inside text-xs space-y-1 mb-2">
                <li>Hoƒè d20</li>
                <li>Mus√≠≈° hodit <b>‚â§ current hodnota</b> atributu</li>
                <li>ƒå√≠m ni≈æ≈°√≠ hod, t√≠m lep≈°√≠ (1 = v≈ædy √∫spƒõch)</li>
              </ol>
              
              <p className="font-bold mb-1">üíî Po≈°kozen√≠ atribut≈Ø:</p>
              <p className="text-xs text-stone-300">
                Kdy≈æ HP klesne na 0, po≈°kozen√≠ jde do STR. Kritick√© z√°sahy mohou po≈°kodit DEX nebo WIL. Pokud atribut klesne na 0, postava je mimo hru.
              </p>
            </div>
          }
        />
        <div className="grid grid-cols-3 gap-4">
          {['STR', 'DEX', 'WIL'].map(attr => (
            <div key={attr} className="text-center p-4 bg-amber-100 rounded-lg">
              <div className="text-sm font-bold text-amber-800 mb-2">{attr}</div>
              {editMode ? (
                <div className="space-y-2">
                  <Input 
                    type="number" value={character[attr]?.current || 10}
                    onChange={(v) => updateAttribute(attr, 'current', v)}
                    className="text-center"
                  />
                  <Input 
                    type="number" value={character[attr]?.max || 10}
                    onChange={(v) => updateAttribute(attr, 'max', v)}
                    className="text-center text-sm"
                  />
                </div>
              ) : (
                <>
                  <div className="text-3xl font-bold text-amber-900">{character[attr]?.current || 10}</div>
                  <div className="text-sm text-stone-500">max: {character[attr]?.max || 10}</div>
                </>
              )}
            </div>
          ))}
        </div>
      </ResultCard>

      {/* HP, Pips, XP */}
      <ResultCard>
        <div className="grid grid-cols-3 gap-4">
          <div className="text-center">
            <label className="text-sm text-stone-500 block mb-1">‚ù§Ô∏è HP</label>
            <div className="text-3xl font-bold text-red-700">
              {character.hp?.current || 0}
              <span className="text-xl text-stone-500">/{character.hp?.max || 6}</span>
            </div>
            <div className="flex justify-center gap-1 mt-2">
              <Button size="small" variant="danger" onClick={() => updateHP(-1)}>-1</Button>
              <Button size="small" variant="success" onClick={() => updateHP(1)}>+1</Button>
              <Button size="small" variant="ghost" onClick={() => updateHP(character.hp?.max - character.hp?.current)}>Full</Button>
            </div>
          </div>
          <div className="text-center">
            <label className="text-sm text-stone-500 block mb-1">üí∞ Pips</label>
            <div className="text-3xl font-bold text-amber-600">{character.pips || 0}</div>
            <div className="flex justify-center gap-1 mt-2">
              <Button size="small" variant="ghost" onClick={() => updatePips(-1)}>-1</Button>
              <Button size="small" variant="ghost" onClick={() => updatePips(1)}>+1</Button>
            </div>
          </div>
          <div className="text-center">
            <label className="text-sm text-stone-500 block mb-1">‚≠ê XP</label>
            <div className="text-2xl font-bold text-purple-700">{character.xp || 0}</div>
            <div className="flex justify-center gap-1 mt-2">
              <Button size="small" onClick={() => updateCharacter({ xp: (character.xp || 0) + 10 })}>+10</Button>
              <Button size="small" onClick={() => updateCharacter({ xp: (character.xp || 0) + 50 })}>+50</Button>
            </div>
          </div>
        </div>
      </ResultCard>

      {/* Conditions */}
      <ResultCard>
        <HelpHeader title="Stavy" icon="ü©π" tooltip={
          <div>
            <p className="font-bold mb-2">üéØ Stavy postavy</p>
            <p className="text-xs mb-2">Klikni na stav pro aktivaci/deaktivaci. Aktivn√≠ stavy zab√≠raj√≠ slot v invent√°≈ôi!</p>
            
            <p className="font-bold mb-1">üìã Stavy:</p>
            <ul className="text-xs space-y-1">
              <li>üò∞ <b>Vydƒõ≈°en√Ω</b> = -1 na WIL saves, z boje uteƒç nebo bojuj s nev√Ωhodou</li>
              <li>üòµ <b>Vyƒçerpan√Ω</b> = -1 na v≈°echny saves, pot≈ôebuje≈° odpoƒçinek</li>
              <li>ü§¢ <b>Otr√°ven√Ω</b> = -1 na STR saves, hoƒè d6 po ka≈æd√©m odpoƒçinku (6 = vyl√©ƒçen)</li>
              <li>üò´ <b>Hladov√Ω</b> = nem≈Ø≈æe≈° l√©ƒçit HP, zab√≠r√° 2 sloty</li>
            </ul>
            
            <p className="text-xs text-stone-300 mt-2 italic">
              üí° Stavy se l√©ƒç√≠ odpoƒçinkem, j√≠dlem, nebo speci√°ln√≠mi p≈ôedmƒõty.
            </p>
          </div>
        } />
        <div className="flex flex-wrap gap-2">
          {CONDITIONS.map(cond => (
            <button
              key={cond.id}
              onClick={() => toggleCondition(cond.id)}
              className={`px-3 py-1.5 rounded-lg text-sm transition-all ${
                character.conditions?.includes(cond.id)
                  ? 'bg-red-600 text-white'
                  : 'bg-stone-200 text-stone-700 hover:bg-stone-300'
              }`}
              title={cond.effect}
            >
              {cond.name}
            </button>
          ))}
        </div>
      </ResultCard>

      {/* Inventory */}
      <ResultCard>
        <HelpHeader title="Invent√°≈ô" icon="üéí" tooltip={
          <div>
            <p className="font-bold mb-2">üéØ Syst√©m invent√°≈ôe</p>
            <p className="text-xs mb-2">My≈° m√° omezen√Ω prostor - ka≈æd√Ω p≈ôedmƒõt zab√≠r√° sloty. P≈ôet√≠≈æen√≠ = pomalost!</p>
            
            <p className="font-bold mb-1">üì¶ Typy slot≈Ø:</p>
            <ul className="text-xs space-y-1 mb-2">
              <li>üñêÔ∏è <b>Ruce (2)</b> = zbranƒõ a ≈°t√≠ty pro boj</li>
              <li>üéí <b>Tƒõlo (6)</b> = hlavn√≠ invent√°≈ô</li>
              <li>üì¶ <b>Balen√≠</b> = roz≈°√≠≈ôen√≠ p≈ôes batoh/vak</li>
            </ul>
            
            <p className="font-bold mb-1">‚öôÔ∏è Opot≈ôeben√≠ (Usage Die):</p>
            <ol className="list-decimal list-inside text-xs space-y-1 mb-2">
              <li>Po pou≈æit√≠ p≈ôedmƒõtu (pochode≈à, lano, j√≠dlo...) hoƒè d6</li>
              <li>Na <b>1-3</b> = oznaƒç teƒçku (‚óè) na p≈ôedmƒõtu</li>
              <li>Kdy≈æ jsou v≈°echny teƒçky oznaƒçeny = p≈ôedmƒõt je spot≈ôebov√°n</li>
            </ol>
            
            <p className="text-xs text-stone-300 italic">
              üí° Klikni na p≈ôedmƒõt pro jeho pou≈æit√≠/oznaƒçen√≠.
            </p>
          </div>
        } />
        <div className="space-y-2">
          {character.inventory?.map(item => (
            <div key={item.id} className="flex items-center gap-3 p-2 bg-amber-50 rounded-lg">
              <Input 
                value={item.name}
                onChange={(v) => updateInventoryItem(item.id, 'name', v)}
                className="flex-1"
              />
              <div className="flex gap-1">
                {[0, 1, 2].map(dot => (
                  <button
                    key={dot}
                    onClick={() => updateInventoryItem(item.id, 'usageDots', dot < item.usageDots ? dot : dot + 1)}
                    className={`w-4 h-4 rounded-full border-2 ${
                      dot < item.usageDots ? 'bg-amber-600 border-amber-600' : 'border-amber-400'
                    }`}
                  />
                ))}
              </div>
              <Button size="small" variant="ghost" onClick={() => removeInventoryItem(item.id)}>‚úï</Button>
            </div>
          ))}
          <Button size="small" variant="ghost" onClick={addInventoryItem} className="w-full">
            + P≈ôidat p≈ôedmƒõt
          </Button>
        </div>
      </ResultCard>
    </>
  );
};


// ============================================
// INVENTORY SLOT COMPONENT - Mausritter Style
// ============================================

// Responsive slot size hook - fills available width
const useSlotSize = (containerRef) => {
  const [size, setSize] = useState(44);
  
  useEffect(() => {
    const updateSize = () => {
      if (containerRef?.current) {
        // Calculate slot size based on container width
        // Layout: paw(1 slot) + body(1 slot) + pack(3 slots) = 5 columns + gaps
        const containerWidth = containerRef.current.offsetWidth;
        // 5 columns + 4 gaps (~12px each)
        const calculatedSize = Math.floor((containerWidth - 60) / 5);
        // Clamp between 44 and 120
        const newSize = Math.min(120, Math.max(44, calculatedSize));
        if (newSize !== size) setSize(newSize);
      }
    };
    
    // Initial update after render
    const timer = setTimeout(updateSize, 50);
    
    window.addEventListener('resize', updateSize);
    return () => {
      clearTimeout(timer);
      window.removeEventListener('resize', updateSize);
    };
  }, [containerRef, size]);
  
  return size;
};

const SLOT_SIZE = 44; // Default fallback

// Item detail popup
const ItemPopup = ({ item, slotId, onUpdate, onRemove, onMove, onClose }) => {
  const isCond = item.type === 'condition' || item.isCondition;
  const bg = item.bgColor || (isCond ? '#fecaca' : item.type === 'weapon' ? '#f1f5f9' : item.type === 'armor' ? '#e0e7ff' : '#fef3c7');
  
  return (
    <div 
      onClick={onClose}
      style={{
        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
        background: 'rgba(0,0,0,0.5)', zIndex: 1000,
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        padding: 16
      }}
    >
      <div 
        onClick={(e) => e.stopPropagation()}
        style={{
          background: bg, border: '3px solid #292524', borderRadius: 8,
          width: '100%', maxWidth: 200, padding: 0, overflow: 'hidden'
        }}
      >
        {/* Header */}
        <div style={{ background: isCond ? bg : '#fff', borderBottom: '2px solid #292524', padding: '8px 12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <span style={{ fontWeight: 700, fontSize: 14 }}>{item.name}</span>
          <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: 20, cursor: 'pointer', color: '#78716c' }}>√ó</button>
        </div>
        
        {/* Stats */}
        <div style={{ padding: 12 }}>
          {/* Damage/Defense */}
          {(item.damageDef || item.damage || item.defense) && (
            <div style={{ marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ fontSize: 12, color: '#57534e' }}>{item.type === 'armor' ? 'Obrana:' : 'Po≈°kozen√≠:'}</span>
              <span style={{ background: '#fff', border: '2px solid #292524', borderRadius: 4, padding: '2px 8px', fontWeight: 700 }}>
                {item.damageDef || item.damage || item.defense}
              </span>
            </div>
          )}
          
          {/* Weapon class */}
          {item.weaponClass && (
            <div style={{ marginBottom: 8, fontSize: 12, color: '#57534e' }}>
              T≈ô√≠da: <strong>{item.weaponClass}</strong>
            </div>
          )}
          
          {/* Usage dots */}
          {!isCond && item.maxUsage > 0 && (
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontSize: 12, color: '#57534e', marginBottom: 4 }}>Pou≈æit√≠:</div>
              <div style={{ display: 'flex', gap: 8 }}>
                {[0,1,2].map(i => (
                  <button
                    key={i}
                    onClick={() => onUpdate(slotId, 'usageDots', i < (item.usageDots||0) ? i : i+1)}
                    style={{
                      width: 28, height: 28, borderRadius: '50%',
                      border: '3px solid #292524',
                      background: i < (item.usageDots||0) ? '#292524' : 'transparent',
                      cursor: 'pointer'
                    }}
                  />
                ))}
              </div>
            </div>
          )}
          
          {/* Condition info */}
          {isCond && (
            <div style={{ fontSize: 12 }}>
              {item.mechanic && <div style={{ marginBottom: 4, fontStyle: 'italic' }}>{item.mechanic}</div>}
              {item.clear && <div><strong>Odstranƒõn√≠:</strong> {item.clear}</div>}
            </div>
          )}
        </div>
        
        {/* Actions */}
        <div style={{ borderTop: '2px solid #292524', padding: 8, display: 'flex', gap: 8 }}>
          <button
            onClick={() => { onMove(slotId); onClose(); }}
            style={{ flex: 1, padding: '8px', background: '#fef3c7', border: '2px solid #292524', borderRadius: 4, fontWeight: 700, cursor: 'pointer' }}
          >
            ‚Üî P≈ôesunout
          </button>
          <button
            onClick={() => { onRemove(slotId); onClose(); }}
            style={{ flex: 1, padding: '8px', background: '#fecaca', border: '2px solid #292524', borderRadius: 4, fontWeight: 700, cursor: 'pointer' }}
          >
            üóë Smazat
          </button>
        </div>
      </div>
    </div>
  );
};

// Inventory slot
const InvSlot = ({ id, slots, color, onMove, onUpdate, onRemove, updateChar, aboveId, belowId, selectedSlot, setSelectedSlot, setPopupItem, slotSize = 44 }) => {
  const slot = slots?.[id];
  const aboveSlot = aboveId ? slots?.[aboveId] : null;
  
  const isBlocked = aboveSlot?.height === 2;
  const isSelected = selectedSlot === id;
  const isTarget = selectedSlot && selectedSlot !== id;
  
  const colors = {
    amber: { bg: '#fef3c7', border: '#fcd34d', ring: '#f59e0b' },
    blue: { bg: '#dbeafe', border: '#93c5fd', ring: '#3b82f6' },
    stone: { bg: '#f5f5f4', border: '#d6d3d1', ring: '#78716c' }
  };
  const c = colors[color] || colors.stone;
  
  const is2H = slot?.height === 2;
  
  if (isBlocked) {
    return <div style={{ width: slotSize, height: slotSize }} />;
  }
  
  const handleClick = () => {
    if (selectedSlot && selectedSlot !== id) {
      // Move from selected slot to this slot
      onMove(selectedSlot, id);
      setSelectedSlot(null);
    } else if (slot) {
      // Open popup for this item
      setPopupItem({ item: slot, slotId: id });
    }
  };
  
  return (
    <div
      onClick={handleClick}
      style={{
        width: slotSize,
        height: slotSize,
        background: slot ? 'transparent' : c.bg,
        border: slot ? 'none' : `2px dashed ${c.border}`,
        borderRadius: 3,
        display: 'flex',
        alignItems: 'flex-start',
        justifyContent: 'center',
        position: 'relative',
        overflow: is2H ? 'visible' : 'hidden',
        outline: isSelected ? `3px solid ${c.ring}` : (isTarget && !slot ? `2px solid ${c.ring}` : 'none'),
        cursor: 'pointer'
      }}
    >
      {slot && <MiniCard item={slot} is2H={is2H} isSelected={isSelected} slotSize={slotSize} />}
    </div>
  );
};

// Ultra-minimal card (just name + color)
const MiniCard = ({ item, is2H, isSelected, slotSize = 44 }) => {
  const isCond = item.type === 'condition' || item.isCondition;
  const cardSize = slotSize - 4;
  const bg = item.bgColor || (isCond ? '#fecaca' : item.type === 'weapon' ? '#f1f5f9' : item.type === 'armor' ? '#e0e7ff' : '#fef3c7');
  
  // Dynamic font size based on slot size
  const fontSize = Math.max(8, Math.floor(slotSize * 0.18));
  const fontSize2H = Math.max(9, Math.floor(slotSize * 0.16));
  const dotSize = Math.max(4, Math.floor(slotSize * 0.08));
  
  return (
    <div style={{
      width: cardSize,
      height: is2H ? cardSize * 2 + 8 : cardSize,
      background: bg,
      border: isSelected ? '2px solid #f59e0b' : '1.5px solid #292524',
      borderRadius: 3,
      display: 'flex',
      flexDirection: 'column',
      justifyContent: 'center',
      alignItems: 'center',
      position: is2H ? 'absolute' : 'relative',
      top: 0, left: 2, zIndex: is2H ? 10 : 1,
      boxShadow: isSelected ? '0 0 8px rgba(245, 158, 11, 0.5)' : 'none',
      padding: 2,
      textAlign: 'center'
    }}>
      <span style={{ 
        fontWeight: 700, 
        fontSize: is2H ? fontSize2H : fontSize,
        lineHeight: 1.1,
        overflow: 'hidden',
        display: '-webkit-box',
        WebkitLineClamp: is2H ? 4 : 2,
        WebkitBoxOrient: 'vertical'
      }}>
        {item.name}
      </span>
      {/* Small indicator for usage */}
      {!isCond && item.maxUsage > 0 && item.usageDots > 0 && (
        <div style={{ display: 'flex', gap: 1, marginTop: 2 }}>
          {[0,1,2].map(i => (
            <div key={i} style={{ width: dotSize, height: dotSize, borderRadius: '50%', background: i < item.usageDots ? '#292524' : '#d6d3d1' }} />
          ))}
        </div>
      )}
    </div>
  );
};

// ============================================
// ITEM CARD STUDIO PANEL
// ============================================

const ItemCardStudio = ({ parties, activePartyId, activeCharacterId, updateCharacterInParty }) => {
  const [template, setTemplate] = useState('item');
  const [cardData, setCardData] = useState({
    name: 'Nov√Ω p≈ôedmƒõt',
    type: 'item',
    // Dimensions
    width: 1,
    height: 1,
    // Weapon/Armor specific
    damageDef: '',
    weaponClass: '',
    // Item/Weapon/Armor/Spell specific
    usageDots: 0,
    maxUsage: 3,
    // Condition specific
    mechanic: '',
    clear: '',
    // Freeform only
    star: false,
    // Visual
    icon: 'generic',
    bgColor: '#fef3c7',
    textColor: '#1c1917',
    showDivider: true,
    showBorder: true
  });
  const [libraryFilter, setLibraryFilter] = useState('all');

  // Get active character
  const activeParty = parties?.find(p => p.id === activePartyId);
  const activeCharacter = activeParty?.members?.find(m => m.id === activeCharacterId);

  // Template presets with category-specific defaults
  const templates = {
    item: { 
      type: 'item', 
      bgColor: '#fef3c7', // amber
      textColor: '#1c1917',
      maxUsage: 3,
      width: 1, height: 1,
      damageDef: '', weaponClass: '', mechanic: '', clear: '', star: false
    },
    weapon: { 
      type: 'weapon', 
      bgColor: '#f8fafc', // white
      textColor: '#1c1917',
      maxUsage: 3,
      width: 1, height: 1,
      damageDef: 'k6/k8',
      weaponClass: 'Medium',
      mechanic: '', clear: '', star: false
    },
    armor: { 
      type: 'armor', 
      bgColor: '#f8fafc',
      textColor: '#1c1917',
      maxUsage: 3,
      width: 1, height: 2,
      damageDef: '1 def',
      weaponClass: 'Heavy',
      mechanic: '', clear: '', star: false
    },
    spell: { 
      type: 'spell', 
      bgColor: '#f8fafc',
      textColor: '#1c1917',
      maxUsage: 3,
      width: 1, height: 1,
      damageDef: '', weaponClass: '',
      mechanic: '', clear: '', star: false
    },
    condition: { 
      type: 'condition', 
      bgColor: '#ff4444', // rgb(255, 68, 68)
      textColor: '#1c1917',
      maxUsage: 0,
      width: 1, height: 1,
      damageDef: '', weaponClass: '',
      mechanic: 'Nev√Ωhoda na z√°chranu s√≠ly a obratnosti',
      clear: 'After full rest',
      star: false
    },
    freeform: { 
      type: 'freeform', 
      bgColor: '#f5f5f4',
      textColor: '#1c1917',
      maxUsage: 3,
      width: 1, height: 1,
      damageDef: '', weaponClass: '', mechanic: '', clear: '', star: false
    }
  };

  // Weapon class options
  const weaponClasses = [
    { value: '', label: '---' },
    { value: 'Light', label: 'Light' },
    { value: 'Medium', label: 'Medium' },
    { value: 'Heavy', label: 'Heavy' }
  ];

  // Image/icon options - matching original exactly
  const iconOptions = [
    { value: 'generic', label: 'Nic' },
    { value: 'custom', label: 'Vlastn√≠...' },
    { value: 'divider1', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', disabled: true },
    { value: 'torch', label: 'Pochode≈à' },
    { value: 'lantern', label: 'Lucerna' },
    { value: 'flashlight', label: 'Elektrick√° sv√≠tilna' },
    { value: 'pouch', label: 'V√°ƒçek na ƒèobky' },
    { value: 'quiver', label: 'Toulec' },
    { value: 'rations', label: 'Z√°soby' },
    { value: 'stones', label: 'Kameny' },
    { value: 'divider2', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', disabled: true },
    { value: 'branch', label: 'Vƒõtev' },
    { value: 'dagger', label: 'D√Ωka' },
    { value: 'needle', label: 'Jehla' },
    { value: 'axe', label: 'Sekera' },
    { value: 'sword', label: 'Meƒç' },
    { value: 'mace', label: 'Palc√°t' },
    { value: 'warhammer', label: 'V√°leƒçn√© kladivo' },
    { value: 'spear', label: 'Kop√≠' },
    { value: 'hook', label: 'H√°kop√≠' },
    { value: 'bow', label: '"Luk"' },
    { value: 'sling', label: 'Prak' },
    { value: 'divider3', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', disabled: true },
    { value: 'heavyarmor', label: 'Tƒõ≈æk√° zbroj' },
    { value: 'lightarmor', label: 'Lehk√° zbroj' },
    { value: 'divider4', label: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', disabled: true },
    { value: 'spell1', label: 'Kouzlo 1' },
    { value: 'spell2', label: 'Kouzlo 2' },
    { value: 'spell3', label: 'Kouzlo 3' },
    { value: 'spell4', label: 'Kouzlo 4' },
    { value: 'spell5', label: 'Kouzlo 5' },
    { value: 'spellempty', label: 'Kouzlo (pr√°zdn√©)' }
  ];

  // Handle template change
  const handleTemplateChange = (newTemplate) => {
    setTemplate(newTemplate);
    const preset = templates[newTemplate];
    setCardData(prev => ({
      ...prev,
      ...preset,
      name: newTemplate === 'condition' ? 'Nov√Ω stav' : 
            newTemplate === 'weapon' ? 'Nov√° zbra≈à' :
            newTemplate === 'armor' ? 'Nov√° zbroj' :
            newTemplate === 'spell' ? 'Nov√© kouzlo' : 'Nov√Ω p≈ôedmƒõt'
    }));
  };

  // Calculate slots from width √ó height
  const calculateSlots = () => cardData.width * cardData.height;

  // Add to character inventory
  const addToInventory = () => {
    if (!activeCharacter || !activePartyId) {
      alert('Nejprve vyber postavu v z√°lo≈æce Postavy');
      return;
    }

    const slots = activeCharacter.inventorySlots || {};
    const packSlots = ['pack1', 'pack2', 'pack3', 'pack4', 'pack5', 'pack6'];
    const emptySlot = packSlots.find(s => !slots[s]);
    
    if (!emptySlot) {
      alert('Batoh je pln√Ω!');
      return;
    }

    const newItem = {
      id: Math.random().toString(36).substr(2, 9),
      ...cardData,
      slots: calculateSlots()
    };

    updateCharacterInParty(activePartyId, activeCharacterId, {
      inventorySlots: { ...slots, [emptySlot]: newItem }
    });

    alert(`"${cardData.name}" p≈ôid√°no do invent√°≈ôe ${activeCharacter.name}!`);
  };

  // Add from library
  const addFromLibrary = (libraryItem) => {
    if (!activeCharacter || !activePartyId) {
      alert('Nejprve vyber postavu v z√°lo≈æce Postavy');
      return;
    }

    const slots = activeCharacter.inventorySlots || {};
    const packSlots = ['pack1', 'pack2', 'pack3', 'pack4', 'pack5', 'pack6'];
    const emptySlot = packSlots.find(s => !slots[s]);
    
    if (!emptySlot) {
      alert('Batoh je pln√Ω!');
      return;
    }

    const newItem = {
      id: Math.random().toString(36).substr(2, 9),
      ...libraryItem,
      usageDots: 0
    };

    updateCharacterInParty(activePartyId, activeCharacterId, {
      inventorySlots: { ...slots, [emptySlot]: newItem }
    });

    alert(`"${libraryItem.name}" p≈ôid√°no do invent√°≈ôe ${activeCharacter.name}!`);
  };

  // Updated library with proper Mausritter data
  const itemLibrary = {
    weapons: [
      { name: 'Jehla', type: 'weapon', damageDef: 'k6', weaponClass: 'Light', width: 1, height: 1, maxUsage: 3, icon: 'needle' },
      { name: 'D√Ωka', type: 'weapon', damageDef: 'k6', weaponClass: 'Light', width: 1, height: 1, maxUsage: 3, icon: 'dagger' },
      { name: 'Vƒõtev', type: 'weapon', damageDef: 'k6', weaponClass: 'Light', width: 1, height: 1, maxUsage: 3, icon: 'branch' },
      { name: 'Meƒç', type: 'weapon', damageDef: 'k6/k8', weaponClass: 'Medium', width: 1, height: 1, maxUsage: 3, icon: 'sword' },
      { name: 'Sekera', type: 'weapon', damageDef: 'k6/k8', weaponClass: 'Medium', width: 1, height: 1, maxUsage: 3, icon: 'axe' },
      { name: 'Palc√°t', type: 'weapon', damageDef: 'k6/k8', weaponClass: 'Medium', width: 1, height: 1, maxUsage: 3, icon: 'mace' },
      { name: 'V√°leƒçn√© kladivo', type: 'weapon', damageDef: 'k6/k8', weaponClass: 'Medium', width: 1, height: 1, maxUsage: 3, icon: 'warhammer' },
      { name: 'Kop√≠', type: 'weapon', damageDef: 'k10', weaponClass: 'Heavy', width: 1, height: 2, maxUsage: 3, icon: 'spear' },
      { name: 'H√°kop√≠', type: 'weapon', damageDef: 'k10', weaponClass: 'Heavy', width: 1, height: 2, maxUsage: 3, icon: 'hook' },
      { name: '"Luk"', type: 'weapon', damageDef: 'k6', weaponClass: 'Medium', width: 2, height: 1, maxUsage: 3, icon: 'bow' },
      { name: 'Prak', type: 'weapon', damageDef: 'k6', weaponClass: 'Light', width: 1, height: 1, maxUsage: 3, icon: 'sling' },
    ],
    armor: [
      { name: 'Lehk√° zbroj', type: 'armor', damageDef: '1 def', weaponClass: 'Light', width: 1, height: 1, maxUsage: 3, icon: 'lightarmor' },
      { name: 'Tƒõ≈æk√° zbroj', type: 'armor', damageDef: '1 def', weaponClass: 'Heavy', width: 1, height: 2, maxUsage: 3, icon: 'heavyarmor' },
    ],
    items: [
      { name: 'Pochode≈à', type: 'item', width: 1, height: 1, maxUsage: 3, icon: 'torch' },
      { name: 'Lucerna', type: 'item', width: 1, height: 1, maxUsage: 3, icon: 'lantern' },
      { name: 'Elektrick√° sv√≠tilna', type: 'item', width: 1, height: 1, maxUsage: 3, icon: 'flashlight' },
      { name: 'V√°ƒçek na ƒèobky', type: 'item', width: 1, height: 1, maxUsage: 0, icon: 'pouch' },
      { name: 'Toulec', type: 'item', width: 1, height: 1, maxUsage: 3, icon: 'quiver' },
      { name: 'Z√°soby', type: 'item', width: 1, height: 1, maxUsage: 3, icon: 'rations' },
      { name: 'Kameny', type: 'item', width: 1, height: 1, maxUsage: 3, icon: 'stones' },
    ],
    conditions: [
      { name: 'Vyƒçerpan√Ω', type: 'condition', width: 1, height: 1, maxUsage: 0, icon: 'generic', bgColor: '#ff4444', mechanic: 'Nev√Ωhoda na fyzick√© hody', clear: 'After full rest' },
      { name: 'Vystra≈°en√Ω', type: 'condition', width: 1, height: 1, maxUsage: 0, icon: 'generic', bgColor: '#ff4444', mechanic: 'Mus√≠ prchat od zdroje strachu', clear: 'After safe rest' },
      { name: 'Zranƒõn√Ω', type: 'condition', width: 1, height: 1, maxUsage: 0, icon: 'generic', bgColor: '#ff4444', mechanic: 'Nev√Ωhoda na z√°chranu S√çL a MR≈†', clear: 'After full rest' },
      { name: 'Hladov√Ω', type: 'condition', width: 1, height: 1, maxUsage: 0, icon: 'generic', bgColor: '#ff4444', mechanic: '-1 na v≈°echny hody', clear: 'After eating' },
      { name: 'Nemocn√Ω', type: 'condition', width: 1, height: 1, maxUsage: 0, icon: 'generic', bgColor: '#ff4444', mechanic: 'Nem≈Ø≈æe se l√©ƒçit p≈ôirozenƒõ', clear: 'After treatment or week' },
      { name: 'Otr√°ven√Ω', type: 'condition', width: 1, height: 1, maxUsage: 0, icon: 'generic', bgColor: '#ff4444', mechanic: '1 po≈°kozen√≠ za smƒõnu', clear: 'After antidote' },
    ],
    spells: [
      { name: 'Kouzlo 1', type: 'spell', width: 1, height: 1, maxUsage: 3, icon: 'spell1' },
      { name: 'Kouzlo 2', type: 'spell', width: 1, height: 1, maxUsage: 3, icon: 'spell2' },
      { name: 'Kouzlo 3', type: 'spell', width: 1, height: 1, maxUsage: 3, icon: 'spell3' },
      { name: 'Kouzlo 4', type: 'spell', width: 1, height: 1, maxUsage: 3, icon: 'spell4' },
      { name: 'Kouzlo 5', type: 'spell', width: 1, height: 1, maxUsage: 3, icon: 'spell5' },
    ]
  };

  // Filter library items
  const getFilteredLibrary = () => {
    if (libraryFilter === 'all') {
      return [
        ...itemLibrary.weapons,
        ...itemLibrary.armor,
        ...itemLibrary.items,
        ...itemLibrary.conditions,
        ...itemLibrary.spells
      ];
    }
    return itemLibrary[libraryFilter] || [];
  };

  // Visual Card Preview - compact professional style
  const CardPreview = () => {
    const isCond = cardData.type === 'condition';
    const isWA = cardData.type === 'weapon' || cardData.type === 'armor';
    
    // 70px base for consistency with inventory
    const w = cardData.width * 70;
    const h = cardData.height * 70;
    
    return (
      <div style={{
        width: w, height: h,
        background: cardData.bgColor,
        border: '2px solid #292524',
        borderRadius: 4,
        display: 'flex',
        flexDirection: 'column',
        overflow: 'hidden',
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
      }}>
        {/* Header */}
        <div style={{
          background: isCond ? cardData.bgColor : '#fff',
          borderBottom: '2px solid #292524',
          padding: '3px 6px',
          fontWeight: 700,
          fontSize: 11,
          color: cardData.textColor
        }}>
          {cardData.name}
        </div>
        
        {/* Stats row */}
        {!isCond && (
          <div style={{ padding: '3px 6px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', borderBottom: '1px solid #d6d3d1' }}>
            {cardData.maxUsage > 0 ? (
              <div style={{ display: 'flex', gap: 3 }}>
                {Array(Math.min(cardData.maxUsage, 6)).fill(0).map((_, i) => (
                  <div key={i} style={{ width: 10, height: 10, borderRadius: '50%', border: '2px solid #292524', background: i < cardData.usageDots ? '#292524' : 'transparent' }} />
                ))}
              </div>
            ) : <span />}
            {cardData.damageDef && (
              <span style={{ background: '#fff', border: '1px solid #292524', borderRadius: 2, padding: '0 4px', fontSize: 10, fontWeight: 700 }}>
                {cardData.damageDef}
              </span>
            )}
          </div>
        )}
        
        {/* Content */}
        {isCond ? (
          <div style={{ flex: 1, padding: 6, fontSize: 10, color: cardData.textColor, display: 'flex', flexDirection: 'column' }}>
            <div style={{ flex: 1, fontStyle: 'italic' }}>{cardData.mechanic}</div>
            <div style={{ borderTop: '1px solid rgba(0,0,0,0.2)', paddingTop: 4, marginTop: 4 }}>
              <strong>Clear:</strong> {cardData.clear}
            </div>
          </div>
        ) : (
          <div style={{ flex: 1 }} />
        )}
        
        {/* Footer */}
        {isWA && cardData.weaponClass && (
          <div style={{ borderTop: '1px solid #d6d3d1', padding: '2px 6px', fontSize: 10, color: cardData.textColor }}>
            {cardData.weaponClass}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="space-y-6">
      <SectionHeader 
        icon="üé¥" 
        title="Item Card Studio" 
        subtitle="Vytvo≈ô vlastn√≠ kartiƒçky jako v origin√°le"
      />

      <div className="grid lg:grid-cols-2 gap-6">
        {/* Editor */}
        <ResultCard title="üìù Editor kartiƒçky">
          {/* Template selector */}
          <div className="mb-4">
            <label className="text-sm font-bold text-stone-500 block mb-2">≈†ablona</label>
            <select
              value={template}
              onChange={(e) => handleTemplateChange(e.target.value)}
              className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
            >
              <option value="item">P≈ôedmƒõt</option>
              <option value="weapon">Zbra≈à</option>
              <option value="armor">Zbroj</option>
              <option value="spell">Kouzlo</option>
              <option value="condition">Stav</option>
              <option value="freeform">Freeform</option>
            </select>
          </div>

          {/* Name */}
          <div className="mb-4">
            <label className="text-sm font-bold text-stone-500 block mb-2">N√°zev:</label>
            <input
              value={cardData.name}
              onChange={(e) => setCardData(prev => ({ ...prev, name: e.target.value }))}
              className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
            />
          </div>

          {/* WEAPON FIELDS: Damage/Def, Class, Pou≈æit√≠, Obr√°zek */}
          {template === 'weapon' && (
            <>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="text-sm font-bold text-stone-500 block mb-2">Damage/Def:</label>
                  <input
                    value={cardData.damageDef}
                    onChange={(e) => setCardData(prev => ({ ...prev, damageDef: e.target.value }))}
                    className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                    placeholder="k6/k8"
                  />
                </div>
                <div>
                  <label className="text-sm font-bold text-stone-500 block mb-2">Class:</label>
                  <select
                    value={cardData.weaponClass}
                    onChange={(e) => setCardData(prev => ({ ...prev, weaponClass: e.target.value }))}
                    className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
                  >
                    {weaponClasses.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
              </div>
            </>
          )}

          {/* ARMOR FIELDS: Damage/Def, Class, Pou≈æit√≠, Obr√°zek */}
          {template === 'armor' && (
            <>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="text-sm font-bold text-stone-500 block mb-2">Damage/Def:</label>
                  <input
                    value={cardData.damageDef}
                    onChange={(e) => setCardData(prev => ({ ...prev, damageDef: e.target.value }))}
                    className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                    placeholder="1 def"
                  />
                </div>
                <div>
                  <label className="text-sm font-bold text-stone-500 block mb-2">Class:</label>
                  <select
                    value={cardData.weaponClass}
                    onChange={(e) => setCardData(prev => ({ ...prev, weaponClass: e.target.value }))}
                    className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
                  >
                    <option value="Light">Light</option>
                    <option value="Heavy">Heavy</option>
                  </select>
                </div>
              </div>
            </>
          )}

          {/* CONDITION FIELDS: Mechanic, Clear (NO Pou≈æit√≠, NO Obr√°zek) */}
          {template === 'condition' && (
            <>
              <div className="mb-4">
                <label className="text-sm font-bold text-stone-500 block mb-2">Mechanic:</label>
                <input
                  value={cardData.mechanic}
                  onChange={(e) => setCardData(prev => ({ ...prev, mechanic: e.target.value }))}
                  className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                  placeholder="Nev√Ωhoda na z√°chranu s√≠ly a obratnosti"
                />
              </div>
              <div className="mb-4">
                <label className="text-sm font-bold text-stone-500 block mb-2">Clear:</label>
                <input
                  value={cardData.clear}
                  onChange={(e) => setCardData(prev => ({ ...prev, clear: e.target.value }))}
                  className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                  placeholder="After full rest"
                />
              </div>
            </>
          )}

          {/* FREEFORM FIELDS: ALL fields */}
          {template === 'freeform' && (
            <>
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="text-sm font-bold text-stone-500 block mb-2">Damage/Def:</label>
                  <input
                    value={cardData.damageDef}
                    onChange={(e) => setCardData(prev => ({ ...prev, damageDef: e.target.value }))}
                    className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                  />
                </div>
                <div>
                  <label className="text-sm font-bold text-stone-500 block mb-2">Class:</label>
                  <select
                    value={cardData.weaponClass}
                    onChange={(e) => setCardData(prev => ({ ...prev, weaponClass: e.target.value }))}
                    className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
                  >
                    {weaponClasses.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
              </div>
              <div className="mb-4">
                <label className="text-sm font-bold text-stone-500 block mb-2">Mechanic:</label>
                <input
                  value={cardData.mechanic}
                  onChange={(e) => setCardData(prev => ({ ...prev, mechanic: e.target.value }))}
                  className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                />
              </div>
              <div className="mb-4">
                <label className="text-sm font-bold text-stone-500 block mb-2">Clear:</label>
                <input
                  value={cardData.clear}
                  onChange={(e) => setCardData(prev => ({ ...prev, clear: e.target.value }))}
                  className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
                />
              </div>
              <div className="mb-4">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={cardData.star}
                    onChange={(e) => setCardData(prev => ({ ...prev, star: e.target.checked }))}
                    className="w-4 h-4"
                  />
                  <span className="text-sm font-bold text-stone-500">Star:</span>
                </label>
              </div>
            </>
          )}

          {/* POU≈ΩIT√ç - for all except condition */}
          {template !== 'condition' && (
            <div className="mb-4">
              <label className="text-sm font-bold text-stone-500 block mb-2">Pou≈æit√≠:</label>
              <input
                type="number"
                min="0"
                max="6"
                value={cardData.maxUsage}
                onChange={(e) => setCardData(prev => ({ ...prev, maxUsage: parseInt(e.target.value) || 0 }))}
                className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg"
              />
            </div>
          )}

          {/* OBR√ÅZEK - for all except condition */}
          {template !== 'condition' && (
            <div className="mb-4">
              <label className="text-sm font-bold text-stone-500 block mb-2">Obr√°zek:</label>
              <select
                value={cardData.icon}
                onChange={(e) => setCardData(prev => ({ ...prev, icon: e.target.value }))}
                className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
              >
                {iconOptions.map(opt => (
                  <option key={opt.value} value={opt.value} disabled={opt.disabled}>
                    {opt.label}
                  </option>
                ))}
              </select>
            </div>
          )}

          {/* DIMENSIONS - Width √ó Height */}
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label className="text-sm font-bold text-stone-500 block mb-2">≈†√≠≈ôka</label>
              <select
                value={cardData.width}
                onChange={(e) => setCardData(prev => ({ ...prev, width: parseInt(e.target.value) }))}
                className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
              >
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <label className="text-sm font-bold text-stone-500 block mb-2">V√Ω≈°ka</label>
              <select
                value={cardData.height}
                onChange={(e) => setCardData(prev => ({ ...prev, height: parseInt(e.target.value) }))}
                className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
              >
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
          </div>

          {/* COLORS */}
          <div className="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label className="text-sm font-bold text-stone-500 block mb-2">Pozad√≠</label>
              <input
                type="color"
                value={cardData.bgColor}
                onChange={(e) => setCardData(prev => ({ ...prev, bgColor: e.target.value }))}
                className="w-full h-10 rounded-lg cursor-pointer border-2 border-amber-300"
              />
            </div>
            <div>
              <label className="text-sm font-bold text-stone-500 block mb-2">Text</label>
              <input
                type="color"
                value={cardData.textColor}
                onChange={(e) => setCardData(prev => ({ ...prev, textColor: e.target.value }))}
                className="w-full h-10 rounded-lg cursor-pointer border-2 border-amber-300"
              />
            </div>
          </div>

          {/* OPTIONS */}
          <div className="flex gap-4 mb-4">
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={cardData.showDivider}
                onChange={(e) => setCardData(prev => ({ ...prev, showDivider: e.target.checked }))}
                className="w-4 h-4"
              />
              <span className="text-sm">Oddƒõlovaƒç</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                checked={cardData.showBorder}
                onChange={(e) => setCardData(prev => ({ ...prev, showBorder: e.target.checked }))}
                className="w-4 h-4"
              />
              <span className="text-sm">Okraj</span>
            </label>
          </div>

          {/* ADD BUTTON */}
          <Button onClick={addToInventory} className="w-full">
            ‚ûï P≈ôidat do invent√°≈ôe {activeCharacter?.name || '(vyber postavu)'}
          </Button>
        </ResultCard>

        {/* Preview & Library */}
        <div className="space-y-6">
          {/* Preview */}
          <ResultCard title="üëÅÔ∏è N√°hled">
            <div className="flex items-center justify-center py-3 bg-stone-100 rounded">
              <CardPreview />
            </div>
            <p className="text-xs text-stone-400 text-center mt-1">
              {cardData.width}√ó{cardData.height}
            </p>
          </ResultCard>

          {/* Library */}
          <ResultCard title="üìö Knihovna p≈ôedmƒõt≈Ø">
            <div className="mb-4">
              <select
                value={libraryFilter}
                onChange={(e) => setLibraryFilter(e.target.value)}
                className="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white"
              >
                <option value="all">V≈°e</option>
                <option value="weapons">‚öîÔ∏è Zbranƒõ</option>
                <option value="armor">üõ°Ô∏è Zbroje</option>
                <option value="items">üì¶ P≈ôedmƒõty</option>
                <option value="conditions">ü©π Stavy</option>
              </select>
            </div>
            
            <div className="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto">
              {getFilteredLibrary().map((item, idx) => (
                <button
                  key={idx}
                  onClick={() => addFromLibrary(item)}
                  className={`p-2 rounded-lg text-left text-sm transition-all hover:shadow-md border-2 ${
                    item.type === 'condition' ? 'bg-red-100 hover:bg-red-200 border-red-300' :
                    item.type === 'weapon' ? 'bg-slate-100 hover:bg-slate-200 border-slate-300' :
                    item.type === 'armor' ? 'bg-blue-100 hover:bg-blue-200 border-blue-300' :
                    'bg-amber-100 hover:bg-amber-200 border-amber-300'
                  }`}
                >
                  <div className="font-bold truncate text-xs">
                    {item.name}
                  </div>
                  <div className="text-xs text-stone-500 flex items-center gap-1">
                    {item.damage && <span className="bg-white px-1 rounded">{item.damage}</span>}
                    {item.defense && <span className="bg-white px-1 rounded">{item.defense}</span>}
                    {item.weaponClass && <span>{item.weaponClass}</span>}
                    <span className="ml-auto">{item.width}√ó{item.height}</span>
                  </div>
                  {item.mechanic && <div className="text-xs text-red-600 truncate">{item.mechanic}</div>}
                </button>
              ))}
            </div>
          </ResultCard>
        </div>
      </div>
    </div>
  );
};

// ============================================
// WORLD GENERATOR PANEL
// ============================================

const WorldPanel = ({ onLogEntry, settlements, setSettlements, worldNPCs, setWorldNPCs, parties, activeParty }) => {
  const [generated, setGenerated] = useState(null);
  const [activeGen, setActiveGen] = useState('mySettlements');
  const [season, setSeason] = useState('spring');
  const [creatureCategory, setCreatureCategory] = useState('all');
  const [selectedCreature, setSelectedCreature] = useState(null);
  const [editingSettlement, setEditingSettlement] = useState(null);
  const [editingNPC, setEditingNPC] = useState(null);
  const [viewingSettlement, setViewingSettlement] = useState(null);

  // ========== SETTLEMENT MANAGEMENT ==========
  const createEmptySettlement = () => {
    const newSettlement = {
      id: generateId(),
      name: 'Nov√° osada',
      size: 'Osada',
      population: '',
      landmark: '',
      feature: '',
      event: '',
      ruler: null, // NPC id
      notes: '',
      npcs: [] // NPC ids
    };
    setSettlements([...settlements, newSettlement]);
    setEditingSettlement(newSettlement.id);
  };

  const saveSettlementToWorld = (settlementData) => {
    const newSettlement = {
      id: generateId(),
      ...settlementData,
      npcs: []
    };
    setSettlements([...settlements, newSettlement]);
    setGenerated(null);
  };

  const updateSettlement = (id, updates) => {
    setSettlements(settlements.map(s => s.id === id ? { ...s, ...updates } : s));
  };

  const deleteSettlement = (id) => {
    setSettlements(settlements.filter(s => s.id !== id));
    // Remove settlement reference from NPCs
    setWorldNPCs(worldNPCs.map(n => n.settlementId === id ? { ...n, settlementId: null } : n));
  };

  // ========== NPC MANAGEMENT ==========
  const createEmptyNPC = (settlementId = null) => {
    const newNPC = {
      id: generateId(),
      name: 'Nov√° postava',
      birthsign: '',
      physicalDetail: '',
      quirk: '',
      goal: '',
      role: '',
      settlementId,
      notes: ''
    };
    setWorldNPCs([...worldNPCs, newNPC]);
    setEditingNPC(newNPC.id);
    return newNPC;
  };

  const saveNPCToWorld = (npcData, settlementId = null) => {
    const newNPC = {
      id: generateId(),
      ...npcData,
      settlementId
    };
    setWorldNPCs([...worldNPCs, newNPC]);
    if (settlementId) {
      updateSettlement(settlementId, { 
        npcs: [...(settlements.find(s => s.id === settlementId)?.npcs || []), newNPC.id] 
      });
    }
    setGenerated(null);
  };

  const updateNPC = (id, updates) => {
    setWorldNPCs(worldNPCs.map(n => n.id === id ? { ...n, ...updates } : n));
  };

  const deleteNPC = (id) => {
    setWorldNPCs(worldNPCs.filter(n => n.id !== id));
    // Remove NPC from settlements
    setSettlements(settlements.map(s => ({ 
      ...s, 
      npcs: s.npcs?.filter(npcId => npcId !== id) || [],
      ruler: s.ruler === id ? null : s.ruler
    })));
  };

  const assignNPCToSettlement = (npcId, settlementId) => {
    // Remove from old settlement
    const oldNPC = worldNPCs.find(n => n.id === npcId);
    if (oldNPC?.settlementId) {
      const oldSettlement = settlements.find(s => s.id === oldNPC.settlementId);
      if (oldSettlement) {
        updateSettlement(oldSettlement.id, { 
          npcs: oldSettlement.npcs?.filter(id => id !== npcId) || [] 
        });
      }
    }
    // Add to new settlement
    if (settlementId) {
      const newSettlement = settlements.find(s => s.id === settlementId);
      if (newSettlement) {
        updateSettlement(settlementId, { 
          npcs: [...(newSettlement.npcs || []), npcId] 
        });
      }
    }
    // Update NPC
    updateNPC(npcId, { settlementId });
  };

  // Generate random creature
  const generateCreature = (category = 'all') => {
    let pool = BESTIARY;
    if (category !== 'all') {
      pool = BESTIARY.filter(c => c.category === category);
    }
    const creature = randomFrom(pool);
    setSelectedCreature(creature);
    
    onLogEntry({
      type: 'discovery',
      subtype: 'creature',
      timestamp: formatTimestamp(),
      data: creature
    });
  };

  const generateSettlement = () => {
    const landmark = randomFrom(LANDMARKS);
    const size = ['Osada', 'Vesnice', 'Mƒõsto'][rollD6() <= 2 ? 0 : rollD6() <= 5 ? 1 : 2];
    const feature = randomFrom(SETTLEMENT_FEATURES);
    const event = randomFrom(SETTLEMENT_EVENTS);
    const firstName = randomFrom(FIRST_NAMES);
    const lastName = randomFrom(LAST_NAMES).split(/(?=[A-Z])/)[0]; // First part of compound name
    
    const settlement = {
      type: 'settlement',
      name: `${firstName} ${lastName}`,
      landmark,
      size,
      feature,
      event,
      npcs: []
    };
    
    setGenerated(settlement);
    onLogEntry({
      type: 'discovery',
      subtype: 'settlement',
      timestamp: formatTimestamp(),
      data: settlement
    });
  };

  const generateNPC = () => {
    const npc = {
      type: 'npc',
      name: `${randomFrom(FIRST_NAMES)} ${randomFrom(LAST_NAMES)}`,
      birthsign: randomFrom(BIRTHSIGNS),
      physicalDetail: randomFrom(PHYSICAL_DETAILS),
      quirk: randomFrom(NPC_QUIRKS),
      goal: randomFrom(NPC_GOALS),
      reaction: roll2D6()
    };
    
    setGenerated(npc);
    onLogEntry({
      type: 'discovery',
      subtype: 'npc',
      timestamp: formatTimestamp(),
      data: npc
    });
  };

  const generateDungeon = () => {
    const theme = randomFrom(DUNGEON_THEMES);
    const denizens = randomFrom(DUNGEON_DENIZENS);
    const rooms = [];
    
    // Generate 5 rooms
    for (let i = 0; i < 5; i++) {
      const exits = rollD6();
      const contents = ['Pr√°zdno', 'Past/Nebezpeƒç√≠', 'Poklad', 'Mal√© setk√°n√≠', 'Velk√© setk√°n√≠', 'Speci√°ln√≠'][rollD6() - 1];
      rooms.push({
        number: i + 1,
        type: exits <= 2 ? 'Chodba' : exits <= 4 ? 'Mal√° m√≠stnost' : 'Velk√° m√≠stnost',
        exits: exits <= 1 ? 'Slep√° uliƒçka' : exits <= 3 ? '1 v√Ωchod' : exits <= 5 ? '2 v√Ωchody' : '3+ v√Ωchody',
        contents
      });
    }
    
    const dungeon = {
      type: 'dungeon',
      theme,
      denizens,
      rooms
    };
    
    setGenerated(dungeon);
    onLogEntry({
      type: 'discovery',
      subtype: 'dungeon',
      timestamp: formatTimestamp(),
      data: dungeon
    });
  };

  const generateWeather = () => {
    const { dice, total } = roll2D6();
    const weather = WEATHER_TABLE[season][total];
    
    const result = {
      type: 'weather',
      season,
      dice,
      total,
      weather
    };
    
    setGenerated(result);
    onLogEntry({
      type: 'world_event',
      subtype: 'weather',
      timestamp: formatTimestamp(),
      data: result
    });
  };

  const genTabs = [
    { id: 'mySettlements', label: 'Moje osady', icon: 'üó∫Ô∏è' },
    { id: 'myNPCs', label: 'Moji NPC', icon: 'üë•' },
    { id: 'settlement', label: '+ Osada', icon: 'üèòÔ∏è' },
    { id: 'npc', label: '+ NPC', icon: 'üê≠' },
    { id: 'dungeon', label: 'Dungeon', icon: 'üóùÔ∏è' },
    { id: 'bestiary', label: 'Besti√°≈ô', icon: 'üêõ' },
    { id: 'weather', label: 'Poƒças√≠', icon: '‚òÄÔ∏è' }
  ];

  return (
    <div className="space-y-6">
      <SectionHeader 
        icon="üåç" 
        title="Gener√°tor svƒõta" 
        subtitle="Vytvo≈ô m√≠sta, postavy a ud√°losti"
      />

      <TabNav tabs={genTabs} activeTab={activeGen} onTabChange={setActiveGen} />

      {/* ========== MY SETTLEMENTS ========== */}
      {activeGen === 'mySettlements' && (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <p className="text-stone-600">Spr√°va osad a mƒõst ve tv√©m svƒõtƒõ</p>
            <Button onClick={createEmptySettlement}>+ Nov√° osada</Button>
          </div>

          {settlements.length === 0 ? (
            <ResultCard>
              <p className="text-center text-stone-500 py-8">
                Zat√≠m nem√°≈° ≈æ√°dn√© osady.<br/>
                <span className="text-sm">Vytvo≈ô novou nebo vygeneruj pomoc√≠ "+ Osada"</span>
              </p>
            </ResultCard>
          ) : (
            <div className="space-y-3">
              {settlements.map(settlement => (
                <ResultCard key={settlement.id}>
                  {editingSettlement === settlement.id ? (
                    // Edit mode
                    <div className="space-y-3">
                      <Input 
                        value={settlement.name} 
                        onChange={(v) => updateSettlement(settlement.id, { name: v })}
                        placeholder="Jm√©no osady"
                        className="font-bold"
                      />
                      <div className="grid grid-cols-2 gap-3">
                        <Select
                          value={settlement.size}
                          onChange={(v) => updateSettlement(settlement.id, { size: v })}
                          options={[
                            { value: 'Osada', label: 'Osada (do 20 my≈°√≠)' },
                            { value: 'Vesnice', label: 'Vesnice (20-100 my≈°√≠)' },
                            { value: 'Mƒõsto', label: 'Mƒõsto (100+ my≈°√≠)' }
                          ]}
                        />
                        <Input 
                          value={settlement.population || ''} 
                          onChange={(v) => updateSettlement(settlement.id, { population: v })}
                          placeholder="Populace (ƒç√≠slo)"
                        />
                      </div>
                      <Input 
                        value={settlement.landmark || ''} 
                        onChange={(v) => updateSettlement(settlement.id, { landmark: v })}
                        placeholder="Landmark (co je pobl√≠≈æ)"
                      />
                      <Input 
                        value={settlement.feature || ''} 
                        onChange={(v) => updateSettlement(settlement.id, { feature: v })}
                        placeholder="Zaj√≠mavost (ƒç√≠m je zn√°m√°)"
                      />
                      <Input 
                        value={settlement.event || ''} 
                        onChange={(v) => updateSettlement(settlement.id, { event: v })}
                        placeholder="Aktu√°ln√≠ ud√°lost/probl√©m"
                      />
                      <Select
                        value={settlement.ruler || ''}
                        onChange={(v) => updateSettlement(settlement.id, { ruler: v || null })}
                        options={[
                          { value: '', label: '‚Äî Vl√°dce (vybrat NPC) ‚Äî' },
                          ...worldNPCs.map(n => ({ value: n.id, label: n.name }))
                        ]}
                      />
                      <textarea
                        value={settlement.notes || ''}
                        onChange={(e) => updateSettlement(settlement.id, { notes: e.target.value })}
                        placeholder="Pozn√°mky..."
                        className="w-full h-20 px-3 py-2 border border-stone-300 rounded-lg resize-none"
                      />
                      <div className="flex justify-between">
                        <Button variant="ghost" onClick={() => setEditingSettlement(null)}>‚úì Hotovo</Button>
                        <Button variant="ghost" className="text-red-500" onClick={() => deleteSettlement(settlement.id)}>Smazat</Button>
                      </div>
                    </div>
                  ) : (
                    // View mode
                    <div 
                      className="cursor-pointer hover:bg-amber-50 -m-3 p-3 rounded-lg transition-colors"
                      onClick={() => setViewingSettlement(viewingSettlement === settlement.id ? null : settlement.id)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <h3 className="font-bold text-lg text-amber-900">{settlement.name}</h3>
                          <p className="text-sm text-stone-600">
                            {settlement.size}
                            {settlement.population && ` ‚Ä¢ ${settlement.population} my≈°√≠`}
                          </p>
                        </div>
                        <div className="flex gap-2">
                          <span className="text-xs text-stone-400">{settlement.npcs?.length || 0} NPC</span>
                          <button 
                            onClick={(e) => { e.stopPropagation(); setEditingSettlement(settlement.id); }}
                            className="text-stone-400 hover:text-stone-600"
                          >‚úèÔ∏è</button>
                        </div>
                      </div>
                      
                      {viewingSettlement === settlement.id && (
                        <div className="mt-3 pt-3 border-t border-amber-200 space-y-2">
                          {settlement.landmark && <p><span className="text-stone-500">Landmark:</span> {settlement.landmark}</p>}
                          {settlement.feature && <p><span className="text-stone-500">Zaj√≠mavost:</span> {settlement.feature}</p>}
                          {settlement.event && <p><span className="text-stone-500">Ud√°lost:</span> {settlement.event}</p>}
                          {settlement.ruler && (
                            <p><span className="text-stone-500">Vl√°dce:</span> {worldNPCs.find(n => n.id === settlement.ruler)?.name || '?'}</p>
                          )}
                          {settlement.notes && <p className="italic text-stone-600">{settlement.notes}</p>}
                          
                          {/* NPCs in this settlement */}
                          <div className="mt-3">
                            <p className="text-sm font-bold text-stone-700 mb-2">Obyvatel√©:</p>
                            {(settlement.npcs?.length || 0) === 0 ? (
                              <p className="text-sm text-stone-400">≈Ω√°dn√≠ NPC</p>
                            ) : (
                              <div className="flex flex-wrap gap-2">
                                {settlement.npcs?.map(npcId => {
                                  const npc = worldNPCs.find(n => n.id === npcId);
                                  return npc ? (
                                    <span 
                                      key={npcId} 
                                      className="px-2 py-1 bg-amber-100 rounded text-sm cursor-pointer hover:bg-amber-200"
                                      onClick={(e) => { e.stopPropagation(); setActiveGen('myNPCs'); setEditingNPC(npcId); }}
                                    >
                                      üê≠ {npc.name}
                                    </span>
                                  ) : null;
                                })}
                              </div>
                            )}
                            <Button 
                              variant="ghost" 
                              size="small" 
                              className="mt-2"
                              onClick={(e) => { e.stopPropagation(); createEmptyNPC(settlement.id); setActiveGen('myNPCs'); }}
                            >
                              + P≈ôidat NPC
                            </Button>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </ResultCard>
              ))}
            </div>
          )}

          {/* Party location */}
          {activeParty && (
            <ResultCard>
              <h4 className="font-bold text-amber-900 mb-2">üìç Pozice dru≈æiny: {activeParty.name}</h4>
              <Select
                value={activeParty.currentSettlement || ''}
                onChange={(v) => {
                  // This would need to be passed from App
                }}
                options={[
                  { value: '', label: '‚Äî Na cestƒõ / nezn√°mo ‚Äî' },
                  ...settlements.map(s => ({ value: s.id, label: s.name }))
                ]}
              />
            </ResultCard>
          )}
        </div>
      )}

      {/* ========== MY NPCs ========== */}
      {activeGen === 'myNPCs' && (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <p className="text-stone-600">V≈°echny postavy ve tv√©m svƒõtƒõ</p>
            <Button onClick={() => createEmptyNPC()}>+ Nov√° postava</Button>
          </div>

          {worldNPCs.length === 0 ? (
            <ResultCard>
              <p className="text-center text-stone-500 py-8">
                Zat√≠m nem√°≈° ≈æ√°dn√© NPC.<br/>
                <span className="text-sm">Vytvo≈ô novou nebo vygeneruj pomoc√≠ "+ NPC"</span>
              </p>
            </ResultCard>
          ) : (
            <div className="space-y-3">
              {worldNPCs.map(npc => (
                <ResultCard key={npc.id}>
                  {editingNPC === npc.id ? (
                    // Edit mode
                    <div className="space-y-3">
                      <Input 
                        value={npc.name} 
                        onChange={(v) => updateNPC(npc.id, { name: v })}
                        placeholder="Jm√©no"
                        className="font-bold"
                      />
                      <div className="grid grid-cols-2 gap-3">
                        <Input 
                          value={npc.role || ''} 
                          onChange={(v) => updateNPC(npc.id, { role: v })}
                          placeholder="Role/povol√°n√≠"
                        />
                        <Select
                          value={npc.settlementId || ''}
                          onChange={(v) => assignNPCToSettlement(npc.id, v || null)}
                          options={[
                            { value: '', label: '‚Äî Bez domova ‚Äî' },
                            ...settlements.map(s => ({ value: s.id, label: s.name }))
                          ]}
                        />
                      </div>
                      <Input 
                        value={npc.birthsign || ''} 
                        onChange={(v) => updateNPC(npc.id, { birthsign: v })}
                        placeholder="Znamen√≠/povaha"
                      />
                      <Input 
                        value={npc.physicalDetail || ''} 
                        onChange={(v) => updateNPC(npc.id, { physicalDetail: v })}
                        placeholder="Fyzick√Ω detail (vzhled)"
                      />
                      <Input 
                        value={npc.quirk || ''} 
                        onChange={(v) => updateNPC(npc.id, { quirk: v })}
                        placeholder="Zvl√°≈°tnost (chov√°n√≠)"
                      />
                      <Input 
                        value={npc.goal || ''} 
                        onChange={(v) => updateNPC(npc.id, { goal: v })}
                        placeholder="C√≠l (co chce)"
                      />
                      <textarea
                        value={npc.notes || ''}
                        onChange={(e) => updateNPC(npc.id, { notes: e.target.value })}
                        placeholder="Pozn√°mky..."
                        className="w-full h-20 px-3 py-2 border border-stone-300 rounded-lg resize-none"
                      />
                      <div className="flex justify-between">
                        <Button variant="ghost" onClick={() => setEditingNPC(null)}>‚úì Hotovo</Button>
                        <Button variant="ghost" className="text-red-500" onClick={() => deleteNPC(npc.id)}>Smazat</Button>
                      </div>
                    </div>
                  ) : (
                    // View mode
                    <div 
                      className="cursor-pointer hover:bg-amber-50 -m-3 p-3 rounded-lg transition-colors"
                      onClick={() => setEditingNPC(npc.id)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <h3 className="font-bold text-amber-900">{npc.name}</h3>
                          <p className="text-sm text-stone-600">
                            {npc.role && `${npc.role} ‚Ä¢ `}
                            {npc.settlementId 
                              ? settlements.find(s => s.id === npc.settlementId)?.name 
                              : 'Bez domova'}
                          </p>
                        </div>
                      </div>
                      {(npc.birthsign || npc.physicalDetail || npc.quirk || npc.goal) && (
                        <div className="mt-2 text-sm text-stone-600 space-y-1">
                          {npc.birthsign && <p>‚≠ê {npc.birthsign}</p>}
                          {npc.physicalDetail && <p>üëÅÔ∏è {npc.physicalDetail}</p>}
                          {npc.quirk && <p>üé≠ {npc.quirk}</p>}
                          {npc.goal && <p>üéØ {npc.goal}</p>}
                        </div>
                      )}
                      {npc.notes && <p className="mt-2 text-sm italic text-stone-500">{npc.notes}</p>}
                    </div>
                  )}
                </ResultCard>
              ))}
            </div>
          )}
        </div>
      )}

      {activeGen === 'settlement' && (
        <ResultCard>
          <HelpHeader 
            title="Gener√°tor osady" 
            icon="üèòÔ∏è"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Rychle vytvo≈ô√≠ zaj√≠mavou my≈°√≠ osadu, kam mohou tv√≠ hrdinov√© p≈ôij√≠t - s hotov√Ωm probl√©mem k ≈ôe≈°en√≠!</p>
                
                <p className="font-bold mb-1">üìù Co vygeneruje:</p>
                <ul className="text-xs space-y-1 mb-2">
                  <li>üè∑Ô∏è <b>Jm√©no</b> - n√°hodn√© my≈°√≠ jm√©no osady</li>
                  <li>üìè <b>Velikost</b> - osada / vesnice / mƒõsto</li>
                  <li>üå≥ <b>Landmark</b> - co je pobl√≠≈æ (star√Ω dub, studna...)</li>
                  <li>‚ú® <b>Zaj√≠mav√Ω rys</b> - ƒç√≠m je osada zvl√°≈°tn√≠</li>
                  <li>‚ö° <b>Ud√°lost</b> - aktu√°ln√≠ probl√©m nebo situace</li>
                </ul>
                
                <p className="text-xs text-stone-300 italic">
                  üí° Tip: Ud√°lost je skvƒõl√Ω h√°ƒçek pro dobrodru≈æstv√≠! "Relikvie ukradena" = quest!
                </p>
              </div>
            }
          />
          <p className="text-stone-600 mb-4">Vygeneruj n√°hodnou my≈°√≠ osadu s landmarkem, rysem a aktu√°ln√≠ ud√°lost√≠.</p>
          <Button onClick={generateSettlement} size="large" className="w-full">
            üèòÔ∏è Generovat osadu
          </Button>
        </ResultCard>
      )}

      {activeGen === 'npc' && (
        <ResultCard>
          <HelpHeader 
            title="Gener√°tor NPC" 
            icon="üê≠"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Vytvo≈ô√≠ okam≈æitƒõ zapamatovatelnou postavu, kdy≈æ tv√≠ hrdinov√© potkaj√≠ nƒõkoho nov√©ho.</p>
                
                <p className="font-bold mb-1">üìù Co vygeneruje:</p>
                <ul className="text-xs space-y-1 mb-2">
                  <li>üè∑Ô∏è <b>Jm√©no</b> - ƒçesk√© my≈°√≠ jm√©no</li>
                  <li>‚≠ê <b>Znamen√≠</b> - osobnostn√≠ archetyp</li>
                  <li>üëÅÔ∏è <b>Fyzick√Ω detail</b> - co si na n√≠ v≈°imne≈°</li>
                  <li>üé≠ <b>Zvl√°≈°tnost</b> - jak se chov√°</li>
                  <li>üéØ <b>C√≠l</b> - co pr√°vƒõ teƒè chce</li>
                  <li>üé≤ <b>Reakce (2d6)</b> - jak reaguje na hr√°ƒçe</li>
                </ul>
                
                <p className="font-bold mb-1">üé≤ Reakce:</p>
                <ul className="text-xs space-y-0.5 text-stone-300">
                  <li>2-3 = Nep≈ô√°telsk√°</li>
                  <li>4-5 = Ned≈Øvƒõ≈ôiv√°</li>
                  <li>6-8 = Neutr√°ln√≠</li>
                  <li>9-10 = P≈ô√°telsk√°</li>
                  <li>11-12 = Nad≈°en√°/pomocn√°</li>
                </ul>
              </div>
            }
          />
          <p className="text-stone-600 mb-4">Vygeneruj n√°hodnou my≈°√≠ postavu s osobnost√≠ a c√≠lem.</p>
          <Button onClick={generateNPC} size="large" className="w-full">
            üê≠ Generovat NPC
          </Button>
        </ResultCard>
      )}

      {activeGen === 'dungeon' && (
        <ResultCard>
          <HelpHeader 
            title="Gener√°tor dungeonu" 
            icon="üóùÔ∏è"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Rychle vytvo≈ô√≠ z√°klad pro pr≈Øzkum nebezpeƒçn√©ho m√≠sta - opu≈°tƒõn√©ho doupƒõte, star√© skr√Ω≈°e, nebo mystick√©ho podzem√≠.</p>
                
                <p className="font-bold mb-1">üìù Co vygeneruje:</p>
                <ul className="text-xs space-y-1 mb-2">
                  <li>üèõÔ∏è <b>T√©ma</b> - typ m√≠sta (hn√≠zdo, sklep, svatynƒõ...)</li>
                  <li>üëπ <b>Obyvatel√©</b> - kdo tu ≈æije nebo hl√≠d√°</li>
                  <li>üö™ <b>5 m√≠stnost√≠</b> - z√°kladn√≠ layout s obsahem</li>
                </ul>
                
                <p className="font-bold mb-1">üí° Jak pou≈æ√≠vat:</p>
                <ol className="list-decimal list-inside text-xs space-y-1 text-stone-300">
                  <li>Vygeneruj z√°klad dungeonu</li>
                  <li>Nakresli si mapu podle m√≠stnost√≠</li>
                  <li>P≈ôid√°vej detaily jak prozkoum√°v√°≈°</li>
                  <li>Pou≈æij besti√°≈ô pro nep≈ô√°tele</li>
                </ol>
                
                <p className="text-xs text-stone-300 mt-2 italic">
                  Tip: Nen√≠ to kompletn√≠ mapa - je to kostra. Dopl≈à vlastn√≠ n√°pady!
                </p>
              </div>
            }
          />
          <p className="text-stone-600 mb-4">Vygeneruj dungeon s t√©matem a mapou m√≠stnost√≠.</p>
          <Button onClick={generateDungeon} size="large" className="w-full">
            üóùÔ∏è Generovat dungeon
          </Button>
        </ResultCard>
      )}

      {activeGen === 'bestiary' && (
        <div className="space-y-4">
          <ResultCard>
            <HelpHeader 
              title="Besti√°≈ô" 
              icon="üêõ"
              tooltip={
                <div>
                  <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                  <p className="text-xs mb-2">Kompletn√≠ seznam v≈°ech tvor≈Ø pro Mausritter - od hmyzu po nadp≈ôirozen√© bytosti. Obsahuje 28 tvor≈Ø!</p>
                  
                  <p className="font-bold mb-1">üìù Jak pou≈æ√≠vat:</p>
                  <ol className="list-decimal list-inside text-xs space-y-1 mb-2">
                    <li>Vyber kategorii (hmyz, savci...) nebo nech "V≈°echny"</li>
                    <li>Klikni "N√°hodn√Ω nep≈ô√≠tel" pro random setk√°n√≠</li>
                    <li>Nebo proch√°zej seznam a vyber konkr√©tn√≠ho tvora</li>
                    <li>Detail tvora ukazuje staty, √∫toky a taktiku</li>
                  </ol>
                  
                  <p className="font-bold mb-1">‚ö†Ô∏è WARBAND:</p>
                  <p className="text-xs text-stone-300 mb-2">
                    Tvorov√© oznaƒçen√≠ "Warband" jsou tak velc√≠, ≈æe je m≈Ø≈æe efektivnƒõ porazit jen skupina 20+ my≈°√≠. Jedin√° my≈° nem√° ≈°anci!
                  </p>
                  
                  <p className="font-bold mb-1">üìö Zdroje:</p>
                  <ul className="text-xs text-stone-300">
                    <li>‚Ä¢ Official = z√°kladn√≠ pravidla a roz≈°√≠≈ôen√≠</li>
                    <li>‚Ä¢ Homebrew = komunitn√≠ tvorba</li>
                  </ul>
                </div>
              }
            />
            
            {/* Category filter */}
            <div className="flex flex-wrap gap-2 mb-4">
              <button
                onClick={() => setCreatureCategory('all')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                  creatureCategory === 'all' ? 'bg-amber-600 text-white' : 'bg-stone-200 text-stone-700 hover:bg-stone-300'
                }`}
              >
                üé≤ V≈°echny
              </button>
              {CREATURE_CATEGORIES.map(cat => (
                <button
                  key={cat.id}
                  onClick={() => setCreatureCategory(cat.id)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                    creatureCategory === cat.id ? 'bg-amber-600 text-white' : 'bg-stone-200 text-stone-700 hover:bg-stone-300'
                  }`}
                >
                  {cat.icon} {cat.name}
                </button>
              ))}
            </div>

            <Button onClick={() => generateCreature(creatureCategory)} size="large" className="w-full">
              üé≤ N√°hodn√Ω nep≈ô√≠tel {creatureCategory !== 'all' && `(${CREATURE_CATEGORIES.find(c => c.id === creatureCategory)?.name})`}
            </Button>
          </ResultCard>

          {/* Selected creature detail */}
          {selectedCreature && (
            <ResultCard className="border-2 border-red-400">
              <div className="flex items-start justify-between mb-4">
                <div>
                  <h3 className="text-2xl font-bold text-red-900">{selectedCreature.name}</h3>
                  {selectedCreature.nameEn && <p className="text-sm text-stone-400 italic">{selectedCreature.nameEn}</p>}
                  <p className="text-stone-500">
                    {CREATURE_CATEGORIES.find(c => c.id === selectedCreature.category)?.icon}{' '}
                    {CREATURE_CATEGORIES.find(c => c.id === selectedCreature.category)?.name}
                    {selectedCreature.scale === 'Warband' && <span className="ml-2 bg-red-200 text-red-800 px-2 py-0.5 rounded text-xs font-bold">WARBAND</span>}
                  </p>
                </div>
                <span className="text-4xl">
                  {CREATURE_CATEGORIES.find(c => c.id === selectedCreature.category)?.icon || '‚ùì'}
                </span>
              </div>

              {/* Stats */}
              <div className="grid grid-cols-5 gap-2 mb-4">
                <div className="p-2 bg-red-100 rounded text-center">
                  <div className="text-xs text-stone-500">HP</div>
                  <div className="text-xl font-bold text-red-700">{selectedCreature.hp}</div>
                </div>
                <div className="p-2 bg-amber-100 rounded text-center">
                  <div className="text-xs text-stone-500">STR</div>
                  <div className="text-xl font-bold text-amber-700">{selectedCreature.str}</div>
                </div>
                <div className="p-2 bg-green-100 rounded text-center">
                  <div className="text-xs text-stone-500">DEX</div>
                  <div className="text-xl font-bold text-green-700">{selectedCreature.dex}</div>
                </div>
                <div className="p-2 bg-purple-100 rounded text-center">
                  <div className="text-xs text-stone-500">WIL</div>
                  <div className="text-xl font-bold text-purple-700">{selectedCreature.wil}</div>
                </div>
                <div className="p-2 bg-blue-100 rounded text-center">
                  <div className="text-xs text-stone-500">Armor</div>
                  <div className="text-xl font-bold text-blue-700">{selectedCreature.armor}</div>
                </div>
              </div>

              {/* Attacks */}
              <div className="mb-4">
                <div className="text-sm font-bold text-stone-600 mb-2">‚öîÔ∏è √ötoky</div>
                <div className="space-y-1">
                  {selectedCreature.attacks?.map((atk, i) => (
                    <div key={i} className="flex items-center gap-2 p-2 bg-stone-100 rounded">
                      <span className="font-bold text-stone-800">{atk.name}</span>
                      <span className="bg-red-200 text-red-800 px-2 py-0.5 rounded text-sm font-mono">{atk.damage}</span>
                      {atk.special && <span className="text-xs text-stone-500 italic">({atk.special})</span>}
                    </div>
                  ))}
                </div>
                {selectedCreature.criticalDamage && (
                  <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                    <span className="text-sm font-bold text-red-700">üíÄ Critical:</span>
                    <span className="text-sm text-red-600 ml-2">{selectedCreature.criticalDamage}</span>
                  </div>
                )}
              </div>

              {/* Abilities */}
              {selectedCreature.abilities?.length > 0 && (
                <div className="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                  <div className="text-sm font-bold text-yellow-800 mb-1">‚ö° Schopnosti</div>
                  <ul className="text-sm text-stone-700 list-disc list-inside">
                    {selectedCreature.abilities.map((ab, i) => <li key={i}>{ab}</li>)}
                  </ul>
                </div>
              )}

              {/* Description, Tactics, Wants */}
              <div className="space-y-3">
                {selectedCreature.description && (
                  <div className="p-3 bg-stone-50 rounded-lg">
                    <div className="text-sm font-bold text-stone-600 mb-1">üìñ Popis</div>
                    <p className="text-stone-700 text-sm">{selectedCreature.description}</p>
                  </div>
                )}
                {selectedCreature.tactics && (
                  <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div className="text-sm font-bold text-blue-800 mb-1">üéØ Taktika</div>
                    <p className="text-stone-700 text-sm">{selectedCreature.tactics}</p>
                  </div>
                )}
                {selectedCreature.wants && (
                  <div className="p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <div className="text-sm font-bold text-purple-800 mb-1">üí≠ Chce</div>
                    <p className="text-stone-700 text-sm">{selectedCreature.wants}</p>
                  </div>
                )}
                {selectedCreature.variants?.length > 0 && (
                  <div className="p-3 bg-amber-50 rounded-lg border border-amber-200">
                    <div className="text-sm font-bold text-amber-800 mb-1">üé≤ Varianty</div>
                    <div className="text-xs text-stone-600 space-y-0.5">
                      {selectedCreature.variants.map((v, i) => <div key={i}>‚Ä¢ {v}</div>)}
                    </div>
                  </div>
                )}
                {selectedCreature.source && (
                  <div className="text-xs text-stone-400 text-right">{selectedCreature.source}</div>
                )}
              </div>
            </ResultCard>
          )}

          {/* Creature list */}
          <ResultCard title="üìñ Seznam tvor≈Ø">
            <div className="space-y-2 max-h-96 overflow-y-auto">
              {BESTIARY
                .filter(c => creatureCategory === 'all' || c.category === creatureCategory)
                .map((creature, i) => (
                  <button
                    key={i}
                    onClick={() => setSelectedCreature(creature)}
                    className={`w-full p-3 rounded-lg text-left transition-all flex items-center justify-between ${
                      selectedCreature?.name === creature.name
                        ? 'bg-amber-200 border-2 border-amber-500'
                        : 'bg-stone-100 hover:bg-stone-200'
                    }`}
                  >
                    <div className="flex items-center gap-3">
                      <span className="text-xl">
                        {CREATURE_CATEGORIES.find(c => c.id === creature.category)?.icon || '‚ùì'}
                      </span>
                      <div>
                        <span className="font-bold text-stone-800">{creature.name}</span>
                        {creature.scale === 'Warband' && <span className="ml-2 text-xs bg-red-200 text-red-800 px-1 rounded">Warband</span>}
                        <div className="text-xs text-stone-500">
                          HP {creature.hp} ‚Ä¢ STR {creature.str} ‚Ä¢ {creature.attacks?.[0]?.damage || '?'}
                        </div>
                      </div>
                    </div>
                    <span className="text-stone-400">‚Üí</span>
                  </button>
                ))
              }
            </div>
          </ResultCard>
        </div>
      )}

      {activeGen === 'weather' && (
        <ResultCard>
          <HelpHeader 
            title="Poƒças√≠" 
            icon="‚òÄÔ∏è"
            tooltip={
              <div>
                <p className="font-bold mb-2">üéØ K ƒçemu to je?</p>
                <p className="text-xs mb-2">Poƒças√≠ ovliv≈àuje cestov√°n√≠ a p≈ôe≈æit√≠. Hoƒè na zaƒç√°tku ka≈æd√©ho dne nebo kdy≈æ se poƒças√≠ m≈Ø≈æe zmƒõnit.</p>
                
                <p className="font-bold mb-1">üìù Jak pou≈æ√≠vat:</p>
                <ol className="list-decimal list-inside text-xs space-y-1 mb-2">
                  <li>Vyber aktu√°ln√≠ roƒçn√≠ obdob√≠</li>
                  <li>Hoƒè 2d6 na poƒças√≠</li>
                  <li>Interpretuj vliv na hru</li>
                </ol>
                
                <p className="font-bold mb-1">‚ö° Efekty poƒças√≠:</p>
                <ul className="text-xs space-y-1 text-stone-300">
                  <li><b>Bou≈ôe/V√°nice (2)</b> = nebezpeƒçn√©, tƒõ≈æk√© cestovat</li>
                  <li><b>D√©≈°≈•/Sn√≠h (3-4)</b> = pomal√© cestov√°n√≠</li>
                  <li><b>Zata≈æeno (5-6)</b> = norm√°ln√≠ podm√≠nky</li>
                  <li><b>P≈ô√≠jemn√© (7-9)</b> = ide√°ln√≠ pro cestov√°n√≠</li>
                  <li><b>Kr√°sn√© (10-12)</b> = bonusy k aktivit√°m venku</li>
                </ul>
                
                <p className="text-xs text-stone-300 mt-2 italic">
                  üí° Extr√©mn√≠ poƒças√≠ m≈Ø≈æe b√Ωt h√°ƒçek pro dobrodru≈æstv√≠!
                </p>
              </div>
            }
          />
          <div className="space-y-4">
            <div className="flex flex-wrap gap-2">
              {['spring', 'summer', 'autumn', 'winter'].map(s => (
                <button
                  key={s}
                  onClick={() => setSeason(s)}
                  className={`px-4 py-2 rounded-lg font-medium ${
                    season === s ? 'bg-amber-700 text-white' : 'bg-amber-100 text-amber-900'
                  }`}
                >
                  {s === 'spring' ? 'üå∏ Jaro' : s === 'summer' ? '‚òÄÔ∏è L√©to' : s === 'autumn' ? 'üçÇ Podzim' : '‚ùÑÔ∏è Zima'}
                </button>
              ))}
            </div>
            <Button onClick={generateWeather} size="large" className="w-full">
              üé≤ Hodit na poƒças√≠
            </Button>
          </div>
        </ResultCard>
      )}

      {/* Generated Result */}
      {generated && (
        <ResultCard title="üìã Vygenerov√°no" className="border-amber-500 border-2">
          {generated.type === 'settlement' && (
            <div className="space-y-3">
              <h3 className="text-2xl font-bold text-amber-900">{generated.name}</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-amber-100/50 rounded">
                  <span className="text-sm text-stone-500">Velikost</span>
                  <p className="font-bold">{generated.size}</p>
                </div>
                <div className="p-3 bg-amber-100/50 rounded">
                  <span className="text-sm text-stone-500">Landmark</span>
                  <p className="font-bold">{generated.landmark}</p>
                </div>
              </div>
              <div className="p-3 bg-green-100 rounded">
                <span className="text-sm text-green-700">Zaj√≠mav√Ω rys</span>
                <p className="font-bold text-green-900">{generated.feature}</p>
              </div>
              <div className="p-3 bg-orange-100 rounded">
                <span className="text-sm text-orange-700">Aktu√°ln√≠ ud√°lost</span>
                <p className="font-bold text-orange-900">{generated.event}</p>
              </div>
              <Button onClick={() => saveSettlementToWorld(generated)} className="w-full">
                üì• Ulo≈æit do Moje osady
              </Button>
            </div>
          )}

          {generated.type === 'npc' && (
            <div className="space-y-3">
              <h3 className="text-2xl font-bold text-amber-900">{generated.name}</h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="p-3 bg-amber-100/50 rounded">
                  <span className="text-sm text-stone-500">Znamen√≠</span>
                  <p className="font-bold">{generated.birthsign.name}</p>
                  <p className="text-sm text-stone-600">{generated.birthsign.traits}</p>
                </div>
                <div className="p-3 bg-amber-100/50 rounded">
                  <span className="text-sm text-stone-500">Vzhled</span>
                  <p className="font-bold">{generated.physicalDetail}</p>
                </div>
              </div>
              <div className="p-3 bg-purple-100 rounded">
                <span className="text-sm text-purple-700">Zvl√°≈°tnost</span>
                <p className="font-bold text-purple-900">{generated.quirk}</p>
              </div>
              <div className="p-3 bg-blue-100 rounded">
                <span className="text-sm text-blue-700">C√≠l</span>
                <p className="font-bold text-blue-900">{generated.goal}</p>
              </div>
              <div className="p-3 bg-stone-100 rounded">
                <span className="text-sm text-stone-600">Reakce (2d6)</span>
                <DiceDisplay dice={generated.reaction.dice} />
                <p className="mt-2 font-bold text-center">
                  {generated.reaction.total <= 3 ? 'üò† Nep≈ô√°telsk√Ω' :
                   generated.reaction.total <= 5 ? 'üòí Nevl√≠dn√Ω' :
                   generated.reaction.total <= 8 ? 'üòê Neutr√°ln√≠' :
                   generated.reaction.total <= 10 ? 'üòä P≈ô√°telsk√Ω' : 'ü§ù N√°pomocn√Ω'}
                </p>
              </div>
              <Button onClick={() => saveNPCToWorld({
                ...generated,
                birthsign: `${generated.birthsign.name} (${generated.birthsign.traits})`
              })} className="w-full">
                üì• Ulo≈æit do Moji NPC
              </Button>
            </div>
          )}

          {generated.type === 'dungeon' && (
            <div className="space-y-3">
              <div className="p-3 bg-stone-800 text-stone-100 rounded">
                <span className="text-sm text-stone-400">T√©ma</span>
                <p className="font-bold text-xl">{generated.theme}</p>
              </div>
              <div className="p-3 bg-red-100 rounded">
                <span className="text-sm text-red-700">Obyvatel√©</span>
                <p className="font-bold text-red-900">{generated.denizens}</p>
              </div>
              <div className="space-y-2">
                <h4 className="font-bold text-stone-700">M√≠stnosti:</h4>
                {generated.rooms.map(room => (
                  <div key={room.number} className="p-3 bg-amber-100/50 rounded flex justify-between items-center">
                    <div>
                      <span className="font-bold">#{room.number}</span>
                      <span className="ml-2 text-stone-600">{room.type}</span>
                    </div>
                    <div className="text-right">
                      <span className="text-sm text-stone-500">{room.exits}</span>
                      <p className="font-medium text-amber-900">{room.contents}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {generated.type === 'weather' && (
            <div className="text-center space-y-4">
              <DiceDisplay dice={generated.dice} size="large" />
              <div className="text-5xl">
                {generated.weather.includes('Bou≈ôe') || generated.weather.includes('V√°nice') ? '‚õàÔ∏è' :
                 generated.weather.includes('D√©≈°≈•') || generated.weather.includes('Snƒõ≈æen√≠') ? 'üåßÔ∏è' :
                 generated.weather.includes('Zata≈æeno') || generated.weather.includes('Mlha') ? '‚òÅÔ∏è' :
                 generated.weather.includes('Sluneƒçno') || generated.weather.includes('Jasno') ? '‚òÄÔ∏è' :
                 generated.weather.includes('Perfektn√≠') || generated.weather.includes('N√°dhern√©') ? 'üåà' : 'üå§Ô∏è'}
              </div>
              <p className="text-3xl font-bold text-amber-900">{generated.weather}</p>
              <p className="text-stone-600 capitalize">{
                generated.season === 'spring' ? 'Jaro' :
                generated.season === 'summer' ? 'L√©to' :
                generated.season === 'autumn' ? 'Podzim' : 'Zima'
              }</p>
            </div>
          )}
        </ResultCard>
      )}
    </div>
  );
};

// ============================================
// FACTION PANEL
// ============================================

const FactionPanel = ({ factions, setFactions, onLogEntry }) => {
  const [editingFaction, setEditingFaction] = useState(null);

  const addFaction = () => {
    const newFaction = {
      id: generateId(),
      name: 'Nov√° frakce',
      type: 'gang',
      leader: '',
      base: '',
      trait: '',
      resources: [],
      goals: [{ id: generateId(), description: 'Hlavn√≠ c√≠l', progress: 0, maxProgress: 3 }],
      relationships: []
    };
    setFactions([...factions, newFaction]);
    setEditingFaction(newFaction.id);
  };

  const updateFaction = (id, updates) => {
    setFactions(factions.map(f => f.id === id ? { ...f, ...updates } : f));
  };

  const removeFaction = (id) => {
    setFactions(factions.filter(f => f.id !== id));
  };

  const rollFactionProgress = (faction) => {
    const die = rollD6();
    const resourceBonus = faction.resources?.length || 0;
    const total = die + resourceBonus;
    const success = total >= 6;
    
    if (success && faction.goals?.length > 0) {
      const currentGoal = faction.goals.find(g => g.progress < g.maxProgress);
      if (currentGoal) {
        updateFaction(faction.id, {
          goals: faction.goals.map(g => 
            g.id === currentGoal.id 
              ? { ...g, progress: Math.min(g.maxProgress, g.progress + 2) }
              : g
          )
        });
      }
    }
    
    onLogEntry({
      type: 'faction_progress',
      timestamp: formatTimestamp(),
      faction: faction.name,
      roll: die,
      bonus: resourceBonus,
      total,
      success
    });
    
    return { die, resourceBonus, total, success };
  };

  const addGoal = (factionId) => {
    const faction = factions.find(f => f.id === factionId);
    if (!faction) return;
    
    updateFaction(factionId, {
      goals: [...(faction.goals || []), {
        id: generateId(),
        description: 'Nov√Ω c√≠l',
        progress: 0,
        maxProgress: 3
      }]
    });
  };

  const addResource = (factionId) => {
    const faction = factions.find(f => f.id === factionId);
    if (!faction) return;
    
    updateFaction(factionId, {
      resources: [...(faction.resources || []), 'Nov√Ω zdroj']
    });
  };

  return (
    <div className="space-y-6">
      <SectionHeader 
        icon="‚öîÔ∏è" 
        title="Frakce" 
        subtitle="Sleduj s√≠ly pohybuj√≠c√≠ se ve svƒõtƒõ"
      />

      <ResultCard>
        <HelpHeader 
          title="P≈ôidat frakci" 
          icon="‚ûï"
          tooltip={
            <div>
              <p className="mb-1">Frakce jsou skupiny s vlastn√≠mi c√≠li:</p>
              <ul className="text-xs space-y-1">
                <li>‚Ä¢ Gangy, cechy, kulty, ≈°lechta</li>
                <li>‚Ä¢ Sleduj jejich zdroje a c√≠le</li>
                <li>‚Ä¢ Ka≈æd√Ω t√Ωden hoƒè na pokrok</li>
              </ul>
              <p className="mt-1 text-xs text-stone-300">
                d6 + poƒçet zdroj≈Ø ‚â• 6 = +2 pokrok k c√≠li
              </p>
            </div>
          }
        />
        <Button onClick={addFaction} className="w-full">
          ‚ûï P≈ôidat frakci
        </Button>
      </ResultCard>

      {factions.length === 0 ? (
        <ResultCard>
          <p className="text-center text-stone-500 py-8">
            ≈Ω√°dn√© frakce. P≈ôidej prvn√≠ frakci pro sledov√°n√≠ jejich c√≠l≈Ø a pokroku.
          </p>
        </ResultCard>
      ) : (
        <div className="space-y-4">
          {factions.map(faction => (
            <ResultCard key={faction.id} className={editingFaction === faction.id ? 'border-amber-500 border-2' : ''}>
              <div className="space-y-4">
                {/* Header */}
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    {editingFaction === faction.id ? (
                      <Input 
                        value={faction.name}
                        onChange={(v) => updateFaction(faction.id, { name: v })}
                        className="text-xl font-bold"
                      />
                    ) : (
                      <h3 className="text-xl font-bold text-amber-900">{faction.name}</h3>
                    )}
                    {faction.trait && <p className="text-stone-600 italic">{faction.trait}</p>}
                  </div>
                  <div className="flex gap-2">
                    <Button 
                      size="small" 
                      variant="ghost" 
                      onClick={() => setEditingFaction(editingFaction === faction.id ? null : faction.id)}
                    >
                      {editingFaction === faction.id ? '‚úì' : '‚úèÔ∏è'}
                    </Button>
                    <Button size="small" variant="danger" onClick={() => removeFaction(faction.id)}>‚úï</Button>
                  </div>
                </div>

                {/* Details */}
                {editingFaction === faction.id && (
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-sm text-stone-500">V≈Ødce</label>
                      <Input 
                        value={faction.leader || ''}
                        onChange={(v) => updateFaction(faction.id, { leader: v })}
                        placeholder="Jm√©no v≈Ødce..."
                      />
                    </div>
                    <div>
                      <label className="text-sm text-stone-500">Z√°kladna</label>
                      <Input 
                        value={faction.base || ''}
                        onChange={(v) => updateFaction(faction.id, { base: v })}
                        placeholder="M√≠sto z√°kladny..."
                      />
                    </div>
                    <div className="col-span-2">
                      <label className="text-sm text-stone-500">Charakteristika</label>
                      <Input 
                        value={faction.trait || ''}
                        onChange={(v) => updateFaction(faction.id, { trait: v })}
                        placeholder="Popis frakce..."
                      />
                    </div>
                  </div>
                )}

                {/* Resources */}
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm font-bold text-stone-700">üì¶ Zdroje ({faction.resources?.length || 0})</span>
                    {editingFaction === faction.id && (
                      <Button size="small" variant="ghost" onClick={() => addResource(faction.id)}>+</Button>
                    )}
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {(faction.resources || []).map((res, i) => (
                      <span key={i} className="px-3 py-1 bg-amber-100 rounded-full text-sm">
                        {editingFaction === faction.id ? (
                          <input
                            type="text"
                            value={res}
                            onChange={(e) => {
                              const newResources = [...faction.resources];
                              newResources[i] = e.target.value;
                              updateFaction(faction.id, { resources: newResources });
                            }}
                            className="bg-transparent border-none outline-none w-24"
                          />
                        ) : res}
                      </span>
                    ))}
                    {(!faction.resources || faction.resources.length === 0) && (
                      <span className="text-stone-400 text-sm">≈Ω√°dn√© zdroje</span>
                    )}
                  </div>
                </div>

                {/* Goals */}
                <div>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm font-bold text-stone-700">üéØ C√≠le</span>
                    {editingFaction === faction.id && (
                      <Button size="small" variant="ghost" onClick={() => addGoal(faction.id)}>+</Button>
                    )}
                  </div>
                  <div className="space-y-2">
                    {(faction.goals || []).map(goal => (
                      <div key={goal.id} className="p-3 bg-stone-100 rounded-lg">
                        <div className="flex justify-between items-center mb-2">
                          {editingFaction === faction.id ? (
                            <Input 
                              value={goal.description}
                              onChange={(v) => updateFaction(faction.id, {
                                goals: faction.goals.map(g => 
                                  g.id === goal.id ? { ...g, description: v } : g
                                )
                              })}
                              className="flex-1 mr-2"
                            />
                          ) : (
                            <span className="font-medium">{goal.description}</span>
                          )}
                          <span className={`font-bold ${goal.progress >= goal.maxProgress ? 'text-green-600' : 'text-amber-700'}`}>
                            {goal.progress}/{goal.maxProgress}
                          </span>
                        </div>
                        <div className="flex gap-1">
                          {Array.from({ length: goal.maxProgress }).map((_, i) => (
                            <div
                              key={i}
                              onClick={() => editingFaction === faction.id && updateFaction(faction.id, {
                                goals: faction.goals.map(g => 
                                  g.id === goal.id ? { ...g, progress: i < goal.progress ? i : i + 1 } : g
                                )
                              })}
                              className={`flex-1 h-3 rounded ${
                                i < goal.progress ? 'bg-amber-600' : 'bg-amber-200'
                              } ${editingFaction === faction.id ? 'cursor-pointer hover:bg-amber-400' : ''}`}
                            />
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Roll Progress */}
                <Button 
                  onClick={() => {
                    const result = rollFactionProgress(faction);
                    alert(`${faction.name}: d6=${result.die} + ${result.resourceBonus} zdroj≈Ø = ${result.total}\n${result.success ? '‚úì √öspƒõch! +2 pokrok' : '‚úó Bez pokroku'}`);
                  }}
                  variant="secondary"
                  className="w-full"
                >
                  üé≤ Hodit na pokrok (d6 + zdroje ‚â• 6)
                </Button>
              </div>
            </ResultCard>
          ))}
        </div>
      )}
    </div>
  );
};

// ============================================
// PARTY PANEL
// ============================================

const PartyPanel = ({ 
  parties, 
  activePartyId, 
  setActivePartyId,
  activeCharacterId,
  setActiveCharacterId,
  createParty,
  createPC,
  createHireling,
  updateParty,
  updateCharacterInParty,
  removeCharacter,
  removeParty,
  onLogEntry 
}) => {
  const [editingPartyId, setEditingPartyId] = useState(null);
  const [editingCharId, setEditingCharId] = useState(null);
  const [expandedParties, setExpandedParties] = useState({});
  const [deleteConfirm, setDeleteConfirm] = useState(null); // { type: 'party'|'character', partyId, charId?, name }

  const toggleExpand = (partyId) => {
    setExpandedParties(prev => ({ ...prev, [partyId]: !prev[partyId] }));
  };

  const activeParty = parties.find(p => p.id === activePartyId);

  // Handle delete confirmation
  const handleDeleteConfirm = () => {
    if (!deleteConfirm) return;
    
    if (deleteConfirm.type === 'party') {
      removeParty(deleteConfirm.partyId);
    } else if (deleteConfirm.type === 'character') {
      removeCharacter(deleteConfirm.partyId, deleteConfirm.charId);
    }
    setDeleteConfirm(null);
  };

  // Generate random PC
  const generateRandomPC = (partyId) => {
    // Roll attributes (3k6, take two highest for each)
    const roll3k6TwoHighest = () => {
      const rolls = [rollD6(), rollD6(), rollD6()];
      rolls.sort((a, b) => b - a);
      return rolls[0] + rolls[1];
    };
    
    const rollK66 = () => `${rollD6()}-${rollD6()}`;
    
    const str = roll3k6TwoHighest();
    const dex = roll3k6TwoHighest();
    const wil = roll3k6TwoHighest();
    const hp = rollD6();
    const pips = rollD6();
    
    // Get origin from HP √ó Pips table
    const originKey = `${hp}-${pips}`;
    const origin = ORIGINS[originKey] || ORIGINS['1-1'];
    
    // Gender and name
    const gender = Math.random() < 0.5 ? 'male' : 'female';
    const firstNames = gender === 'male' ? MALE_FIRST_NAMES : FEMALE_FIRST_NAMES;
    const familyName = randomFrom(FAMILY_NAMES);
    const firstName = randomFrom(firstNames);
    const lastName = gender === 'male' ? familyName.male : familyName.female;
    
    // Fur
    const furColor = randomFrom(FUR_COLORS);
    const furPattern = randomFrom(FUR_PATTERNS);
    
    // Distinctive feature (k66)
    const distinctiveFeature = DISTINCTIVE_FEATURES[rollK66()] || 'Bƒõ≈æn√Ω vzhled';
    
    // Weapon
    const weapon = randomFrom(STARTING_WEAPONS);
    
    // Build inventorySlots from origin
    const inventorySlots = {
      mainPaw: { id: generateId(), name: `${weapon.name} (${weapon.damage})`, slots: weapon.slots, usageDots: 0, maxUsage: 3, isWeapon: true },
      offPaw: null,
      body1: null,
      body2: null,
      pack1: { id: generateId(), name: 'Z√°soby', slots: 1, usageDots: 0, maxUsage: 3 },
      pack2: { id: generateId(), name: 'Pochodnƒõ', slots: 1, usageDots: 0, maxUsage: 3 },
      pack3: { id: generateId(), name: origin.itemA, slots: 1, usageDots: 0, maxUsage: 3 },
      pack4: { id: generateId(), name: origin.itemB, slots: 1, usageDots: 0, maxUsage: 3 },
      pack5: null,
      pack6: null
    };
    
    const newChar = {
      id: generateId(),
      type: 'pc',
      name: `${firstName} ${lastName}`,
      gender,
      level: 1,
      STR: { current: str, max: str },
      DEX: { current: dex, max: dex },
      WIL: { current: wil, max: wil },
      hp: { current: hp, max: hp },
      pips,
      xp: 0,
      origin,
      birthsign: randomFrom(BIRTHSIGNS),
      fur: { color: furColor, pattern: furPattern },
      distinctiveFeature,
      conditions: [],
      inventorySlots,
      inventory: [],
      spells: []
    };
    
    createPC(partyId, newChar);
    onLogEntry({
      type: 'character_created',
      timestamp: formatTimestamp(),
      character: newChar.name,
      partyId
    });
  };

  const HIRELING_SKILLS = [
    'Boj', 'Pr≈Øzkum', 'L√©ƒçen√≠', 'Pl√≠≈æen√≠', 'Jezdectv√≠', 
    'Va≈ôen√≠', 'Opravy', 'Magie', 'Obchod', 'Navigace'
  ];

  return (
    <div className="space-y-6">
      {/* Delete Confirmation Modal */}
      {deleteConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl p-6 max-w-md mx-4 shadow-2xl">
            <h3 className="text-xl font-bold text-amber-900 mb-3">
              ‚ö†Ô∏è Potvrdit smaz√°n√≠
            </h3>
            <p className="text-stone-700 mb-4">
              {deleteConfirm.type === 'party' 
                ? `Opravdu chce≈° smazat dru≈æinu "${deleteConfirm.name}" a v≈°echny jej√≠ ƒçleny?`
                : `Opravdu chce≈° odstranit "${deleteConfirm.name}" z dru≈æiny?`
              }
            </p>
            <div className="flex gap-3 justify-end">
              <Button variant="ghost" onClick={() => setDeleteConfirm(null)}>
                Zru≈°it
              </Button>
              <Button variant="danger" onClick={handleDeleteConfirm}>
                üóëÔ∏è Smazat
              </Button>
            </div>
          </div>
        </div>
      )}

      <SectionHeader 
        icon="üèïÔ∏è" 
        title="Dru≈æiny a postavy" 
        subtitle={`${parties.length} dru≈æin, ${parties.reduce((acc, p) => acc + p.members.length, 0)} postav celkem`}
      />

      {/* Create new party */}
      <ResultCard>
        <HelpHeader 
          title="Spr√°va dru≈æin" 
          icon="‚ûï"
          tooltip={
            <div>
              <p className="mb-1">Dru≈æina = skupina postav cestuj√≠c√≠ spolu</p>
              <ul className="text-xs space-y-1">
                <li>‚Ä¢ Ka≈æd√° dru≈æina m√° vlastn√≠ ƒças</li>
                <li>‚Ä¢ PC = pln√° postava s XP a levely</li>
                <li>‚Ä¢ Hireling = pomocn√≠k s Loyalty</li>
              </ul>
            </div>
          }
        />
        <Button onClick={() => createParty()} className="w-full">
          üèïÔ∏è Vytvo≈ôit novou dru≈æinu
        </Button>
      </ResultCard>

      {/* Party list */}
      {parties.length === 0 ? (
        <ResultCard>
          <div className="text-center py-8 text-stone-500">
            <p className="text-4xl mb-3">üê≠</p>
            <p>Zat√≠m nem√°≈° ≈æ√°dnou dru≈æinu.</p>
            <p className="text-sm mt-2">Vytvo≈ô prvn√≠ dru≈æinu a p≈ôidej do n√≠ postavy!</p>
          </div>
        </ResultCard>
      ) : (
        <div className="space-y-4">
          {parties.map(party => {
            const isActive = party.id === activePartyId;
            const isExpanded = expandedParties[party.id] !== false; // Default expanded
            const isEditing = editingPartyId === party.id;
            
            return (
              <ResultCard 
                key={party.id} 
                className={`${isActive ? 'border-2 border-amber-500 shadow-lg' : ''}`}
              >
                {/* Party Header */}
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3 flex-1">
                    <button 
                      onClick={() => toggleExpand(party.id)}
                      className="text-xl hover:bg-amber-100 rounded p-1"
                    >
                      {isExpanded ? '‚ñº' : '‚ñ∂'}
                    </button>
                    
                    {isEditing ? (
                      <input
                        type="text"
                        value={party.name}
                        onChange={(e) => updateParty(party.id, { name: e.target.value })}
                        onBlur={() => setEditingPartyId(null)}
                        onKeyDown={(e) => e.key === 'Enter' && setEditingPartyId(null)}
                        autoFocus
                        className="flex-1 px-2 py-1 border-2 border-amber-500 rounded font-bold text-lg"
                      />
                    ) : (
                      <h3 
                        className="font-bold text-lg text-amber-900 cursor-pointer hover:text-amber-700"
                        onClick={() => setEditingPartyId(party.id)}
                        title="Klikni pro p≈ôejmenov√°n√≠"
                      >
                        {party.name}
                        <span className="text-sm font-normal text-stone-500 ml-2">
                          ({party.members.length} ƒçlen≈Ø)
                        </span>
                      </h3>
                    )}
                  </div>
                  
                  <div className="flex items-center gap-2">
                    {isActive ? (
                      <span className="px-2 py-1 bg-amber-500 text-white text-xs font-bold rounded">
                        AKTIVN√ç
                      </span>
                    ) : (
                      <Button 
                        size="small" 
                        variant="secondary"
                        onClick={() => {
                          setActivePartyId(party.id);
                          if (party.members.length > 0) {
                            setActiveCharacterId(party.members[0].id);
                          }
                        }}
                      >
                        Aktivovat
                      </Button>
                    )}
                    <Button 
                      size="small" 
                      variant="ghost"
                      onClick={() => setEditingPartyId(isEditing ? null : party.id)}
                    >
                      ‚úèÔ∏è
                    </Button>
                    <Button 
                      size="small" 
                      variant="danger"
                      onClick={() => setDeleteConfirm({ 
                        type: 'party', 
                        partyId: party.id, 
                        name: party.name 
                      })}
                      title={`Smazat dru≈æinu ${party.name}`}
                    >
                      üóëÔ∏è
                    </Button>
                  </div>
                </div>

                {/* Party Time Info */}
                {isExpanded && (
                  <div className="mb-3 p-2 bg-amber-50 rounded text-sm flex flex-wrap gap-4">
                    <span>
                      {['üåÖ', '‚òÄÔ∏è', 'üåÜ', 'üåô'][party.gameTime?.watch || 0]} 
                      {' '}{WATCHES[party.gameTime?.watch || 0]?.name}
                    </span>
                    <span>üìÜ Den {party.gameTime?.day || 1}, T√Ωden {party.gameTime?.week || 1}</span>
                    <span>
                      {SEASONS.find(s => s.id === (party.gameTime?.season || 'spring'))?.icon}
                      {' '}{SEASONS.find(s => s.id === (party.gameTime?.season || 'spring'))?.name}
                    </span>
                  </div>
                )}

                {/* Members List */}
                {isExpanded && (
                  <div className="space-y-2">
                    {party.members.length === 0 ? (
                      <p className="text-stone-400 text-sm text-center py-3">
                        Dru≈æina je pr√°zdn√°. P≈ôidej postavy n√≠≈æe.
                      </p>
                    ) : (
                      party.members.map(member => {
                        const isPC = member.type === 'pc';
                        const isCharEditing = editingCharId === member.id;
                        const isSelected = activeCharacterId === member.id && isActive;
                        
                        return (
                          <div 
                            key={member.id}
                            className={`p-3 rounded-lg border-2 transition-all cursor-pointer ${
                              isSelected 
                                ? 'bg-amber-100 border-amber-500' 
                                : isPC 
                                  ? 'bg-green-50 border-green-200 hover:border-green-400'
                                  : 'bg-blue-50 border-blue-200 hover:border-blue-400'
                            }`}
                            onClick={() => {
                              if (isActive && !isCharEditing) {
                                setActiveCharacterId(member.id);
                              }
                            }}
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-3">
                                <span className="text-2xl">{isPC ? 'üê≠' : 'üêøÔ∏è'}</span>
                                <div>
                                  {isCharEditing ? (
                                    <input
                                      type="text"
                                      value={member.name}
                                      onChange={(e) => updateCharacterInParty(party.id, member.id, { name: e.target.value })}
                                      onBlur={() => setEditingCharId(null)}
                                      onKeyDown={(e) => e.key === 'Enter' && setEditingCharId(null)}
                                      onClick={(e) => e.stopPropagation()}
                                      autoFocus
                                      className="px-2 py-1 border-2 border-amber-500 rounded font-bold"
                                    />
                                  ) : (
                                    <span 
                                      className="font-bold text-stone-800 hover:text-amber-700"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setEditingCharId(member.id);
                                      }}
                                      title="Klikni pro p≈ôejmenov√°n√≠"
                                    >
                                      {member.name}
                                    </span>
                                  )}
                                  <div className="flex gap-3 text-sm text-stone-600">
                                    {isPC ? (
                                      <>
                                        <span>Level {member.level || 1}</span>
                                        <span className={member.hp?.current < member.hp?.max ? 'text-red-600 font-bold' : ''}>
                                          HP {member.hp?.current || 0}/{member.hp?.max || 6}
                                        </span>
                                        <span>{member.pips || 0} pips</span>
                                      </>
                                    ) : (
                                      <>
                                        <span className={member.hp?.current < member.hp?.max ? 'text-red-600 font-bold' : ''}>
                                          HP {member.hp?.current || 0}/{member.hp?.max || 3}
                                        </span>
                                        <span>Loyalty: {member.loyalty || 7}</span>
                                        <span>{member.cost || '1 pip/den'}</span>
                                      </>
                                    )}
                                  </div>
                                  {!isPC && member.skills?.length > 0 && (
                                    <div className="flex gap-1 mt-1">
                                      {member.skills.map((skill, i) => (
                                        <span key={i} className="px-2 py-0.5 bg-blue-200 text-blue-800 text-xs rounded">
                                          {skill}
                                        </span>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                              
                              <div className="flex items-center gap-2">
                                {isSelected && (
                                  <span className="text-xs text-amber-600 font-bold">VYBR√ÅN</span>
                                )}
                                <Button 
                                  size="small" 
                                  variant="ghost"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setDeleteConfirm({
                                      type: 'character',
                                      partyId: party.id,
                                      charId: member.id,
                                      name: member.name
                                    });
                                  }}
                                  title={`Odstranit ${member.name}`}
                                >
                                  ‚úï
                                </Button>
                              </div>
                            </div>
                          </div>
                        );
                      })
                    )}

                    {/* Add buttons */}
                    <div className="flex flex-wrap gap-2 mt-3 pt-3 border-t border-amber-200">
                      <Button 
                        size="small" 
                        onClick={() => generateRandomPC(party.id)}
                      >
                        üé≤ N√°hodn√° PC
                      </Button>
                      <Button 
                        size="small" 
                        variant="secondary"
                        onClick={() => createPC(party.id)}
                      >
                        üê≠ Pr√°zdn√° PC
                      </Button>
                      <Button 
                        size="small" 
                        variant="ghost"
                        onClick={() => createHireling(party.id)}
                      >
                        üêøÔ∏è Hireling
                      </Button>
                    </div>
                  </div>
                )}
              </ResultCard>
            );
          })}
        </div>
      )}

      {/* Quick reference */}
      <ResultCard title="üìã Rychl√° reference">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div className="p-3 bg-green-50 rounded-lg">
            <h4 className="font-bold text-green-900 mb-2">üê≠ PC (Player Character)</h4>
            <ul className="space-y-1 text-stone-700">
              <li>‚Ä¢ Pln√Ω character sheet</li>
              <li>‚Ä¢ STR, DEX, WIL atributy</li>
              <li>‚Ä¢ XP a levelov√°n√≠</li>
              <li>‚Ä¢ Invent√°≈ô a kouzla</li>
            </ul>
          </div>
          <div className="p-3 bg-blue-50 rounded-lg">
            <h4 className="font-bold text-blue-900 mb-2">üêøÔ∏è Hireling (Pomocn√≠k)</h4>
            <ul className="space-y-1 text-stone-700">
              <li>‚Ä¢ Zjednodu≈°en√Ω sheet</li>
              <li>‚Ä¢ HP + Loyalty (loajalita)</li>
              <li>‚Ä¢ Cena (obvykle 1 pip/den)</li>
              <li>‚Ä¢ M≈Ø≈æe zradit p≈ôi selh√°n√≠ Loyalty!</li>
            </ul>
          </div>
        </div>
      </ResultCard>
    </div>
  );
};

// ============================================
// TIME TRACKER PANEL
// ============================================

const WATCHES = [
  { id: 'morning', name: 'R√°no', icon: 'üåÖ', hours: '6:00-12:00' },
  { id: 'afternoon', name: 'Odpoledne', icon: '‚òÄÔ∏è', hours: '12:00-18:00' },
  { id: 'evening', name: 'Veƒçer', icon: 'üåÜ', hours: '18:00-24:00' },
  { id: 'night', name: 'Noc', icon: 'üåô', hours: '0:00-6:00' }
];

const SEASONS = [
  { id: 'spring', name: 'Jaro', icon: 'üå∏', months: 'B≈ôezen-Kvƒõten' },
  { id: 'summer', name: 'L√©to', icon: '‚òÄÔ∏è', months: 'ƒåerven-Srpen' },
  { id: 'autumn', name: 'Podzim', icon: 'üçÇ', months: 'Z√°≈ô√≠-Listopad' },
  { id: 'winter', name: 'Zima', icon: '‚ùÑÔ∏è', months: 'Prosinec-√önor' }
];

const TimePanel = ({ party, updateParty, updateCharacterInParty, factions, setFactions, onLogEntry }) => {
  const [notifications, setNotifications] = useState([]);
  const [showWeatherRoll, setShowWeatherRoll] = useState(false);
  const [currentWeather, setCurrentWeather] = useState(null);
  const [dungeonMode, setDungeonMode] = useState(false);
  const [dungeonTurns, setDungeonTurns] = useState(0);
  const [torchTurns, setTorchTurns] = useState(0); // Turns since torch lit

  // Extract gameTime from party
  const gameTime = party?.gameTime || { watch: 0, day: 1, week: 1, season: 'spring', totalWatches: 0, lastRest: null };
  const setGameTime = (newTime) => {
    if (party) {
      updateParty({ gameTime: typeof newTime === 'function' ? newTime(gameTime) : newTime });
    }
  };

  const currentWatch = WATCHES[gameTime.watch];
  const currentSeason = SEASONS.find(s => s.id === gameTime.season) || SEASONS[0];

  // Check if party exists
  if (!party) {
    return (
      <div className="space-y-6">
        <SectionHeader icon="‚è∞" title="Sledov√°n√≠ ƒçasu" subtitle="Nejprve vyber aktivn√≠ dru≈æinu" />
        <ResultCard>
          <div className="text-center py-8 text-stone-500">
            <p className="text-4xl mb-3">üèïÔ∏è</p>
            <p>≈Ω√°dn√° aktivn√≠ dru≈æina.</p>
            <p className="text-sm mt-2">P≈ôejdi do panelu "Dru≈æiny" a vytvo≈ô nebo aktivuj dru≈æinu.</p>
          </div>
        </ResultCard>
      </div>
    );
  }

  // Add notification
  const addNotification = (message, type = 'info') => {
    const id = generateId();
    setNotifications(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 5000);
  };

  // Advance dungeon turn
  const advanceDungeonTurn = (count = 1) => {
    const newTurns = dungeonTurns + count;
    const newTorchTurns = torchTurns + count;
    setDungeonTurns(newTurns);
    setTorchTurns(newTorchTurns);

    onLogEntry({
      type: 'dungeon_turn',
      timestamp: formatTimestamp(),
      turn: newTurns,
      torchTurns: newTorchTurns
    });

    // Wandering monster check every 2 turns
    if (newTurns % 2 === 0) {
      const roll = rollD6();
      const encounter = roll === 1;
      
      onLogEntry({
        type: 'wandering_monster_check',
        timestamp: formatTimestamp(),
        roll,
        encounter
      });

      if (encounter) {
        addNotification(`üëπ N√ÅHODN√â SETK√ÅN√ç! (Hod: ${roll})`, 'warning');
      } else {
        addNotification(`üé≤ Wandering monster check: ${roll} - bezpeƒçno`, 'info');
      }
    }

    // Torch warning at 6 turns (1 hour)
    if (newTorchTurns === 5) {
      addNotification('üî• Pochode≈à brzy doho≈ô√≠! (zb√Ωv√° ~10 min)', 'warning');
    }
    if (newTorchTurns >= 6) {
      addNotification('üî• POCHODE≈á DOHO≈òELA! Rozsvi≈• novou nebo jsi ve tmƒõ!', 'warning');
      rollUsage('Torch');
    }
  };

  // Light new torch
  const lightNewTorch = () => {
    setTorchTurns(0);
    addNotification('üî• Nov√° pochode≈à zap√°lena! (vydr≈æ√≠ 6 turns)', 'success');
    onLogEntry({
      type: 'torch_lit',
      timestamp: formatTimestamp()
    });
  };

  // Enter/Exit dungeon
  const toggleDungeonMode = () => {
    if (dungeonMode) {
      // Exiting dungeon - convert turns to watches if significant
      const watchesSpent = Math.floor(dungeonTurns / 6);
      if (watchesSpent > 0) {
        for (let i = 0; i < watchesSpent; i++) {
          advanceWatch();
        }
        addNotification(`‚õèÔ∏è Opou≈°t√≠≈° dungeon po ${dungeonTurns} turnech (${watchesSpent} smƒõn)`, 'info');
      }
      setDungeonTurns(0);
      setTorchTurns(0);
    } else {
      addNotification('‚õèÔ∏è Vstupuje≈° do dungeonu! Poƒç√≠t√°m turny.', 'info');
    }
    setDungeonMode(!dungeonMode);
  };

  // Advance watch
  const advanceWatch = () => {
    let newWatch = gameTime.watch + 1;
    let newDay = gameTime.day;
    let newWeek = gameTime.week;
    let newSeason = gameTime.season;
    let triggeredEvents = [];

    // New day at morning (after midnight)
    if (newWatch >= WATCHES.length) {
      newWatch = 0;
      newDay += 1;
      triggeredEvents.push('new_day');

      // Check for new week (every 7 days)
      if (newDay > 7) {
        newDay = 1;
        newWeek += 1;
        triggeredEvents.push('new_week');

        // Check for new season (every 12 weeks / 3 months)
        if (newWeek > 12) {
          newWeek = 1;
          const seasonIndex = SEASONS.findIndex(s => s.id === newSeason);
          newSeason = SEASONS[(seasonIndex + 1) % SEASONS.length].id;
          triggeredEvents.push('new_season');
        }
      }
    }

    // Update game time
    setGameTime({
      ...gameTime,
      watch: newWatch,
      day: newDay,
      week: newWeek,
      season: newSeason,
      totalWatches: gameTime.totalWatches + 1
    });

    // Log the time advance
    onLogEntry({
      type: 'time_advance',
      timestamp: formatTimestamp(),
      from: { watch: gameTime.watch, day: gameTime.day },
      to: { watch: newWatch, day: newDay },
      events: triggeredEvents
    });

    // Trigger notifications and events
    if (triggeredEvents.includes('new_day')) {
      addNotification('üåÖ Nov√Ω den zaƒç√≠n√°! Hoƒè na poƒças√≠.', 'warning');
      setShowWeatherRoll(true);
    }

    if (triggeredEvents.includes('new_week')) {
      addNotification('üìÖ Nov√Ω t√Ωden! Hoƒè na faction progress.', 'warning');
    }

    if (triggeredEvents.includes('new_season')) {
      addNotification(`üåø Nov√© roƒçn√≠ obdob√≠: ${SEASONS.find(s => s.id === newSeason)?.name}!`, 'success');
    }

    // Check for light sources (every watch)
    checkLightSources();

    // Check for rest needs (every 3 watches without rest = exhaustion warning)
    if ((gameTime.totalWatches + 1) % 3 === 0 && !gameTime.lastRest) {
      addNotification('üò¥ Postavy by mƒõly odpoƒç√≠vat!', 'warning');
    }
  };

  // Check and consume light sources
  const checkLightSources = () => {
    if (!party?.members) return;

    const hasLightSources = party.members.some(member => 
      member.inventory?.some(item => 
        item.name.toLowerCase().includes('torch') || 
        item.name.toLowerCase().includes('pochode≈à') ||
        item.name.toLowerCase().includes('sv√≠ƒçka') ||
        item.name.toLowerCase().includes('lucerna') ||
        item.name.toLowerCase().includes('svƒõtlo')
      )
    );

    if (hasLightSources) {
      addNotification('üî• Zkontroluj svƒõteln√© zdroje (1 smƒõna spot≈ôebov√°na)', 'info');
    }
  };

  // Roll for rations/torch usage
  const rollUsage = (itemName) => {
    const die = rollD6();
    const consumed = die <= 2; // In Mausritter, 1-2 means mark usage
    
    onLogEntry({
      type: 'usage_roll',
      timestamp: formatTimestamp(),
      item: itemName,
      roll: die,
      consumed
    });

    if (consumed) {
      addNotification(`üì¶ ${itemName}: Hod ${die} - Oznaƒç pou≈æit√≠!`, 'warning');
      
      // Auto-mark usage if item found in any party member's inventory
      if (party?.members) {
        for (const member of party.members) {
          if (member.inventory) {
            const itemIndex = member.inventory.findIndex(i => 
              i.name.toLowerCase().includes(itemName.toLowerCase())
            );
            if (itemIndex >= 0) {
              const item = member.inventory[itemIndex];
              if (item.usageDots < (item.maxUsage || 3)) {
                const newInventory = [...member.inventory];
                newInventory[itemIndex] = { ...item, usageDots: item.usageDots + 1 };
                updateCharacterInParty(member.id, { inventory: newInventory });
                addNotification(`üì¶ Oznaƒçeno u ${member.name}`, 'info');
                break; // Only mark one
              }
            }
          }
        }
      }
    } else {
      addNotification(`üì¶ ${itemName}: Hod ${die} - Bez spot≈ôeby!`, 'success');
    }

    return { die, consumed };
  };

  // Take a rest
  const takeRest = (restType) => {
    onLogEntry({
      type: 'rest',
      subtype: restType,
      timestamp: formatTimestamp(),
      watches: restType === 'long' ? 1 : 0
    });

    if (restType === 'short') {
      // Short rest - 1 turn in dungeon, quick breather outside
      addNotification('‚òï Kr√°tk√Ω odpoƒçinek (1 turn / p√°r minut)', 'info');
    } else {
      // Long rest - 1 watch, heal and consume rations
      addNotification('üèïÔ∏è Dlouh√Ω odpoƒçinek (1 smƒõna) - Hoƒè na rations!', 'warning');
      rollUsage('Z√°soby');
      
      // Heal HP to max for all party members
      if (party?.members) {
        party.members.forEach(member => {
          if (member.hp && member.hp.current < member.hp.max) {
            updateCharacterInParty(member.id, {
              hp: { ...member.hp, current: member.hp.max }
            });
          }
          
          // Clear exhausted condition for PCs
          if (member.type === 'pc' && member.conditions?.includes('exhausted')) {
            updateCharacterInParty(member.id, {
              conditions: member.conditions.filter(c => c !== 'exhausted')
            });
          }
        });
        addNotification('‚ù§Ô∏è HP v≈°ech ƒçlen≈Ø obnoveno!', 'success');
      }

      // Advance 1 watch for long rest
      advanceWatch();
    }

    setGameTime(prev => ({ ...prev, lastRest: prev.totalWatches }));
  };

  // Roll weather for new day
  const rollWeather = () => {
    const { dice, total } = roll2D6();
    const weather = WEATHER_TABLE[gameTime.season][total];
    
    setCurrentWeather({ dice, total, weather });
    setShowWeatherRoll(false);

    onLogEntry({
      type: 'weather',
      timestamp: formatTimestamp(),
      season: gameTime.season,
      dice,
      total,
      weather
    });

    // Check for dangerous weather
    if (total <= 3) {
      addNotification(`‚ö†Ô∏è Nebezpeƒçn√© poƒças√≠: ${weather}! Cestov√°n√≠ je riskantn√≠.`, 'warning');
    }
  };

  // Roll faction progress for all factions
  const rollAllFactionProgress = () => {
    if (factions.length === 0) {
      addNotification('≈Ω√°dn√© frakce k aktualizaci', 'info');
      return;
    }

    const results = [];
    const updatedFactions = factions.map(faction => {
      const die = rollD6();
      const resourceBonus = faction.resources?.length || 0;
      const total = die + resourceBonus;
      const success = total >= 6;

      results.push({
        name: faction.name,
        die,
        resourceBonus,
        total,
        success
      });

      if (success && faction.goals?.length > 0) {
        const currentGoal = faction.goals.find(g => g.progress < g.maxProgress);
        if (currentGoal) {
          return {
            ...faction,
            goals: faction.goals.map(g =>
              g.id === currentGoal.id
                ? { ...g, progress: Math.min(g.maxProgress, g.progress + 2) }
                : g
            )
          };
        }
      }
      return faction;
    });

    setFactions(updatedFactions);

    results.forEach(r => {
      onLogEntry({
        type: 'faction_progress',
        timestamp: formatTimestamp(),
        faction: r.name,
        roll: r.die,
        bonus: r.resourceBonus,
        total: r.total,
        success: r.success
      });

      if (r.success) {
        addNotification(`‚öîÔ∏è ${r.name}: Pokrok! (${r.total})`, 'success');
      }
    });
  };

  // Travel (advances time and may trigger encounters)
  const travel = (watches = 1) => {
    for (let i = 0; i < watches; i++) {
      advanceWatch();
      
      // Random encounter check (1-2 on d6)
      const encounterRoll = rollD6();
      if (encounterRoll <= 2) {
        addNotification(`‚ö†Ô∏è N√°hodn√© setk√°n√≠! (Hod ${encounterRoll})`, 'warning');
        onLogEntry({
          type: 'random_encounter',
          timestamp: formatTimestamp(),
          roll: encounterRoll
        });
      }
    }
    
    // Roll torch usage after travel
    rollUsage('Torch');
  };

  return (
    <div className="space-y-6">
      <SectionHeader
        icon="‚è∞"
        title="Sledov√°n√≠ ƒçasu"
        subtitle={`${currentSeason.icon} ${currentSeason.name}, T√Ωden ${gameTime.week}, Den ${gameTime.day}`}
      />

      {/* Notifications */}
      {notifications.length > 0 && (
        <div className="space-y-2">
          {notifications.map(n => (
            <div
              key={n.id}
              className={`p-3 rounded-lg font-medium animate-pulse ${
                n.type === 'warning' ? 'bg-orange-100 text-orange-800 border border-orange-300' :
                n.type === 'success' ? 'bg-green-100 text-green-800 border border-green-300' :
                'bg-blue-100 text-blue-800 border border-blue-300'
              }`}
            >
              {n.message}
            </div>
          ))}
        </div>
      )}

      {/* Current Time Display */}
      <ResultCard title="üìÖ Aktu√°ln√≠ ƒças">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div className="p-4 bg-amber-100 rounded-lg">
            <div className="text-3xl mb-1">{currentWatch.icon}</div>
            <div className="font-bold text-amber-900">{currentWatch.name}</div>
            <div className="text-sm text-stone-500">{currentWatch.hours}</div>
          </div>
          <div className="p-4 bg-amber-100 rounded-lg">
            <div className="text-3xl mb-1">üìÜ</div>
            <div className="font-bold text-amber-900">Den {gameTime.day}</div>
            <div className="text-sm text-stone-500">T√Ωden {gameTime.week}</div>
          </div>
          <div className="p-4 bg-amber-100 rounded-lg">
            <div className="text-3xl mb-1">{currentSeason.icon}</div>
            <div className="font-bold text-amber-900">{currentSeason.name}</div>
            <div className="text-sm text-stone-500">{currentSeason.months}</div>
          </div>
          <div className="p-4 bg-amber-100 rounded-lg">
            <div className="text-3xl mb-1">‚è±Ô∏è</div>
            <div className="font-bold text-amber-900">{gameTime.totalWatches}</div>
            <div className="text-sm text-stone-500">Celkem smƒõn</div>
          </div>
        </div>
      </ResultCard>

      {/* Dungeon Mode Toggle */}
      <ResultCard>
        <HelpHeader 
          title="Re≈æim pr≈Øzkumu" 
          icon="‚õèÔ∏è"
          tooltip={
            <div>
              <p className="font-bold mb-1">Dva re≈æimy ƒçasu:</p>
              <ul className="text-xs space-y-1">
                <li><strong>Povrch</strong> - poƒç√≠t√°≈° smƒõny (6 hodin)</li>
                <li><strong>Dungeon</strong> - poƒç√≠t√°≈° turny (10 minut)</li>
              </ul>
              <p className="mt-2 text-xs text-stone-300">
                V dungeonu: wandering monster check ka≈æd√© 2 turny, pochode≈à vydr≈æ√≠ 6 turn≈Ø
              </p>
            </div>
          }
        />
        <div className="flex items-center justify-between mb-4">
          <div>
            <p className="font-bold text-amber-900">{dungeonMode ? 'üè∞ V dungeonu' : 'üå≤ Na povrchu'}</p>
            <p className="text-sm text-stone-600">
              {dungeonMode 
                ? 'Poƒç√≠t√°m turny (~10 min), wandering monsters ka≈æd√© 2 turny' 
                : 'Poƒç√≠t√°m smƒõny (~6 hodin)'}
            </p>
          </div>
          <Button 
            onClick={toggleDungeonMode} 
            variant={dungeonMode ? 'danger' : 'secondary'}
          >
            {dungeonMode ? 'üö™ Opustit dungeon' : '‚õèÔ∏è Vstoupit do dungeonu'}
          </Button>
        </div>
      </ResultCard>

      {/* Dungeon Turn Tracker */}
      {dungeonMode && (
        <ResultCard title="üïØÔ∏è Dungeon Tracker" className="border-2 border-amber-600">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
            <div className="p-4 bg-stone-800 text-stone-100 rounded-lg">
              <div className="text-3xl font-bold">{dungeonTurns}</div>
              <div className="text-sm text-stone-400">Turn≈Ø celkem</div>
            </div>
            <div className="p-4 bg-stone-800 text-stone-100 rounded-lg">
              <div className="text-3xl font-bold">~{dungeonTurns * 10} min</div>
              <div className="text-sm text-stone-400">ƒåas v dungeonu</div>
            </div>
            <div className={`p-4 rounded-lg ${torchTurns >= 5 ? 'bg-red-700 text-white' : 'bg-orange-600 text-white'}`}>
              <div className="text-3xl font-bold">{6 - torchTurns}</div>
              <div className="text-sm">Zb√Ωv√° turn≈Ø pochode≈à</div>
            </div>
            <div className="p-4 bg-purple-800 text-purple-100 rounded-lg">
              <div className="text-3xl font-bold">{2 - (dungeonTurns % 2)}</div>
              <div className="text-sm">Do wandering check</div>
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <Button onClick={() => advanceDungeonTurn(1)} className="flex-col h-16">
              <span className="text-xl">‚è±Ô∏è</span>
              <span className="text-sm">+1 Turn</span>
            </Button>
            <Button onClick={() => advanceDungeonTurn(2)} variant="secondary" className="flex-col h-16">
              <span className="text-xl">‚è±Ô∏è‚è±Ô∏è</span>
              <span className="text-sm">+2 Turny</span>
            </Button>
            <Button onClick={lightNewTorch} variant="ghost" className="flex-col h-16">
              <span className="text-xl">üî•</span>
              <span className="text-sm">Nov√° pochode≈à</span>
            </Button>
            <Button onClick={() => { setDungeonTurns(0); setTorchTurns(0); }} variant="ghost" className="flex-col h-16">
              <span className="text-xl">üîÑ</span>
              <span className="text-sm">Reset</span>
            </Button>
          </div>

          <div className="p-3 bg-stone-100 rounded-lg text-sm">
            <h4 className="font-bold text-stone-700 mb-2">üìã Co zabere 1 turn (~10 min):</h4>
            <ul className="grid grid-cols-2 gap-1 text-stone-600">
              <li>‚Ä¢ Pr≈Øzkum m√≠stnosti</li>
              <li>‚Ä¢ Hled√°n√≠ past√≠/tajn√Ωch dve≈ô√≠</li>
              <li>‚Ä¢ Kr√°tk√Ω odpoƒçinek</li>
              <li>‚Ä¢ Boj (cel√Ω)</li>
              <li>‚Ä¢ Manipulace s mechanismem</li>
              <li>‚Ä¢ Ses√≠l√°n√≠ ritu√°lu</li>
            </ul>
          </div>
        </ResultCard>
      )}

      {/* Watch Tracker - only show when not in dungeon */}
      {!dungeonMode && (
        <ResultCard title="üïê Smƒõny dne">
          <div className="flex flex-wrap gap-2 mb-4">
            {WATCHES.map((watch, index) => (
              <div
                key={watch.id}
                className={`flex-1 min-w-[80px] p-3 rounded-lg text-center transition-all ${
                  index === gameTime.watch
                    ? 'bg-amber-600 text-white shadow-lg scale-105'
                    : index < gameTime.watch
                    ? 'bg-stone-300 text-stone-600'
                    : 'bg-amber-100 text-amber-900'
                }`}
              >
                <div className="text-2xl">{watch.icon}</div>
                <div className="text-sm font-medium">{watch.name}</div>
              </div>
            ))}
          </div>
          <Button onClick={advanceWatch} size="large" className="w-full">
            ‚è≠Ô∏è Dal≈°√≠ smƒõna
          </Button>
        </ResultCard>
      )}

      {/* Weather */}
      <ResultCard title="üå§Ô∏è Poƒças√≠">
        {showWeatherRoll ? (
          <div className="text-center space-y-4">
            <p className="text-amber-800 font-medium">Nov√Ω den! Hoƒè na poƒças√≠:</p>
            <Button onClick={rollWeather} size="large">
              üé≤ Hodit 2d6 na poƒças√≠
            </Button>
          </div>
        ) : currentWeather ? (
          <div className="text-center space-y-2">
            <DiceDisplay dice={currentWeather.dice} />
            <div className="text-4xl my-3">
              {currentWeather.weather.includes('Bou≈ôe') || currentWeather.weather.includes('V√°nice') ? '‚õàÔ∏è' :
               currentWeather.weather.includes('D√©≈°≈•') || currentWeather.weather.includes('Snƒõ≈æen√≠') ? 'üåßÔ∏è' :
               currentWeather.weather.includes('Zata≈æeno') || currentWeather.weather.includes('Mlha') ? '‚òÅÔ∏è' :
               currentWeather.weather.includes('Sluneƒçno') || currentWeather.weather.includes('Jasno') ? '‚òÄÔ∏è' :
               currentWeather.weather.includes('Perfektn√≠') || currentWeather.weather.includes('N√°dhern√©') ? 'üåà' : 'üå§Ô∏è'}
            </div>
            <p className="text-2xl font-bold text-amber-900">{currentWeather.weather}</p>
            <Button onClick={() => setShowWeatherRoll(true)} variant="ghost" size="small">
              üîÑ Nov√Ω hod
            </Button>
          </div>
        ) : (
          <div className="text-center">
            <Button onClick={() => setShowWeatherRoll(true)}>
              üé≤ Hodit na poƒças√≠
            </Button>
          </div>
        )}
      </ResultCard>

      {/* Actions */}
      <ResultCard title="üé¨ Akce">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <Button onClick={() => travel(1)} variant="secondary" className="flex-col h-20">
            <span className="text-2xl">üö∂</span>
            <span className="text-sm">Cestovat (1 smƒõna)</span>
          </Button>
          <Button onClick={() => travel(2)} variant="secondary" className="flex-col h-20">
            <span className="text-2xl">üèÉ</span>
            <span className="text-sm">Dlouh√° cesta (2)</span>
          </Button>
          <Button onClick={() => takeRest('short')} variant="ghost" className="flex-col h-20">
            <span className="text-2xl">‚òï</span>
            <span className="text-sm">Kr√°tk√Ω odpoƒçinek</span>
          </Button>
          <Button onClick={() => takeRest('long')} variant="success" className="flex-col h-20">
            <span className="text-2xl">üèïÔ∏è</span>
            <span className="text-sm">Dlouh√Ω odpoƒçinek</span>
          </Button>
        </div>
      </ResultCard>

      {/* Usage Rolls */}
      <ResultCard title="üì¶ Hody na spot≈ôebu">
        <p className="text-sm text-stone-600 mb-3">Hoƒè d6 - na 4+ oznaƒç jedno pou≈æit√≠</p>
        <div className="flex flex-wrap gap-2">
          <Button onClick={() => rollUsage('Torch')} variant="ghost">üî• Pochode≈à</Button>
          <Button onClick={() => rollUsage('Rations')} variant="ghost">üçñ Z√°soby</Button>
          <Button onClick={() => rollUsage('Lantern')} variant="ghost">üèÆ Lucerna</Button>
          <Button onClick={() => rollUsage('Rope')} variant="ghost">ü™¢ Lano</Button>
          <Button onClick={() => rollUsage('Weapon')} variant="ghost">‚öîÔ∏è Zbra≈à</Button>
          <Button onClick={() => rollUsage('Armor')} variant="ghost">üõ°Ô∏è Zbroj</Button>
        </div>
      </ResultCard>

      {/* Faction Progress */}
      <ResultCard title="‚öîÔ∏è Frakƒçn√≠ pokrok">
        <p className="text-sm text-stone-600 mb-3">
          Hoƒè na pokrok v≈°ech frakc√≠ (doporuƒçeno jednou t√Ωdnƒõ)
        </p>
        <Button onClick={rollAllFactionProgress} className="w-full" disabled={factions.length === 0}>
          üé≤ Hodit pokrok v≈°ech frakc√≠ ({factions.length})
        </Button>
        {factions.length === 0 && (
          <p className="text-sm text-stone-400 mt-2 text-center">Nejprve p≈ôidej frakce v z√°lo≈æce Frakce</p>
        )}
      </ResultCard>

      {/* Quick Reference */}
      <ResultCard title="üìã Rychl√° reference">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div className="p-3 bg-amber-100/50 rounded">
            <h4 className="font-bold text-amber-900 mb-2">‚è∞ ƒåas</h4>
            <ul className="space-y-1 text-stone-700">
              <li>‚Ä¢ <strong>Turn</strong> = ~10 minut (dungeon)</li>
              <li>‚Ä¢ <strong>Watch/Smƒõna</strong> = ~6 hodin</li>
              <li>‚Ä¢ 4 smƒõny = 1 den</li>
              <li>‚Ä¢ 6 turns = 1 hodina</li>
            </ul>
          </div>
          <div className="p-3 bg-amber-100/50 rounded">
            <h4 className="font-bold text-amber-900 mb-2">üèïÔ∏è Odpoƒçinek</h4>
            <ul className="space-y-1 text-stone-700">
              <li>‚Ä¢ Kr√°tk√Ω: 1 turn, bez l√©ƒçen√≠</li>
              <li>‚Ä¢ Dlouh√Ω: 1 smƒõna, full HP</li>
              <li>‚Ä¢ Dlouh√Ω spot≈ôebuje z√°soby</li>
              <li>‚Ä¢ Sp√°nek v noci nutn√Ω</li>
            </ul>
          </div>
          <div className="p-3 bg-amber-100/50 rounded">
            <h4 className="font-bold text-amber-900 mb-2">‚õèÔ∏è Dungeon</h4>
            <ul className="space-y-1 text-stone-700">
              <li>‚Ä¢ Wandering monster: ka≈æd√© 2 turny</li>
              <li>‚Ä¢ Hod d6, na 1 = setk√°n√≠</li>
              <li>‚Ä¢ Pochode≈à vydr≈æ√≠ 6 turns</li>
              <li>‚Ä¢ Lucerna vydr≈æ√≠ 24 turns</li>
            </ul>
          </div>
          <div className="p-3 bg-amber-100/50 rounded">
            <h4 className="font-bold text-amber-900 mb-2">üö∂ Cestov√°n√≠</h4>
            <ul className="space-y-1 text-stone-700">
              <li>‚Ä¢ 1 hex = 1 smƒõna pƒõ≈°ky</li>
              <li>‚Ä¢ N√°hodn√© setk√°n√≠: 1 na d6</li>
              <li>‚Ä¢ ≈†patn√© poƒças√≠ = 2 smƒõny/hex</li>
              <li>‚Ä¢ Ztracen: WIL save nebo +1 smƒõna</li>
            </ul>
          </div>
        </div>
      </ResultCard>

      {/* Season Selector (for manual adjustment) */}
      <ResultCard title="‚öôÔ∏è Nastaven√≠ ƒçasu">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label className="text-sm text-stone-600 block mb-1">Roƒçn√≠ obdob√≠</label>
            <Select
              value={gameTime.season}
              onChange={(v) => setGameTime({ ...gameTime, season: v })}
              options={SEASONS.map(s => ({ value: s.id, label: `${s.icon} ${s.name}` }))}
            />
          </div>
          <div>
            <label className="text-sm text-stone-600 block mb-1">T√Ωden</label>
            <Input
              type="number"
              value={gameTime.week}
              onChange={(v) => setGameTime({ ...gameTime, week: Math.max(1, parseInt(v) || 1) })}
            />
          </div>
          <div>
            <label className="text-sm text-stone-600 block mb-1">Den</label>
            <Input
              type="number"
              value={gameTime.day}
              onChange={(v) => setGameTime({ ...gameTime, day: Math.max(1, Math.min(7, parseInt(v) || 1)) })}
            />
          </div>
          <div>
            <label className="text-sm text-stone-600 block mb-1">Smƒõna</label>
            <Select
              value={gameTime.watch}
              onChange={(v) => setGameTime({ ...gameTime, watch: parseInt(v) })}
              options={WATCHES.map((w, i) => ({ value: i, label: `${w.icon} ${w.name}` }))}
            />
          </div>
        </div>
      </ResultCard>
    </div>
  );
};

// ============================================
// JOURNAL PANEL
// ============================================

const JournalPanel = ({ journal, setJournal, parties, partyFilter, setPartyFilter, onExport }) => {
  const [newEntry, setNewEntry] = useState('');
  const [filter, setFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [editText, setEditText] = useState('');
  const [showFilters, setShowFilters] = useState(false);

  const addNarrativeEntry = () => {
    if (!newEntry.trim()) return;
    
    const entry = {
      id: generateId(),
      type: 'narrative',
      timestamp: formatTimestamp(),
      content: newEntry,
      partyId: partyFilter !== 'all' ? partyFilter : null
    };
    
    setJournal([entry, ...journal]);
    setNewEntry('');
  };

  const [confirmDeleteId, setConfirmDeleteId] = useState(null);

  const deleteEntry = (id) => {
    setJournal(journal.filter(e => e.id !== id));
    setEditingId(null);
    setConfirmDeleteId(null);
  };

  const startEdit = (entry) => {
    setEditingId(entry.id);
    // For narrative entries, edit the content. For others, edit/add a note.
    if (entry.type === 'narrative') {
      setEditText(entry.content || '');
    } else {
      setEditText(entry.note || '');
    }
  };

  const saveEdit = (id) => {
    setJournal(journal.map(e => {
      if (e.id !== id) return e;
      
      if (e.type === 'narrative') {
        // For narrative, replace content
        return { ...e, content: editText, edited: true };
      } else {
        // For other types, add/edit note
        return { ...e, note: editText, edited: true };
      }
    }));
    setEditingId(null);
    setEditText('');
  };

  const filteredJournal = journal.filter(entry => {
    if (partyFilter !== 'all' && entry.partyId && entry.partyId !== partyFilter) return false;
    if (filter !== 'all' && entry.type !== filter) return false;
    if (searchTerm) {
      const searchLower = searchTerm.toLowerCase();
      const content = JSON.stringify(entry).toLowerCase();
      return content.includes(searchLower);
    }
    return true;
  });

  // Group entries by date
  const groupedByDate = {};
  filteredJournal.forEach(entry => {
    // Parse Czech date format "31. 12. 2024 14:30:25" -> "31. 12. 2024"
    const parts = entry.timestamp?.split(' ') || [];
    const date = parts.length >= 3 ? `${parts[0]} ${parts[1]} ${parts[2]}` : (entry.timestamp || 'Nezn√°m√© datum');
    if (!groupedByDate[date]) groupedByDate[date] = [];
    groupedByDate[date].push(entry);
  });

  // Format entry based on type - book style
  const formatEntry = (entry) => {
    if (editingId === entry.id) {
      return (
        <div className="my-2 bg-white rounded-lg border border-amber-300 p-3">
          <p className="text-xs text-stone-500 mb-2">
            {entry.type === 'narrative' ? 'üìù Upravit text:' : 'üìù P≈ôidat/upravit pozn√°mku:'}
          </p>
          <textarea
            value={editText}
            onChange={(e) => setEditText(e.target.value)}
            className="w-full h-24 p-3 border border-stone-200 rounded-lg bg-amber-50/50 focus:outline-none focus:border-amber-400 font-serif text-stone-800"
            placeholder={entry.type === 'narrative' ? 'Tv≈Øj p≈ô√≠bƒõh...' : 'P≈ôidej pozn√°mku k tomuto z√°znamu...'}
            autoFocus
          />
          <div className="flex justify-between mt-2">
            <div className="flex gap-2">
              <button onClick={() => saveEdit(entry.id)} className="px-3 py-1 bg-amber-600 text-white rounded text-sm hover:bg-amber-700">
                ‚úì Ulo≈æit
              </button>
              <button onClick={() => { setEditingId(null); setConfirmDeleteId(null); }} className="px-3 py-1 text-stone-500 hover:text-stone-700 text-sm">
                Zru≈°it
              </button>
            </div>
            {confirmDeleteId === entry.id ? (
              <div className="flex gap-2">
                <button 
                  onClick={() => deleteEntry(entry.id)} 
                  className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600"
                >
                  Ano, smazat
                </button>
                <button 
                  onClick={() => setConfirmDeleteId(null)} 
                  className="px-3 py-1 text-stone-500 hover:text-stone-700 text-sm"
                >
                  Ne
                </button>
              </div>
            ) : (
              <button 
                onClick={() => setConfirmDeleteId(entry.id)} 
                className="px-3 py-1 text-red-400 hover:text-red-600 text-sm"
              >
                Smazat
              </button>
            )}
          </div>
        </div>
      );
    }

    switch (entry.type) {
      case 'narrative':
        return (
          <p className="text-stone-800 italic leading-relaxed my-3 cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors" 
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            {entry.content}
            {entry.edited && <span className="text-xs text-stone-400 ml-1">‚úé</span>}
          </p>
        );
      
      case 'oracle':
        // Handle custom_dice subtype differently
        if (entry.subtype === 'custom_dice') {
          return (
            <div className="my-2 pl-4 border-l-2 border-stone-300 cursor-pointer hover:bg-amber-50 rounded transition-colors"
                 onClick={() => startEdit(entry)}
                 title="Klikni pro √∫pravu">
              {entry.reason && <p className="text-stone-700 font-medium">{entry.reason}</p>}
              <p className="text-amber-900">
                <span className="text-stone-500 text-sm">{entry.count}d{entry.sides}: </span>
                <span className="font-bold">[{entry.dice?.join(', ')}]</span>
                {entry.count > 1 && <span className="font-bold"> = {entry.total}</span>}
              </p>
              {entry.note && <p className="text-stone-600 italic text-sm mt-1">{entry.note}</p>}
            </div>
          );
        }
        // Standard oracle (yes/no, etc.)
        return (
          <div className="my-2 pl-4 border-l-2 border-amber-400 cursor-pointer hover:bg-amber-50 rounded transition-colors"
               onClick={() => startEdit(entry)}
               title="Klikni pro √∫pravu">
            {entry.question && <p className="text-stone-600 text-sm">‚Äû{entry.question}"</p>}
            <p className="font-bold text-amber-900">
              {entry.dice && <span className="font-normal text-stone-500 text-xs">[{entry.dice.join(', ')}] </span>}
              {entry.result}
            </p>
            {entry.note && <p className="text-stone-700 italic text-sm mt-1">{entry.note}</p>}
            {entry.edited && <span className="text-xs text-stone-400">‚úé</span>}
          </div>
        );
      
      case 'combat_action':
        return (
          <p className="my-1 text-sm text-stone-700 font-medium cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            ‚öîÔ∏è <strong>{entry.attacker}</strong> ‚Üí <strong>{entry.target}</strong>: {entry.hitResult}, {entry.damage} dmg
            {entry.note && <span className="font-normal italic text-stone-600 ml-2">{entry.note}</span>}
          </p>
        );

      case 'combat_end':
        return (
          <p className="my-2 text-sm font-bold text-amber-800 border-t border-b border-amber-200 py-1 cursor-pointer hover:bg-amber-50 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            üèÅ Boj skonƒçil
            {entry.note && <span className="font-normal italic ml-2">{entry.note}</span>}
          </p>
        );
      
      case 'discovery':
        return (
          <div className="my-2 bg-amber-100/50 rounded px-3 py-2 cursor-pointer hover:bg-amber-100 transition-colors"
               onClick={() => startEdit(entry)}
               title="Klikni pro √∫pravu">
            <p className="font-bold text-amber-900">{entry.subtype}: {entry.data?.name}</p>
            {entry.data?.trait && <p className="text-stone-600 text-sm italic">{entry.data.trait}</p>}
            {entry.data?.appearance && <p className="text-stone-600 text-sm">{entry.data.appearance}</p>}
            {entry.note && <p className="text-stone-700 italic text-sm mt-1 border-t border-amber-200 pt-1">{entry.note}</p>}
          </div>
        );
      
      case 'faction_progress':
        return (
          <p className="my-1 text-xs text-stone-500 cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            <span className="font-medium text-stone-700">{entry.faction}</span>: {entry.success ? '‚úì pokrok' : '‚Äì beze zmƒõny'} 
            <span className="opacity-60"> (d6={entry.roll}+{entry.bonus})</span>
            {entry.note && <span className="italic text-stone-600 ml-2">{entry.note}</span>}
          </p>
        );

      case 'time_advance':
        return (
          <p className="my-2 text-xs text-amber-700 font-medium tracking-wide uppercase cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            ‚òÄÔ∏è {['R√°no', 'Odpoledne', 'Veƒçer', 'Noc'][entry.to?.watch || 0]}
            {entry.events?.includes('new_day') && ' ‚Äî Nov√Ω den'}
            {entry.events?.includes('new_week') && ' ‚Äî Nov√Ω t√Ωden'}
            {entry.note && <span className="normal-case font-normal text-stone-600 ml-2">‚Ä¢ {entry.note}</span>}
          </p>
        );

      case 'weather':
        return (
          <p className="my-1 text-sm text-stone-600 cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            <span className="text-blue-600">‚òÅÔ∏è</span> Poƒças√≠: <em>{entry.weather}</em>
            {entry.note && <span className="italic ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'world_event':
        // Handle world_event with subtypes
        if (entry.subtype === 'weather' || entry.data?.type === 'weather') {
          return (
            <p className="my-1 text-sm text-stone-600 cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
               onClick={() => startEdit(entry)}
               title="Klikni pro √∫pravu">
              <span className="text-blue-600">‚òÅÔ∏è</span> Poƒças√≠: <em>{entry.data?.weather || entry.weather}</em>
              {entry.note && <span className="italic ml-2">‚Äî {entry.note}</span>}
            </p>
          );
        }
        // Generic world event
        return (
          <p className="my-1 text-sm text-stone-600 cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            üåç {entry.data?.name || entry.content || JSON.stringify(entry.data)}
            {entry.note && <span className="italic ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'rest':
        return (
          <p className="my-1 text-sm text-green-700 cursor-pointer hover:bg-green-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            {entry.subtype === 'short' ? '‚òï Kr√°tk√Ω odpoƒçinek' : 'üèïÔ∏è Dlouh√Ω odpoƒçinek v bezpeƒç√≠'}
            {entry.note && <span className="italic text-stone-600 ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'usage_roll':
        return (
          <p className="my-1 text-xs text-stone-500 cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            üì¶ {entry.item}: {entry.consumed ? <span className="text-orange-600">spot≈ôebov√°no!</span> : <span className="text-green-600">OK</span>}
            {entry.note && <span className="italic text-stone-600 ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'random_encounter':
        return (
          <div className="my-2 cursor-pointer hover:bg-red-50 rounded px-1 -mx-1 transition-colors"
               onClick={() => startEdit(entry)}
               title="Klikni pro √∫pravu">
            <p className="text-red-700 font-bold">‚ö†Ô∏è N√°hodn√© setk√°n√≠!</p>
            {entry.note && <p className="italic text-stone-700 text-sm">{entry.note}</p>}
          </div>
        );

      case 'dungeon_turn':
        return (
          <p className="my-1 text-xs text-stone-500 uppercase tracking-wider cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            ‚õèÔ∏è Tah {entry.turn} ‚Äî pochode≈à: {6 - entry.torchTurns}/6
            {entry.note && <span className="normal-case ml-2">‚Ä¢ {entry.note}</span>}
          </p>
        );

      case 'wandering_monster_check':
        if (!entry.encounter) return null; // Don't show "nothing happens"
        return (
          <div className="my-2 cursor-pointer hover:bg-red-50 rounded px-1 -mx-1 transition-colors"
               onClick={() => startEdit(entry)}
               title="Klikni pro √∫pravu">
            <p className="text-red-700 font-bold">üëπ Nƒõco se bl√≠≈æ√≠!</p>
            {entry.note && <p className="italic text-stone-700 text-sm">{entry.note}</p>}
          </div>
        );

      case 'torch_lit':
        return (
          <p className="my-1 text-xs text-orange-600 cursor-pointer hover:bg-orange-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            üî• Nov√° pochode≈à
            {entry.note && <span className="text-stone-600 ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'loyalty_check':
        return (
          <p className="my-1 text-sm cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            ü§ù Test loajality ({entry.hireling}): {entry.success 
              ? <span className="text-green-700">z≈Øst√°v√° vƒõrn√Ω</span> 
              : <span className="text-red-700 font-bold">ZRADA!</span>}
            {entry.note && <span className="italic text-stone-600 ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'character_created':
        return (
          <p className="my-2 text-amber-800 font-medium cursor-pointer hover:bg-amber-50 rounded px-1 -mx-1 transition-colors"
             onClick={() => startEdit(entry)}
             title="Klikni pro √∫pravu">
            üê≠ Na sc√©nu vstupuje <strong>{entry.character}</strong>
            {entry.note && <span className="font-normal italic text-stone-600 ml-2">‚Äî {entry.note}</span>}
          </p>
        );

      case 'state_change':
        // HP/stat changes - very subtle, or hide completely
        if (entry.subtype === 'hp') {
          const sign = entry.change > 0 ? '+' : '';
          return (
            <span className="text-xs text-stone-400 cursor-pointer hover:bg-amber-50 rounded px-1 transition-colors"
                  onClick={() => startEdit(entry)}
                  title="Klikni pro √∫pravu">
              {entry.change > 0 ? 'üíö' : 'üíî'} {sign}{entry.change} HP
              {entry.note && <span className="italic ml-1">({entry.note})</span>}
            </span>
          );
        }
        return null; // Hide other state changes
      
      default:
        // For any other type, show as mechanical note
        const content = entry.content || entry.data || entry;
        return (
          <div className="my-1 cursor-pointer hover:bg-stone-100 rounded px-1 -mx-1 transition-colors"
               onClick={() => startEdit(entry)}
               title="Klikni pro √∫pravu">
            <p className="text-xs text-stone-500 font-mono">
              {typeof content === 'string' ? content : JSON.stringify(content)}
            </p>
            {entry.note && <p className="text-sm text-stone-700 italic mt-1">{entry.note}</p>}
          </div>
        );
    }
  };

  return (
    <div className="max-w-3xl mx-auto">
      {/* Header */}
      <div className="text-center mb-8 pt-4">
        <h1 className="text-3xl font-serif text-amber-900 mb-2">Kronika dobrodru≈æstv√≠</h1>
        <p className="text-stone-500 text-sm">{journal.length} z√°znam≈Ø</p>
      </div>

      {/* New Entry - Expandable */}
      <div className="mb-8">
        <textarea
          value={newEntry}
          onChange={(e) => setNewEntry(e.target.value)}
          placeholder="Pokraƒçuj v p≈ô√≠bƒõhu... (pi≈° kurz√≠vou pro vypr√°vƒõn√≠)"
          className="w-full h-24 px-4 py-3 bg-white border border-amber-200 rounded-lg focus:outline-none focus:border-amber-400 text-stone-800 font-serif italic resize-none shadow-sm"
        />
        {newEntry.trim() && (
          <div className="flex justify-end mt-2">
            <button 
              onClick={addNarrativeEntry}
              className="px-4 py-2 bg-amber-700 text-white rounded-lg hover:bg-amber-800 transition-colors text-sm"
            >
              P≈ôidat z√°pis
            </button>
          </div>
        )}
      </div>

      {/* Filters - Collapsible */}
      <div className="mb-6 border-b border-amber-200 pb-4">
        <button 
          onClick={() => setShowFilters(!showFilters)}
          className="text-sm text-stone-500 hover:text-stone-700 flex items-center gap-1"
        >
          <span>{showFilters ? '‚ñº' : '‚ñ∂'}</span> Filtry a n√°stroje
        </button>
        {showFilters && (
          <div className="mt-3 flex flex-wrap gap-3 items-center">
            <input 
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Hledat..."
              className="px-3 py-1 border border-stone-200 rounded text-sm w-40"
            />
            {parties?.length > 1 && (
              <select 
                value={partyFilter}
                onChange={(e) => setPartyFilter(e.target.value)}
                className="px-2 py-1 border border-stone-200 rounded text-sm"
              >
                <option value="all">V≈°echny dru≈æiny</option>
                {parties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
              </select>
            )}
            <select 
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className="px-2 py-1 border border-stone-200 rounded text-sm"
            >
              <option value="all">V≈°e</option>
              <option value="narrative">P≈ô√≠bƒõh</option>
              <option value="oracle">Oracle</option>
              <option value="combat_action">Boj</option>
              <option value="discovery">Objevy</option>
            </select>
            <button onClick={onExport} className="px-3 py-1 text-sm text-amber-700 hover:text-amber-900">
              üì§ Export
            </button>
          </div>
        )}
      </div>

      {/* Journal Content - Book Style */}
      <div className="bg-gradient-to-b from-amber-50/50 to-white rounded-lg shadow-sm border border-amber-100">
        {filteredJournal.length === 0 ? (
          <div className="text-center py-16 text-stone-400 font-serif italic">
            {journal.length === 0 
              ? 'P≈ô√≠bƒõh je≈°tƒõ nezaƒçal...'
              : '≈Ω√°dn√© z√°znamy neodpov√≠daj√≠ filtru'}
          </div>
        ) : (
          <div className="px-6 py-8 font-serif">
            {Object.entries(groupedByDate).map(([date, entries], dateIndex) => (
              <div key={date} className={dateIndex > 0 ? 'mt-8 pt-6 border-t border-amber-100' : ''}>
                {/* Date header - subtle */}
                <p className="text-xs text-stone-400 mb-4 font-sans tracking-wider uppercase">{date}</p>
                
                {/* Entries for this date */}
                {entries.map((entry, i) => {
                  const content = formatEntry(entry);
                  if (!content) return null; // Skip entries that return null
                  
                  return (
                    <div key={entry.id}>
                      {content}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Reading tip */}
      <p className="text-center text-xs text-stone-400 mt-6 font-sans">
        üí° Klikni na z√°znam pro √∫pravu nebo smaz√°n√≠
      </p>
    </div>
  );
};

// ============================================
// MAIN APP
// ============================================

function MausritterSoloCompanion() {
  const [activePanel, setActivePanel] = useState('journal');
  
  // Cloud sync state (File System API)
  const [fileHandle, setFileHandle] = useState(null);
  const [syncStatus, setSyncStatus] = useState('disconnected'); // 'disconnected' | 'connected' | 'saving' | 'error'
  const [lastSyncTime, setLastSyncTime] = useState(null);

  // Google Drive sync state
  const [googleAccessToken, setGoogleAccessToken] = useState(null);
  const [googleDriveFileId, setGoogleDriveFileId] = useState(null);
  const [googleSyncStatus, setGoogleSyncStatus] = useState('disconnected'); // 'disconnected' | 'connecting' | 'connected' | 'saving' | 'error'
  const [googleLastSync, setGoogleLastSync] = useState(null);
  const [googleDriveFolderId, setGoogleDriveFolderId] = useState(null);
  const [googleDriveFolderName, setGoogleDriveFolderName] = useState(null);
  const googleTokenClientRef = useRef(null);

  // NEW: Parties system - replaces single character
  const [parties, setParties] = useState([]);
  const [activePartyId, setActivePartyId] = useState(null);
  const [activeCharacterId, setActiveCharacterId] = useState(null);
  
  const [journal, setJournal] = useState([]);
  const [factions, setFactions] = useState([]);
  const [settlements, setSettlements] = useState([]);
  const [worldNPCs, setWorldNPCs] = useState([]);
  const [journalPartyFilter, setJournalPartyFilter] = useState('all');

  // Helper: Get active party
  const activeParty = parties.find(p => p.id === activePartyId) || null;
  
  // Helper: Get active character (for detail view)
  const activeCharacter = activeParty?.members?.find(m => m.id === activeCharacterId) || null;

  // Helper: Update party
  const updateParty = (partyId, updates) => {
    setParties(parties.map(p => p.id === partyId ? { ...p, ...updates } : p));
  };

  // Helper: Update character within party
  const updateCharacterInParty = (partyId, charId, updates) => {
    setParties(parties.map(p => {
      if (p.id !== partyId) return p;
      return {
        ...p,
        members: p.members.map(m => m.id === charId ? { ...m, ...updates } : m)
      };
    }));
  };

  // Helper: Create new party
  const createParty = (name = 'Nov√° dru≈æina') => {
    const newParty = {
      id: generateId(),
      name,
      members: [],
      gameTime: {
        watch: 0,
        day: 1,
        week: 1,
        season: 'spring',
        totalWatches: 0,
        lastRest: null
      },
      createdAt: new Date().toISOString()
    };
    setParties([...parties, newParty]);
    setActivePartyId(newParty.id);
    return newParty;
  };

  // Helper: Create new PC
  const createPC = (partyId, characterData = null) => {
    const newChar = characterData || {
      id: generateId(),
      type: 'pc',
      name: `${randomFrom(FIRST_NAMES)} ${randomFrom(LAST_NAMES)}`,
      pronouns: '',
      level: 1,
      STR: { current: 10, max: 10 },
      DEX: { current: 10, max: 10 },
      WIL: { current: 10, max: 10 },
      hp: { current: 6, max: 6 },
      pips: 0,
      xp: 0,
      birthsign: randomFrom(BIRTHSIGNS),
      physicalDetail: randomFrom(PHYSICAL_DETAILS),
      conditions: [],
      inventory: [],
      spells: []
    };
    if (!newChar.id) newChar.id = generateId();
    if (!newChar.type) newChar.type = 'pc';
    
    setParties(parties.map(p => {
      if (p.id !== partyId) return p;
      return { ...p, members: [...p.members, newChar] };
    }));
    return newChar;
  };

  // Helper: Create new Hireling
  const createHireling = (partyId) => {
    const newHireling = {
      id: generateId(),
      type: 'hireling',
      name: `${randomFrom(FIRST_NAMES)} ${randomFrom(LAST_NAMES)}`,
      hp: { current: 3, max: 3 },
      loyalty: 7, // 2d6 check threshold
      cost: '1 pip/den',
      skills: [],
      mount: null,
      physicalDetail: randomFrom(PHYSICAL_DETAILS)
    };
    
    setParties(parties.map(p => {
      if (p.id !== partyId) return p;
      return { ...p, members: [...p.members, newHireling] };
    }));
    return newHireling;
  };

  // Helper: Remove character from party
  const removeCharacter = (partyId, charId) => {
    setParties(parties.map(p => {
      if (p.id !== partyId) return p;
      return { ...p, members: p.members.filter(m => m.id !== charId) };
    }));
    if (activeCharacterId === charId) {
      setActiveCharacterId(null);
    }
  };

  // Helper: Remove party
  const removeParty = (partyId) => {
    setParties(parties.filter(p => p.id !== partyId));
    if (activePartyId === partyId) {
      const remaining = parties.filter(p => p.id !== partyId);
      setActivePartyId(remaining.length > 0 ? remaining[0].id : null);
      setActiveCharacterId(null);
    }
  };

  // Load saved data with migration
  useEffect(() => {
    try {
      const saved = localStorage.getItem('mausritter-save');
      if (saved) {
        const rawData = JSON.parse(saved);
        
        // Use migration system to upgrade old saves
        const data = migrateSaveData(rawData);
        
        // Load migrated data
        setParties(data.parties);
        if (data.activePartyId) setActivePartyId(data.activePartyId);
        if (data.activeCharacterId) setActiveCharacterId(data.activeCharacterId);
        setJournal(data.journal);
        setFactions(data.factions);
        setSettlements(data.settlements);
        setWorldNPCs(data.worldNPCs);
        
        // Log if migration happened
        const oldVersion = rawData.version || 1;
        if (oldVersion < SAVE_VERSION) {
          console.log(`Save migrated from v${oldVersion} to v${SAVE_VERSION}`);
        }
      }
    } catch (e) {
      console.error('Failed to load save:', e);
    }
  }, []);

  // Auto-save
  useEffect(() => {
    const saveData = { 
      version: SAVE_VERSION,
      parties, 
      activePartyId, 
      activeCharacterId,
      journal, 
      factions,
      settlements,
      worldNPCs
    };
    localStorage.setItem('mausritter-save', JSON.stringify(saveData));
  }, [parties, activePartyId, activeCharacterId, journal, factions, settlements, worldNPCs]);

  const handleLogEntry = useCallback((entry) => {
    setJournal(prev => [{ 
      ...entry, 
      id: generateId(),
      partyId: activePartyId // Tag entry with current party
    }, ...prev]);
  }, [activePartyId]);

  const handleExport = () => {
    const exportData = {
      version: SAVE_VERSION,
      parties,
      activePartyId,
      activeCharacterId,
      journal,
      factions,
      settlements,
      worldNPCs,
      exportDate: new Date().toISOString()
    };
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    const partyName = activeParty?.name || 'adventure';
    a.download = `mausritter-${partyName.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  };

  const handleImport = (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const rawData = JSON.parse(e.target.result);
        const oldVersion = rawData.version || 1;
        
        // Migrate to current version
        const data = migrateSaveData(rawData);
        
        // Load migrated data
        setParties(data.parties);
        setActivePartyId(data.activePartyId);
        setActiveCharacterId(data.activeCharacterId);
        setJournal(data.journal);
        setFactions(data.factions);
        setSettlements(data.settlements);
        setWorldNPCs(data.worldNPCs);
        
        if (oldVersion < SAVE_VERSION) {
          alert(`‚úÖ Save √∫spƒõ≈°nƒõ nahr√°n!\n\nüì¶ Save byl automaticky aktualizov√°n z verze ${oldVersion} na ${SAVE_VERSION}.`);
        } else {
          alert('‚úÖ Save √∫spƒõ≈°nƒõ nahr√°n!');
        }
      } catch (err) {
        alert('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ souboru: ' + err.message);
      }
    };
    reader.readAsText(file);
    event.target.value = ''; // Reset input
  };

  // ============================================
  // CLOUD SYNC (File System Access API)
  // ============================================
  
  // Check if File System Access API is supported
  const isFileSystemSupported = typeof window !== 'undefined' && 'showSaveFilePicker' in window;

  // Get current save data
  const getSaveData = useCallback(() => ({
    version: SAVE_VERSION,
    parties,
    activePartyId,
    activeCharacterId,
    journal,
    factions,
    settlements,
    worldNPCs,
    lastModified: new Date().toISOString()
  }), [parties, activePartyId, activeCharacterId, journal, factions, settlements, worldNPCs]);

  // Save to connected file
  const saveToFile = useCallback(async () => {
    if (!fileHandle) return;
    
    try {
      setSyncStatus('saving');
      const writable = await fileHandle.createWritable();
      const data = getSaveData();
      await writable.write(JSON.stringify(data, null, 2));
      await writable.close();
      setLastSyncTime(new Date());
      setSyncStatus('connected');
    } catch (err) {
      console.error('Failed to save to file:', err);
      setSyncStatus('error');
    }
  }, [fileHandle, getSaveData]);

  // Load from connected file
  const loadFromFile = useCallback(async (handle) => {
    try {
      const file = await handle.getFile();
      const text = await file.text();
      const rawData = JSON.parse(text);
      const data = migrateSaveData(rawData);
      
      setParties(data.parties);
      setActivePartyId(data.activePartyId);
      setActiveCharacterId(data.activeCharacterId);
      setJournal(data.journal);
      setFactions(data.factions);
      setSettlements(data.settlements);
      setWorldNPCs(data.worldNPCs);
      
      return true;
    } catch (err) {
      console.error('Failed to load from file:', err);
      return false;
    }
  }, []);

  // Connect to a file (pick or create)
  const connectToFile = async () => {
    if (!isFileSystemSupported) {
      alert('Tv≈Øj prohl√≠≈æeƒç nepodporuje File System API. Pou≈æij Chrome nebo Edge.');
      return;
    }
    
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: 'mausritter-save.json',
        types: [{
          description: 'JSON Save File',
          accept: { 'application/json': ['.json'] }
        }]
      });
      
      setFileHandle(handle);
      setSyncStatus('connected');
      
      // Try to load existing data from file
      try {
        const file = await handle.getFile();
        if (file.size > 0) {
          const loaded = await loadFromFile(handle);
          if (loaded) {
            alert('‚úÖ Soubor p≈ôipojen a data naƒçtena!');
          }
        } else {
          // New file - save current data
          const writable = await handle.createWritable();
          await writable.write(JSON.stringify(getSaveData(), null, 2));
          await writable.close();
          alert('‚úÖ Nov√Ω soubor vytvo≈ôen a data ulo≈æena!');
        }
      } catch (e) {
        // File might be new/empty, save current data
        const writable = await handle.createWritable();
        await writable.write(JSON.stringify(getSaveData(), null, 2));
        await writable.close();
      }
      
      setLastSyncTime(new Date());
    } catch (err) {
      if (err.name !== 'AbortError') {
        console.error('Failed to connect to file:', err);
        alert('Nepoda≈ôilo se p≈ôipojit k souboru: ' + err.message);
      }
    }
  };

  // Disconnect from file
  const disconnectFile = () => {
    setFileHandle(null);
    setSyncStatus('disconnected');
    setLastSyncTime(null);
  };

  // Auto-save to file when data changes (debounced)
  const saveTimeoutRef = useRef(null);
  useEffect(() => {
    if (!fileHandle || syncStatus !== 'connected') return;
    
    // Debounce: wait 2 seconds after last change before saving
    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current);
    }
    
    saveTimeoutRef.current = setTimeout(() => {
      saveToFile();
    }, 2000);
    
    return () => {
      if (saveTimeoutRef.current) {
        clearTimeout(saveTimeoutRef.current);
      }
    };
  }, [parties, journal, factions, settlements, worldNPCs, fileHandle, syncStatus, saveToFile]);

  // Manual sync button
  const handleManualSync = async () => {
    if (fileHandle) {
      await saveToFile();
    }
  };

  // ============================================
  // GOOGLE DRIVE SYNC
  // ============================================

  // Initialize Google Identity Services
  useEffect(() => {
    if (typeof google === 'undefined' || !google.accounts) return;

    googleTokenClientRef.current = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: GOOGLE_SCOPES,
      callback: (response) => {
        if (response.error) {
          console.error('Google OAuth error:', response);
          setGoogleSyncStatus('error');
          return;
        }
        setGoogleAccessToken(response.access_token);
        // Open folder picker after successful auth
        openFolderPicker(response.access_token);
      }
    });
  }, []);

  // Open Google Picker to select folder
  const openFolderPicker = (token) => {
    gapi.load('picker', () => {
      const picker = new google.picker.PickerBuilder()
        .setTitle('Vyber slo≈æku pro ukl√°d√°n√≠')
        .addView(new google.picker.DocsView()
          .setIncludeFolders(true)
          .setSelectFolderEnabled(true)
          .setMimeTypes('application/vnd.google-apps.folder'))
        .setOAuthToken(token)
        .setDeveloperKey(GOOGLE_API_KEY)
        .setCallback((data) => {
          if (data.action === google.picker.Action.PICKED) {
            const folder = data.docs[0];
            setGoogleDriveFolderId(folder.id);
            setGoogleDriveFolderName(folder.name);
            setGoogleSyncStatus('connected');
            // Find or create save file in selected folder
            findOrCreateGoogleDriveFile(token, folder.id);
          } else if (data.action === google.picker.Action.CANCEL) {
            setGoogleSyncStatus('disconnected');
            setGoogleAccessToken(null);
          }
        })
        .build();
      picker.setVisible(true);
    });
  };

  // Find existing save file or create new one in selected folder
  const findOrCreateGoogleDriveFile = async (token, folderId = googleDriveFolderId) => {
    try {
      // Search for existing file in folder
      const query = folderId 
        ? `name='mausritter-save.json' and '${folderId}' in parents and trashed=false`
        : `name='mausritter-save.json' and trashed=false`;
      const searchResponse = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
        {
          headers: { Authorization: `Bearer ${token}` }
        }
      );
      const searchData = await searchResponse.json();

      if (searchData.files && searchData.files.length > 0) {
        // Use existing file
        const fileId = searchData.files[0].id;
        setGoogleDriveFileId(fileId);
        await loadFromGoogleDrive(token, fileId);
        setGoogleLastSync(new Date());
      } else {
        // Create new file in selected folder
        await saveToGoogleDrive(token, null, folderId);
      }
    } catch (err) {
      console.error('Google Drive file search failed:', err);
      setGoogleSyncStatus('error');
    }
  };

  // Connect to Google Drive
  const connectGoogleDrive = () => {
    if (!googleTokenClientRef.current) {
      alert('Google API nen√≠ naƒçten√©. Zkus obnovit str√°nku.');
      return;
    }
    setGoogleSyncStatus('connecting');
    googleTokenClientRef.current.requestAccessToken();
  };

  // Disconnect from Google Drive
  const disconnectGoogleDrive = () => {
    if (googleAccessToken) {
      google.accounts.oauth2.revoke(googleAccessToken);
    }
    setGoogleAccessToken(null);
    setGoogleDriveFileId(null);
    setGoogleDriveFolderId(null);
    setGoogleDriveFolderName(null);
    setGoogleSyncStatus('disconnected');
    setGoogleLastSync(null);
  };

  // Save to Google Drive
  const saveToGoogleDrive = async (token = googleAccessToken, fileId = googleDriveFileId, folderId = googleDriveFolderId) => {
    if (!token) return;

    try {
      setGoogleSyncStatus('saving');
      const data = getSaveData();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });

      if (fileId) {
        // Update existing file
        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
          method: 'PATCH',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: blob
        });
      } else {
        // Create new file in selected folder
        const metadata = {
          name: 'mausritter-save.json',
          mimeType: 'application/json',
          ...(folderId && { parents: [folderId] })
        };

        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: form
        });
        const result = await response.json();
        setGoogleDriveFileId(result.id);
      }

      setGoogleLastSync(new Date());
      setGoogleSyncStatus('connected');
    } catch (err) {
      console.error('Google Drive save failed:', err);
      setGoogleSyncStatus('error');
    }
  };

  // Load from Google Drive
  const loadFromGoogleDrive = async (token = googleAccessToken, fileId = googleDriveFileId) => {
    if (!token || !fileId) return false;

    try {
      const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const rawData = await response.json();
      const data = migrateSaveData(rawData);

      setParties(data.parties);
      setActivePartyId(data.activePartyId);
      setActiveCharacterId(data.activeCharacterId);
      setJournal(data.journal);
      setFactions(data.factions);
      setSettlements(data.settlements);
      setWorldNPCs(data.worldNPCs);

      return true;
    } catch (err) {
      console.error('Google Drive load failed:', err);
      return false;
    }
  };

  // Auto-save to Google Drive when data changes (debounced)
  const googleSaveTimeoutRef = useRef(null);
  useEffect(() => {
    if (!googleAccessToken || googleSyncStatus !== 'connected' || !googleDriveFileId) return;

    if (googleSaveTimeoutRef.current) {
      clearTimeout(googleSaveTimeoutRef.current);
    }

    googleSaveTimeoutRef.current = setTimeout(() => {
      saveToGoogleDrive();
    }, 3000); // 3 second debounce for Google Drive

    return () => {
      if (googleSaveTimeoutRef.current) {
        clearTimeout(googleSaveTimeoutRef.current);
      }
    };
  }, [parties, journal, factions, settlements, worldNPCs, googleAccessToken, googleSyncStatus, googleDriveFileId]);

  // Manual Google Drive sync
  const handleGoogleDriveSync = async () => {
    if (googleAccessToken && googleDriveFileId) {
      await saveToGoogleDrive();
    }
  };

  const panels = [
    { id: 'journal', label: 'Den√≠k', icon: 'üìñ' },
    { id: 'character', label: 'Postavy', icon: 'üê≠' },
    { id: 'oracle', label: 'Vƒõ≈°t√≠rna', icon: 'üîÆ' },
    { id: 'combat', label: 'Boj', icon: '‚öîÔ∏è' },
    { id: 'time', label: 'ƒåas', icon: '‚è∞' },
    { id: 'world', label: 'Svƒõt', icon: 'üåç' },
    { id: 'factions', label: 'Frakce', icon: 'üè∞' },
    { id: 'studio', label: 'Kartiƒçky', icon: 'üé¥' },
    { id: 'howto', label: 'Jak hr√°t', icon: 'üìö' }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-100 via-amber-50 to-orange-100">
      {/* Background Pattern */}
      <div className="fixed inset-0 opacity-5 pointer-events-none" style={{
        backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
      }} />
      
      {/* Header */}
      <header className="bg-gradient-to-r from-amber-900 via-amber-800 to-amber-900 text-amber-50 shadow-xl sticky top-0 z-50">
        <div className="max-w-6xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-4xl">üê≠</span>
              <div>
                <h1 className="text-2xl font-bold tracking-wide" style={{ fontFamily: 'Georgia, serif' }}>
                  Mausritter Solo Companion
                </h1>
                {activeParty && (
                  <p className="text-amber-200 text-sm">
                    üèïÔ∏è {activeParty.name}
                    {activeCharacter && (
                      <span> ‚Ä¢ üê≠ {activeCharacter.name}</span>
                    )}
                    {activeCharacter?.hp && (
                      <span> ‚Ä¢ HP {activeCharacter.hp.current}/{activeCharacter.hp.max}</span>
                    )}
                    {activeParty.gameTime && (
                      <span> ‚Ä¢ {['üåÖ', '‚òÄÔ∏è', 'üåÜ', 'üåô'][activeParty.gameTime.watch]} Den {activeParty.gameTime.day}</span>
                    )}
                  </p>
                )}
              </div>
            </div>
            <div className="flex items-center gap-2">
              {/* Cloud Sync Status */}
              {fileHandle ? (
                <div className="flex items-center gap-1">
                  <span 
                    className={`text-xs px-2 py-1 rounded ${
                      syncStatus === 'saving' ? 'bg-yellow-600 text-yellow-100' :
                      syncStatus === 'error' ? 'bg-red-600 text-red-100' :
                      'bg-green-700 text-green-100'
                    }`}
                    title={lastSyncTime ? `Posledn√≠ sync: ${lastSyncTime.toLocaleTimeString('cs-CZ')}` : ''}
                  >
                    {syncStatus === 'saving' ? '‚è≥ Ukl√°d√°m...' :
                     syncStatus === 'error' ? '‚ùå Chyba' :
                     '‚òÅÔ∏è Sync'}
                  </span>
                  <button
                    onClick={handleManualSync}
                    className="px-2 py-1 bg-amber-700 hover:bg-amber-600 rounded text-xs transition-colors"
                    title="Ulo≈æit teƒè"
                  >
                    üíæ
                  </button>
                  <button
                    onClick={disconnectFile}
                    className="px-2 py-1 bg-amber-700 hover:bg-amber-600 rounded text-xs transition-colors"
                    title="Odpojit soubor"
                  >
                    ‚úï
                  </button>
                </div>
              ) : (
                <button
                  type="button"
                  onClick={() => {
                    if (!isFileSystemSupported) {
                      alert('‚ö†Ô∏è Sync vy≈æaduje:\n\n1. St√°hnout HTML soubor\n2. Otev≈ô√≠t ho v Chrome nebo Edge\n\nV tomto prost≈ôed√≠ File System API nen√≠ dostupn√©.');
                      return;
                    }
                    connectToFile();
                  }}
                  className="px-3 py-1.5 bg-green-700 hover:bg-green-600 rounded text-sm font-medium transition-colors cursor-pointer"
                  title="P≈ôipojit soubor pro automatick√Ω sync (Google Drive, Dropbox...)"
                >
                  ‚òÅÔ∏è Sync
                </button>
              )}

              {/* Google Drive Sync */}
              {googleAccessToken ? (
                <div className="flex items-center gap-1">
                  <span
                    className={`text-xs px-2 py-1 rounded ${
                      googleSyncStatus === 'saving' ? 'bg-yellow-600 text-yellow-100' :
                      googleSyncStatus === 'error' ? 'bg-red-600 text-red-100' :
                      'bg-blue-700 text-blue-100'
                    }`}
                    title={googleLastSync ? `Slo≈æka: ${googleDriveFolderName || 'M≈Øj disk'}\nPosledn√≠ sync: ${googleLastSync.toLocaleTimeString('cs-CZ')}` : `Slo≈æka: ${googleDriveFolderName || 'M≈Øj disk'}`}
                  >
                    {googleSyncStatus === 'saving' ? '‚è≥ Ukl√°d√°m...' :
                     googleSyncStatus === 'error' ? '‚ùå Chyba' :
                     `üìÅ ${googleDriveFolderName || 'Drive'}`}
                  </span>
                  <button
                    onClick={handleGoogleDriveSync}
                    className="px-2 py-1 bg-blue-700 hover:bg-blue-600 rounded text-xs transition-colors"
                    title="Ulo≈æit do Google Drive"
                  >
                    üíæ
                  </button>
                  <button
                    onClick={disconnectGoogleDrive}
                    className="px-2 py-1 bg-blue-700 hover:bg-blue-600 rounded text-xs transition-colors"
                    title="Odpojit Google Drive"
                  >
                    ‚úï
                  </button>
                </div>
              ) : (
                <button
                  type="button"
                  onClick={connectGoogleDrive}
                  className="px-3 py-1.5 bg-blue-700 hover:bg-blue-600 rounded text-sm font-medium transition-colors cursor-pointer"
                  title="P≈ôipojit Google Drive"
                >
                  üìÅ Drive
                </button>
              )}

              <span className="text-amber-300/60 text-xs hidden md:block" title={`Save form√°t v${SAVE_VERSION}`}>
                v{SAVE_VERSION}
              </span>
              <button
                onClick={handleExport}
                className="px-3 py-1.5 bg-amber-700 hover:bg-amber-600 rounded text-sm font-medium transition-colors"
                title="Exportovat save (st√°hne JSON soubor)"
              >
                üì§
              </button>
              <label className="px-3 py-1.5 bg-amber-700 hover:bg-amber-600 rounded text-sm font-medium cursor-pointer transition-colors" title="Importovat save (nahr√°t JSON soubor)">
                üì•
                <input
                  type="file"
                  accept=".json"
                  onChange={handleImport}
                  className="hidden"
                />
              </label>
            </div>
          </div>
        </div>
      </header>

      {/* Navigation */}
      <nav className="bg-amber-800/90 backdrop-blur-sm shadow-lg sticky top-[76px] z-40">
        <div className="max-w-6xl mx-auto px-4">
          <div className="flex gap-1 overflow-x-auto py-2 scrollbar-hide">
            {panels.map(panel => (
              <button
                key={panel.id}
                onClick={() => setActivePanel(panel.id)}
                className={`px-4 py-2.5 rounded-lg font-bold transition-all duration-200 whitespace-nowrap flex items-center gap-2 ${
                  activePanel === panel.id
                    ? 'bg-amber-50 text-amber-900 shadow-lg'
                    : 'text-amber-100 hover:bg-amber-700'
                }`}
              >
                <span className="text-lg">{panel.icon}</span>
                <span className="hidden sm:inline">{panel.label}</span>
              </button>
            ))}
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-6xl mx-auto px-4 py-6">
        {activePanel === 'howto' && (
          <HowToPlayPanel />
        )}

        {activePanel === 'oracle' && (
          <OraclePanel onLogEntry={handleLogEntry} />
        )}
        
        {activePanel === 'studio' && (
          <ItemCardStudio 
            parties={parties}
            activePartyId={activePartyId}
            activeCharacterId={activeCharacterId}
            updateCharacterInParty={updateCharacterInParty}
          />
        )}
        
        {activePanel === 'combat' && (
          <CombatPanel 
            party={activeParty}
            updateCharacterInParty={(charId, updates) => 
              activePartyId && updateCharacterInParty(activePartyId, charId, updates)
            }
            onLogEntry={handleLogEntry}
          />
        )}
        
        {activePanel === 'character' && (
          <CharacterPanel 
            character={activeCharacter}
            updateCharacter={(updates) => 
              activePartyId && activeCharacterId && 
              updateCharacterInParty(activePartyId, activeCharacterId, updates)
            }
            party={activeParty}
            parties={parties}
            activePartyId={activePartyId}
            setActivePartyId={setActivePartyId}
            activeCharacterId={activeCharacterId}
            setActiveCharacterId={setActiveCharacterId}
            createParty={createParty}
            createPC={createPC}
            createHireling={createHireling}
            updateParty={updateParty}
            updateCharacterInParty={updateCharacterInParty}
            removeCharacter={removeCharacter}
            removeParty={removeParty}
            onLogEntry={handleLogEntry}
          />
        )}
        
        {activePanel === 'time' && (
          <TimePanel
            party={activeParty}
            updateParty={(updates) => activePartyId && updateParty(activePartyId, updates)}
            updateCharacterInParty={(charId, updates) => 
              activePartyId && updateCharacterInParty(activePartyId, charId, updates)
            }
            factions={factions}
            setFactions={setFactions}
            onLogEntry={handleLogEntry}
          />
        )}
        
        {activePanel === 'world' && (
          <WorldPanel 
            onLogEntry={handleLogEntry}
            settlements={settlements}
            setSettlements={setSettlements}
            worldNPCs={worldNPCs}
            setWorldNPCs={setWorldNPCs}
            parties={parties}
            activeParty={activeParty}
          />
        )}
        
        {activePanel === 'factions' && (
          <FactionPanel 
            factions={factions}
            setFactions={setFactions}
            onLogEntry={handleLogEntry}
          />
        )}
        
        {activePanel === 'journal' && (
          <JournalPanel 
            journal={journal}
            setJournal={setJournal}
            parties={parties}
            partyFilter={journalPartyFilter}
            setPartyFilter={setJournalPartyFilter}
            onExport={handleExport}
          />
        )}
      </main>

      {/* Footer */}
      <footer className="bg-amber-900 text-amber-200 text-center py-4 mt-8">
        <p className="text-sm">
          üê≠ Mausritter Solo Companion ‚Ä¢ Pro s√≥lo hr√°ƒçe Mausritter RPG
        </p>
      </footer>
    </div>
  );
}


// Render the app
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<MausritterSoloCompanion />);

  </script>
</body>
</html>